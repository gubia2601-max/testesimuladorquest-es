<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Quest√µes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F3F5F9;
  --panel:#FFFFFF;
  --panel-2:#F7F8FC;
  --text:#0B1220;
  --muted:#637189;
  --border:rgba(15,23,42,.12);
  --shadow:0 14px 40px rgba(2,8,23,.10);
  --shadow-light:0 8px 24px rgba(2,8,23,.06);
  --shadow-heavy:0 20px 60px rgba(2,8,23,.20);

  --brand:#1E3A8A;      /* azul */
  --brand-2:#2563EB;    /* azul */
  --brand-3:#22C55E;    /* verde */
  --brand-light:rgba(37,99,235,.10);

  --ok:#22C55E;
  --ok-light:rgba(34,197,94,.08);
  --warn:#F59E0B;
  --warn-light:rgba(245,158,11,.08);
  --bad:#EF4444;
  --bad-light:rgba(239,68,68,.08);

  --r-lg:18px;
  --r-md:14px;
  --r-sm:12px;
  --maxw: 1180px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* ===== Topbar ===== */
.topbar{
  height:64px;
  background: linear-gradient(180deg, #0B1220, #0f172a);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 8px 18px rgba(2,8,23,.18);
  position: sticky;
  top:0;
  z-index: 10;
}
.topbar-inner{
  width: min(var(--maxw), calc(100% - 24px));
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 14px;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 950;
  letter-spacing:.2px;
}
.brand .logo{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  background: rgba(37,99,235,.18);
  border: 1px solid rgba(255,255,255,.18);
  display:grid;
  place-items:center;
  font-weight: 950;
}
.nav{
  display:flex;
  align-items:center;
  gap:18px;
  color: rgba(255,255,255,.86);
  font-weight: 800;
  font-size: 13px;
}
.nav a{
  color: inherit;
  text-decoration:none;
  opacity:.9;
  padding: 6px 0;
  position: relative;
}
.nav a.active::after{
  content:"";
  position:absolute;
  bottom:-2px;
  left:0;
  right:0;
  height:2px;
  background: var(--brand-3);
  border-radius:2px;
}
.nav a:hover{ opacity: 1; }
.top-actions{
  display:flex;
  align-items:center;
  gap:10px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.14);
  font-weight: 900;
  font-size: 12px;
  white-space: nowrap;
}

/* ===== Layout ===== */
.wrap{
  width: min(var(--maxw), calc(100% - 24px));
  margin: 18px auto 40px auto;
  min-height: calc(100vh - 120px);
}
.hero-banner{
  height: 160px;
  border-radius: var(--r-lg);
  background:
    radial-gradient(900px 220px at 70% 30%, rgba(34,197,94,.25), transparent 55%),
    radial-gradient(900px 220px at 20% 10%, rgba(37,99,235,.25), transparent 55%),
    linear-gradient(90deg, #0f172a, #0b1220);
  position: relative;
  overflow:hidden;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  padding: 0 30px;
}
.hero-title{
  color:#fff;
  font-weight: 950;
  font-size: 28px;
  letter-spacing:.2px;
  margin:0;
}
.hero-sub{
  color: rgba(255,255,255,.78);
  font-size: 14px;
  font-weight: 600;
  margin-top: 8px;
  max-width: 700px;
}

/* ===== Cards / Sections ===== */
.section-title{
  margin: 18px 0 12px 0;
  font-size: 22px;
  font-weight: 950;
  letter-spacing:.2px;
}
.toolbar{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 14px 18px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  box-shadow: var(--shadow-light);
  margin: 20px 0;
}
.search{
  flex: 1 1 300px;
  display:flex;
  gap: 10px;
  align-items:center;
  position: relative;
}
.search input{
  width:100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline:none;
  font-weight: 700;
  font-size: 13px;
  background: #fff;
  transition: all .2s ease;
}
.search input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: 0 0 0 4px rgba(37,99,235,.14);
}
.search-icon{
  position:absolute;
  right:14px;
  color: var(--muted);
  pointer-events:none;
}
.btn{
  appearance:none;
  border: 1px solid var(--border);
  background: #fff;
  color: var(--text);
  border-radius: 12px;
  padding: 10px 16px;
  font-weight: 900;
  font-size: 13px;
  cursor:pointer;
  transition: all .2s ease;
  display:inline-flex;
  align-items:center;
  gap: 10px;
  white-space: nowrap;
  outline: none;
}
.btn:focus-visible{ box-shadow: 0 0 0 3px rgba(37,99,235,.25); }
.btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-light); }
.btn.primary{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  border-color: rgba(37,99,235,.35);
  color:#fff;
}
.btn.ghost{
  background: transparent;
  border-color: rgba(37,99,235,.28);
  color: var(--brand-2);
}
.btn.small{ padding: 6px 12px; font-size: 12px; }
.btn.danger{
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  border-color: rgba(220, 38, 38, 0.35);
  color: #fff;
}
.btn.danger:hover{ background: linear-gradient(135deg, #b91c1c, #991b1b); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none !important; box-shadow:none !important; }

/* ===== Grid de Cursos ===== */
.grid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin: 20px 0;
}
@media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
@media (max-width: 640px){ .grid{ grid-template-columns: 1fr;} }

.course-card{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  overflow:hidden;
  box-shadow: var(--shadow-light);
  cursor:pointer;
  transition:all .2s ease;
  min-height: 320px;
  display:flex;
  flex-direction: column;
  position: relative;
}
.course-card.selected{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(37,99,235,.15), var(--shadow);
}
.course-card:hover{
  transform: translateY(-4px);
  box-shadow: var(--shadow);
  border-color: rgba(37,99,235,.28);
}
.course-card .progress-ring{
  position:absolute;
  top: 15px;
  right: 15px;
  width: 50px;
  height: 50px;
  background: rgba(255,255,255,.92);
  border-radius: 50%;
  display:grid;
  place-items:center;
  font-weight: 900;
  font-size: 12px;
  color: var(--brand);
  border: 2px solid var(--border);
}
.thumb{
  height: 160px;
  background:
    radial-gradient(700px 240px at 60% 30%, rgba(37,99,235,.20), transparent 55%),
    linear-gradient(120deg, #0f172a, #0b1220);
  position: relative;
}
.thumb .label{
  position:absolute;
  left:12px;
  top:12px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight: 900;
  font-size: 11px;
  padding: 6px 10px;
  border-radius: 999px;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.course-body{
  padding: 18px;
  display:flex;
  flex-direction: column;
  gap: 10px;
  flex: 1 1 auto;
}
.course-name{
  font-weight: 950;
  font-size: 17px;
  margin:0;
  color: var(--brand-2);
}
.course-desc{
  margin:0;
  color: var(--muted);
  font-weight: 600;
  font-size: 13px;
  line-height: 1.4;
  flex: 1;
}
.course-meta{
  display:flex;
  gap: 12px;
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
}
.course-meta span{ display:flex; align-items:center; gap: 4px; }
.course-foot{
  margin-top:auto;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
}
.chip{
  font-size: 11px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--brand-light);
  border: 1px solid rgba(37,99,235,.22);
  color: var(--brand);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: .3px;
}

/* ===== Modais ===== */
.backdrop{
  position: fixed;
  inset: 0;
  background: rgba(2,8,23,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 14px;
  z-index: 999;
  animation: fadeIn .2s ease;
}
.backdrop.show{ display:flex; }
.modal{
  width: min(980px, 100%);
  background: #fff;
  border-radius: 20px;
  box-shadow: var(--shadow-heavy);
  overflow:hidden;
  border: 1px solid rgba(255,255,255,.18);
  animation: slideUp .3s ease;
}
.modal-head{
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(255,255,255,0));
}
.modal-head h2{ margin:0; font-size: 16px; font-weight: 950; }
.modal-body{ padding: 22px; }
.modal-foot{
  padding: 18px 22px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  background: #fff;
  position: relative;
  z-index: 10;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Campos de Formul√°rio ===== */
.fields{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}
.field{ display:flex; flex-direction: column; gap: 8px; }
.field.full{ grid-column: 1 / -1; }
.field label{
  font-size: 12px;
  font-weight: 900;
  color: var(--brand);
  text-transform: uppercase;
  letter-spacing: .5px;
}
.field input,.field select,.field textarea{
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline:none;
  font-weight: 600;
  font-size: 13px;
  background: #fff;
  transition: all .2s ease;
}
.field input:focus,.field select:focus,.field textarea:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: 0 0 0 4px rgba(37,99,235,.14);
}
.field .hint{ font-size: 11px; color: var(--muted); margin-top: 4px; }

/* Multi-select melhorado */
.select-multi{
  min-height: 120px;
  padding: 10px 12px;
}
.select-multi option{ padding: 6px 8px; }

/* ===== Wizard Steps ===== */
.steps{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 24px;
}
.step{
  flex: 1 1 auto;
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: #fff;
  transition: all .2s ease;
}
.step.active{
  border-color: rgba(37,99,235,.40);
  background: rgba(37,99,235,.04);
}
.step .dot{
  width: 32px;
  height: 32px;
  border-radius: 999px;
  display:grid;
  place-items:center;
  font-weight: 950;
  color:#fff;
  background: rgba(99,113,137,.35);
  transition: all .2s ease;
}
.step.active .dot{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  transform: scale(1.1);
}
.step .meta{ line-height: 1.2; }
.step .meta b{ font-size: 13px; font-weight: 950; }
.step .meta span{
  display:block;
  font-size: 11px;
  color: var(--muted);
  font-weight: 700;
  margin-top:2px;
}

/* ===== Cards de Modalidade ===== */
.mode-cards{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}
@media (max-width: 900px){ .mode-cards{ grid-template-columns: 1fr; } }
.mode{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 18px;
  background: #fff;
  cursor:pointer;
  transition:all .2s ease;
  display:flex;
  gap: 14px;
  align-items:flex-start;
}
.mode:hover{ transform: translateY(-2px); border-color: rgba(37,99,235,.30); box-shadow: var(--shadow); }
.mode.selected{
  border-color: var(--brand-2);
  background: rgba(37,99,235,.04);
  box-shadow: 0 16px 34px rgba(2,8,23,.10);
}
.mode .radio{
  width: 20px;
  height: 20px;
  border-radius: 999px;
  border: 2px solid rgba(99,113,137,.45);
  margin-top: 2px;
  position: relative;
  flex-shrink: 0;
}
.mode.selected .radio{ border-color: var(--brand-2); }
.mode.selected .radio::after{
  content:"";
  position:absolute;
  inset: 4px;
  border-radius: 999px;
  background: var(--brand-2);
  animation: fadeIn .2s ease;
}
.mode h3{ margin:0; font-size: 14px; font-weight: 950; color: var(--brand); }
.mode p{
  margin:8px 0 0 0;
  font-size: 12px;
  color: var(--muted);
  font-weight: 600;
  line-height: 1.4;
}
.muted{ color: var(--muted); font-weight: 600; font-size: 12px; line-height: 1.5; }

/* ===== Distribui√ß√£o por m√≥dulo ===== */
.dist-box{
  margin-top: 14px;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  background: var(--panel-2);
  padding: 14px;
}
.dist-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.dist-title{
  font-weight: 950;
  color: var(--brand);
  display:flex;
  align-items:center;
  gap: 10px;
}
.dist-controls{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}
.pill-mini{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.7);
  border: 1px solid var(--border);
  font-weight: 900;
  font-size: 12px;
}
.dist-table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  border-radius: 14px;
  border: 1px solid var(--border);
  background:#fff;
}
.dist-table th{
  text-align:left;
  padding: 10px 12px;
  background: rgba(37,99,235,.07);
  color: var(--brand);
  font-weight: 950;
  font-size: 11px;
  letter-spacing: .6px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}
.dist-table td{
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  font-weight: 700;
}
.dist-table tr:last-child td{ border-bottom: 0; }
.dist-input{
  width: 120px;
  max-width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline: none;
  font-weight: 900;
  text-align: right;
}
.dist-input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: 0 0 0 4px rgba(37,99,235,.14);
}
.dist-note{
  margin-top: 10px;
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
}
.kpi-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background:#fff;
  font-size: 12px;
  font-weight: 950;
}
.kpi-badge.ok{ border-color: rgba(34,197,94,.35); background: var(--ok-light); color: rgba(13,122,78,.95); }
.kpi-badge.bad{ border-color: rgba(239,68,68,.30); background: var(--bad-light); color: rgba(185,28,28,.95); }

/* ===== Quiz ===== */
.quiz-shell{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow);
  overflow:hidden;
  margin: 20px 0;
}
.quiz-top{
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  background: linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
}
.quiz-top .left{
  display:flex;
  align-items:center;
  gap: 16px;
  flex-wrap: wrap;
}
.q-counter{
  font-weight: 950;
  font-size: 18px;
  color: var(--brand);
  background: rgba(37,99,235,.1);
  padding: 6px 12px;
  border-radius: 10px;
}
.q-mini{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
  color: var(--muted);
  font-weight: 700;
  font-size: 13px;
}
.q-mini .sep{ opacity:.4; }
.progress{
  width: 100%;
  height: 10px;
  background: rgba(15,23,42,.08);
  border-radius: 999px;
  overflow:hidden;
  margin-top: 12px;
}
.progress > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand-3));
  border-radius: 999px;
  transition: width .3s ease;
}
.quiz-body{ padding: 24px 24px 16px 24px; background: #fff; }
.quiz-header{
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.quiz-header-left{
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}
.star-btn{
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 20px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
}
.star-btn:hover{ background: rgba(245, 158, 11, 0.1); color: var(--warn); }
.star-btn.active{ color: var(--warn); background: rgba(245, 158, 11, 0.15); }
.q-id{ color: var(--brand-2); font-weight: 950; font-size: 16px; }
.q-id .difficulty{
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(37,99,235,.10);
  border: 1px solid rgba(37,99,235,.20);
}
.quiz-header-right{ display: flex; align-items: center; gap: 8px; }
.q-text{
  margin: 0 0 20px 0;
  font-size: 15px;
  font-weight: 700;
  line-height: 1.6;
  color: rgba(11,18,32,.95);
  white-space: pre-wrap;
}

/* Explica√ß√£o */
.explanation-box{
  margin-top: 24px;
  padding: 20px;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--panel-2);
  display: none;
  animation: fadeIn 0.3s ease;
}
.explanation-box.show{ display: block; }
.explanation-title{
  font-size: 14px;
  font-weight: 950;
  color: var(--brand);
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.explanation-content{
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
  margin: 0;
}
.result-indicator{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  margin-left: 12px;
}
.result-indicator.correct{
  background: var(--ok-light);
  color: var(--ok);
  border: 1px solid rgba(34, 197, 94, 0.3);
}
.result-indicator.incorrect{
  background: var(--bad-light);
  color: var(--bad);
  border: 1px solid rgba(239, 68, 68, 0.3);
}

/* Op√ß√µes */
.opts{
  margin-top: 20px;
  display:flex;
  flex-direction: column;
  gap: 12px;
}
.opt{
  display:flex;
  gap: 16px;
  align-items:flex-start;
  padding: 18px;
  border-radius: 16px;
  border: 2px solid var(--border);
  background: var(--panel-2);
  cursor:pointer;
  transition:all .2s ease;
  position: relative;
  overflow: hidden;
}
.opt::before{
  content:"";
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width: 4px;
  background: transparent;
  transition: background .2s ease;
}
.opt:hover{ transform: translateY(-2px); border-color: rgba(37,99,235,.40); box-shadow: var(--shadow-light); }
.opt.selected{ border-color: rgba(37,99,235,.60); background: rgba(37,99,235,.04); }
.opt.correct{ border-color: var(--ok); background: var(--ok-light); }
.opt.correct::before{ background: var(--ok); }
.opt.wrong{ border-color: var(--bad); background: var(--bad-light); }
.opt.wrong::before{ background: var(--bad); }
.opt.excluded{
  opacity: 0.5;
  filter: blur(0.5px);
  text-decoration: line-through;
  border-color: rgba(99,113,137,.2);
  background: rgba(99,113,137,.05);
}
.opt.excluded:hover{ transform:none; box-shadow:none; cursor:not-allowed; }
.opt .radio{
  width: 20px;
  height: 20px;
  border-radius: 999px;
  border: 2px solid rgba(99,113,137,.50);
  margin-top: 2px;
  position: relative;
  flex: 0 0 auto;
  background:#fff;
  transition: all .2s ease;
}
.opt.selected .radio{ border-color: rgba(37,99,235,.80); }
.opt.selected .radio::after{
  content:"";
  position:absolute;
  inset: 4px;
  border-radius: 999px;
  background: rgba(37,99,235,.70);
  animation: fadeIn .2s ease;
}
.opt.correct .radio{ border-color: var(--ok); background: var(--ok); }
.opt.wrong .radio{ border-color: var(--bad); background: var(--bad); }
.opt .txt{
  font-size: 14px;
  font-weight: 600;
  color: rgba(11,18,32,.92);
  line-height: 1.5;
  white-space: pre-wrap;
  flex: 1;
}
.opt .letter{ font-weight: 900; color: var(--brand); margin-right: 8px; }
.opt .exclude-btn{
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  color: var(--muted);
  font-size: 18px;
  transition: all 0.2s ease;
  flex-shrink: 0;
  margin-left: 8px;
}
.opt .exclude-btn:hover{ color: var(--bad); background: rgba(239,68,68,.1); }
.opt.excluded .exclude-btn{ color: var(--bad); }
.opt.excluded .exclude-btn:hover{ color: var(--ok); background: rgba(34,197,94,.1); }

/* Quiz Footer */
.quiz-foot{
  padding: 24px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: #fff;
  position: relative;
}
.quiz-foot::before{
  content: "";
  position: absolute;
  top: 0;
  left: 24px;
  right: 24px;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
}
.navigation-buttons{
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  justify-content: center;
}
.finish-button{
  display: flex;
  align-items: center;
  gap: 12px;
  margin-left: auto;
}

/* Toast */
.toast{
  margin-top: 16px;
  padding: 14px 16px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(15,23,42,.03);
  color: rgba(11,18,32,.82);
  font-weight: 700;
  font-size: 13px;
  display:none;
  white-space: pre-wrap;
  line-height: 1.5;
  animation: fadeIn .3s ease;
}
.toast.show{ display:block; }
.toast.ok{ border-color: rgba(34,197,94,.35); background: var(--ok-light); color: rgba(13,122,78,.95); }
.toast.bad{ border-color: rgba(239,68,68,.30); background: var(--bad-light); color: rgba(185,28,28,.95); }
.toast.info{ border-color: rgba(37,99,235,.30); background: rgba(37,99,235,.08); color: var(--brand); }

/* ===== Views ===== */
.view{ display:none; }
.view.show{ display:block; }

/* ===== Loading ===== */
.loading{
  display:grid;
  place-items:center;
  padding: 40px;
  color: var(--muted);
}
.loading::after{
  content:"";
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--brand-2);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Error ===== */
.error-card{
  background: var(--bad-light);
  border: 1px solid var(--bad);
  border-radius: var(--r-lg);
  padding: 30px;
  text-align:center;
  margin: 20px 0;
}
.error-title{
  color: var(--bad);
  font-weight: 950;
  font-size: 18px;
  margin: 0 0 10px 0;
}

/* ===== Tabs ===== */
.tabs{
  display:flex;
  gap: 2px;
  background: var(--panel-2);
  border-radius: 12px;
  padding: 4px;
  margin: 20px 0;
}
.tab{
  flex: 1;
  padding: 12px 16px;
  text-align:center;
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
  cursor:pointer;
  border-radius: 8px;
  transition: all .2s ease;
}
.tab:hover{ background: rgba(37,99,235,.05); }
.tab.active{
  background: white;
  color: var(--brand);
  box-shadow: var(--shadow-light);
}

/* ===== Table ===== */
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin: 20px 0;
}
.table th{
  text-align:left;
  padding: 12px 16px;
  background: var(--panel-2);
  color: var(--brand);
  font-weight: 900;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border);
}
.table td{
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  font-weight: 600;
}
.table tr:hover{ background: rgba(37,99,235,.03); }
.badge{
  display:inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.badge.correct{
  background: var(--ok-light);
  color: var(--ok);
  border: 1px solid rgba(34,197,94,.3);
}
.badge.incorrect{
  background: var(--bad-light);
  color: var(--bad);
  border: 1px solid rgba(239,68,68,.3);
}
.badge.pending{
  background: var(--warn-light);
  color: var(--warn);
  border: 1px solid rgba(245,158,11,.3);
}

/* ===== Export Panel ===== */
.export-panel{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 24px;
  margin: 20px 0;
  box-shadow: var(--shadow-light);
}
.export-options{
  display:flex;
  gap: 12px;
  flex-wrap:wrap;
  margin-top: 16px;
}

/* ===== Manuals ===== */
.manual-wrap{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-light);
  overflow:hidden;
  margin: 20px 0;
}
.manual-head{
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.manual-title{
  font-weight: 950;
  color: var(--brand);
}
.manual-iframe{
  width: 100%;
  height: min(72vh, 860px);
  border: 0;
  background: #fff;
}

/* ===== Login "cara de login" ===== */
.login-shell{
  width: min(980px, calc(100% - 24px));
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap: 16px;
  align-items: stretch;
}
@media (max-width: 900px){
  .login-shell{ grid-template-columns: 1fr; }
}
.login-left{
  border-radius: 22px;
  padding: 26px;
  background:
    radial-gradient(900px 260px at 20% 10%, rgba(34,197,94,.25), transparent 55%),
    radial-gradient(900px 260px at 70% 30%, rgba(37,99,235,.25), transparent 55%),
    linear-gradient(90deg, #0f172a, #0b1220);
  color:#fff;
  box-shadow: var(--shadow-heavy);
  border: 1px solid rgba(255,255,255,.10);
  display:flex;
  flex-direction: column;
  justify-content: center;
}
.login-left h1{
  margin: 0;
  font-size: 28px;
  font-weight: 950;
  letter-spacing: .2px;
}
.login-left p{
  margin: 10px 0 0 0;
  color: rgba(255,255,255,.8);
  font-weight: 650;
  line-height: 1.5;
}
.login-right{
  border-radius: 22px;
  background: #fff;
  box-shadow: var(--shadow-heavy);
  border: 1px solid rgba(255,255,255,.18);
  overflow:hidden;
}
.login-right .head{
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(255,255,255,0));
}
.login-right .head b{ font-size: 16px; font-weight: 950; color: var(--brand); }
.login-right .body{ padding: 22px; }
.login-right .foot{
  padding: 18px 22px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

/* ===== Responsividade ===== */
@media (max-width: 768px){
  .topbar-inner{ flex-wrap: wrap; height: auto; padding: 10px 0; }
  .nav{ order: 3; width: 100%; justify-content: center; margin-top: 10px; gap: 12px; }
  .hero-banner{ padding: 20px; height: auto; min-height: 140px; }
  .hero-title{ font-size: 22px; }
  .quiz-foot{ flex-direction: column; gap: 16px; }
  .navigation-buttons,.finish-button{ width: 100%; justify-content: center; }
  .finish-button{ margin-left: 0; }
  .btn{ flex: 1; min-width: 0; justify-content: center; }
  .opt{ padding: 14px; }
  .fields{ grid-template-columns: 1fr; }
  .quiz-header{ flex-direction: column; align-items: flex-start; gap: 12px; }
  .quiz-header-right{ align-self: flex-end; }
}
@media (max-width: 480px){
  .mode-cards{ grid-template-columns: 1fr; }
  .steps{ flex-wrap: wrap; }
  .step{ flex: 1 0 100%; }
  .q-counter{ font-size: 16px; }
  .q-text{ font-size: 14px; }
  .quiz-body{ padding: 16px; }
  .quiz-foot{ padding: 16px; }
}

/* ===== Wizard com rolagem interna e footer sempre vis√≠vel ===== */
#wizardBackdrop .modal{
  display:flex;
  flex-direction:column;
  max-height: 90vh;
}

#wizardBackdrop .modal-head{
  flex: 0 0 auto;
}

#wizardBackdrop .modal-body{
  flex: 1 1 auto;
  overflow: auto;
  max-height: calc(90vh - 160px); /* margem segura p/ head+foot */
  padding-bottom: 10px;
}

#wizardBackdrop .modal-foot{
  flex: 0 0 auto;
  position: sticky;
  bottom: 0;
  background: #fff;
  z-index: 50;
}

/* ===== Checklist (m√≥dulos/cap√≠tulos) ===== */
.checklist{
  border: 1px solid var(--border);
  border-radius: 14px;
  background:#fff;
  padding: 10px;
  max-height: 220px;
  overflow: auto;
}

.chk-item{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding: 8px 8px;
  border-radius: 12px;
  cursor:pointer;
}

.chk-item:hover{ background: rgba(37,99,235,.05); }
.chk-item input{ margin-top: 3px; }
.chk-item b{ font-size: 13px; }
.chk-item small{
  display:block;
  margin-top: 2px;
  color: var(--muted);
  font-weight: 650;
  font-size: 11px;
}

/* ===== Layout Quiz + Navegador de Quest√µes (estilo T2) ===== */
.quiz-layout{
  display:grid;
  grid-template-columns: 280px 1fr;
  gap: 16px;
  align-items:start;
}

@media (max-width: 980px){
  .quiz-layout{ grid-template-columns: 1fr; }
  .qnav{ order: 2; }
}

.qnav{
  position: sticky;
  top: 84px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-light);
  overflow:hidden;
}

.qnav-head{
  padding: 14px 14px 10px 14px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
}

.qnav-title{
  font-weight: 950;
  color: var(--brand);
}

.qnav-meta{
  margin-top: 6px;
  color: var(--muted);
  font-weight: 750;
  font-size: 12px;
}

.qnav-grid{
  padding: 12px;
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  max-height: calc(100vh - 260px);
  overflow:auto;
}

.qnav-btn{
  border: 1px solid var(--border);
  background: #fff;
  border-radius: 10px;
  padding: 8px 0;
  font-weight: 950;
  font-size: 12px;
  cursor:pointer;
  transition: all .15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.qnav-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-light); }

.qnav-btn.current{
  border-color: rgba(37,99,235,.70);
  box-shadow: 0 0 0 3px rgba(37,99,235,.15);
}

.qnav-btn.answered{ background: rgba(37,99,235,.06); }
.qnav-btn.pending{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25); }
.qnav-btn.correct{ background: var(--ok-light); border-color: rgba(34,197,94,.35); }
.qnav-btn.wrong{ background: var(--bad-light); border-color: rgba(239,68,68,.30); }
.qnav-btn.blank{ background: rgba(99,113,137,.05); border-color: rgba(99,113,137,.15); opacity: 0.7; }

.qnav-legend{
  padding: 12px 14px 14px 14px;
  border-top: 1px solid var(--border);
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
}

.qnav-legend .leg{
  font-size: 11px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background:#fff;
}

.qnav-legend .answered{ background: rgba(37,99,235,.06); }
.qnav-legend .pending{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25); }
.qnav-legend .correct{ background: var(--ok-light); border-color: rgba(34,197,94,.35); }
.qnav-legend .wrong{ background: var(--bad-light); border-color: rgba(239,68,68,.30); }
.qnav-legend .blank{ background: rgba(99,113,137,.05); border-color: rgba(99,113,137,.15); }

/* Melhoria: Checklist com scroll suave */
.checklist::-webkit-scrollbar {
  width: 6px;
}
.checklist::-webkit-scrollbar-track {
  background: var(--panel-2);
  border-radius: 10px;
}
.checklist::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 10px;
}
.checklist::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}

/* Melhoria: Tooltip para quest√µes no mapa */
.qnav-btn[title] {
  position: relative;
}
.qnav-btn[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  white-space: nowrap;
  z-index: 100;
  margin-bottom: 5px;
}

/* Melhoria: Indicador de tempo restante cr√≠tico */
.timer-critical {
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">Q</div>
      Simulador
    </div>
    <nav class="nav">
      <a href="#" id="navHome" class="active">Dashboard</a>
      <a href="#" id="navQuiz">Simulado</a>
      <a href="#" id="navHistory">Hist√≥rico</a>
      <a href="#" id="navStats">Estat√≠sticas</a>
      <a href="#" id="navManuals">Manuais</a>
    </nav>
    <div class="top-actions">
      <div class="pill" id="pillUser">‚Äî</div>
      <button class="btn ghost small" id="btnLogout" type="button">Sair</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section class="view show" id="viewHome">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Simulador de Certifica√ß√µes</h1>
        <div class="hero-sub">Prepare-se com quest√µes e simulados personalizados. Escolha um curso e configure do seu jeito.</div>
      </div>
    </div>

    <h2 class="section-title">Certifica√ß√µes Dispon√≠veis <span class="muted" id="certCount">(0)</span></h2>

    <div class="toolbar">
      <div class="search">
        <input id="searchCourses" type="text" placeholder="Buscar certifica√ß√£o..." />
        <div class="search-icon">üîç</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnBookmarks" type="button" disabled>‚≠ê Favoritos</button>
        <button class="btn primary" id="btnOpenWizard" type="button" disabled>Configurar Simulado</button>
      </div>
    </div>

    <div class="grid" id="coursesGrid"></div>

    <div class="muted" style="margin-top:30px; padding:20px; background:var(--panel-2); border-radius:var(--r-lg); border:1px solid var(--border);">
      üí° <b>Dica:</b> Este simulador salva progresso e estat√≠sticas localmente no navegador.
    </div>
  </section>

  <!-- QUIZ -->
  <section class="view" id="viewQuiz">
    <div class="quiz-layout">
      <aside class="qnav">
        <div class="qnav-head">
          <div class="qnav-title">Quest√µes</div>
          <div class="qnav-meta" id="qnavMeta">‚Äî</div>
        </div>
        <div class="qnav-grid" id="qnavGrid"></div>
        <div class="qnav-legend">
          <span class="leg answered">Respondida</span>
          <span class="leg correct">Acertou</span>
          <span class="leg wrong">Errou</span>
          <span class="leg pending">Pendente</span>
          <span class="leg blank">Branco</span>
        </div>
      </aside>

      <div class="quiz-shell">
        <div class="quiz-top">
          <div class="left">
            <div class="q-counter" id="qCounter">1/0</div>
            <div class="q-mini">
              <span id="qTimer">00:00</span><span class="sep">‚Ä¢</span>
              <span id="qCourseName">‚Äî</span><span class="sep">‚Ä¢</span>
              <span id="qMeta">‚Äî</span>
              <span id="qLimitPill" class="kpi-badge" style="display:none;">‚è≥ 03:00:00</span>
            </div>
          </div>
          <div class="progress"><div id="progressBar"></div></div>
        </div>

        <div class="quiz-body">
          <div class="quiz-header">
            <div class="quiz-header-left">
              <button class="star-btn" id="btnStar" type="button" title="Marcar para revis√£o">‚òÜ</button>
              <div class="q-id">
                <span id="qId">#‚Äî</span>
                <span class="difficulty" id="qDifficulty">‚Äî</span>
              </div>
            </div>
            <div class="quiz-header-right">
              <div class="q-mini" id="qStatus"></div>
            </div>
          </div>

          <p class="q-text" id="qText">‚Äî</p>
          <div class="opts" id="qOptions"></div>

          <div class="explanation-box" id="explanationBox">
            <h3 class="explanation-title">Explica√ß√£o</h3>
            <p class="explanation-content" id="explanationText"></p>
          </div>
        </div>

        <div class="quiz-foot">
          <div class="navigation-buttons">
            <button class="btn" id="btnPrev" type="button">‚Üê Anterior</button>
            <button class="btn primary" id="btnCorrect" type="button" disabled>‚úì Corrigir</button>
            <button class="btn" id="btnNext" type="button">Pr√≥xima ‚Üí</button>
          </div>
          <div class="finish-button">
            <button class="btn danger" id="btnFinish" type="button">Finalizar Simulado</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section class="view" id="viewHistory">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Hist√≥rico de Simulados</h1>
        <div class="hero-sub">Acompanhe seu progresso e revise quest√µes j√° respondidas.</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="history">Simulados Completos</div>
      <div class="tab" data-tab="bookmarks">Quest√µes Marcadas</div>
      <div class="tab" data-tab="wrong">Erros para Revisar</div>
    </div>

    <div id="historyContent"></div>
  </section>

  <!-- ESTAT√çSTICAS -->
  <section class="view" id="viewStats">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Dashboard de Desempenho</h1>
        <div class="hero-sub">Analise seu progresso e identifique √°reas para melhorar com indicadores.</div>
      </div>
    </div>

    <div class="export-panel">
      <h3 style="margin:0 0 10px 0; font-size:16px; font-weight:950;">Exportar Dados</h3>
      <div class="muted">Exporte seu hist√≥rico para an√°lise externa ou backup.</div>
      <div class="export-options">
        <button class="btn ghost" id="btnExportCSV" type="button">üìä Exportar CSV</button>
        <button class="btn ghost" id="btnExportJSON" type="button">üìù Exportar JSON</button>
        <button class="btn ghost" id="btnExportPDF" type="button" disabled>üìÑ Exportar PDF (em breve)</button>
      </div>
    </div>
  </section>

  <!-- MANUAIS -->
  <section class="view" id="viewManuals">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Manuais</h1>
        <div class="hero-sub">Acesse materiais oficiais (ex.: Guia Por Dentro da B3).</div>
      </div>
    </div>

    <div class="manual-wrap">
      <div class="manual-head">
        <div>
          <div class="manual-title">üìò GUIA POR DENTRO DA B3 (2024)</div>
          <div class="muted">Visualize no navegador ou abra em uma nova aba.</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn ghost" id="btnOpenManualNewTab" href="#" target="_blank" rel="noopener">üîó Abrir em nova aba</a>
          <a class="btn primary" id="btnDownloadManual" href="#" download>‚¨áÔ∏è Baixar PDF</a>
        </div>
      </div>
      <iframe class="manual-iframe" id="manualIframe" title="Manual B3"></iframe>
    </div>
  </section>
</main>

<!-- LOGIN (tela) -->
<div class="backdrop show" id="loginBackdrop" aria-hidden="false">
  <div class="login-shell" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="login-left">
      <h1>Bem-vindo üëã</h1>
      <p>Entre para acessar simulados personalizados, hist√≥rico e quest√µes marcadas.</p>
      <p style="margin-top:14px; font-size:12px; opacity:.85;">
        üîê Seus dados ficam apenas neste navegador (modo local).
      </p>
    </div>
    <div class="login-right">
      <div class="head">
        <b id="loginTitle">Login</b>
        <div class="muted">Acesso local para iniciar</div>
      </div>
      <div class="body">
        <div class="fields" style="grid-template-columns: 1fr;">
          <div class="field">
            <label for="loginUser">Usu√°rio</label>
            <input id="loginUser" type="text" placeholder="Ex.: Gustavo" autocomplete="username" />
          </div>
          <div class="field">
            <label for="loginPass">Senha</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand); text-transform:none; letter-spacing:0;">
              <input type="checkbox" id="rememberMe" checked />
              Lembrar de mim neste dispositivo
            </label>
            <div class="hint">Primeiro acesso? Qualquer usu√°rio/senha funciona.</div>
          </div>
        </div>
        <div class="toast show info" id="loginMsg">
          ‚ö° <b>Dica:</b> depois de escolher o curso, a configura√ß√£o abre automaticamente.
        </div>
      </div>
      <div class="foot">
        <div class="muted" id="loginInfo">Acesso local ‚Ä¢ sem servidor</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WIZARD MODAL -->
<div class="backdrop" id="wizardBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
    <div class="modal-head">
      <div>
        <h2 id="wizTitle">Configurar Simulado</h2>
        <div class="muted" id="wizSub">Personalize seu simulado em 4 passos</div>
      </div>
      <button class="btn ghost small" id="btnCloseWizard" type="button" aria-label="Fechar">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="steps">
        <div class="step active" id="step1">
          <div class="dot">1</div>
          <div class="meta"><b>Modalidade</b><span>Tipo de simulado</span></div>
        </div>
        <div class="step" id="step2">
          <div class="dot">2</div>
          <div class="meta"><b>Estrat√©gia</b><span>Como quer estudar</span></div>
        </div>
        <div class="step" id="step3">
          <div class="dot">3</div>
          <div class="meta"><b>Filtros</b><span>M√≥dulos, cap√≠tulos, etc.</span></div>
        </div>
        <div class="step" id="step4">
          <div class="dot">4</div>
          <div class="meta"><b>Revis√£o</b><span>Confirmar e iniciar</span></div>
        </div>
      </div>

      <!-- PAGE 1 -->
      <div class="wiz-page" id="wizPage1">
        <div class="muted" style="margin-bottom:16px;">
          Curso selecionado: <b id="wizCourseName" style="color:var(--brand);">‚Äî</b>
        </div>
        <div class="mode-cards">
          <div class="mode selected" data-mode="quick">
            <div class="radio"></div>
            <div>
              <h3>Simulado R√°pido</h3>
              <p>10 quest√µes aleat√≥rias para aquecer.</p>
            </div>
          </div>
          <div class="mode" data-mode="custom">
            <div class="radio"></div>
            <div>
              <h3>Personalizado</h3>
              <p>Configure filtros e quantidade.</p>
            </div>
          </div>
          <div class="mode" data-mode="exam">
            <div class="radio"></div>
            <div>
              <h3>Modo Prova</h3>
              <p>60 quest√µes com limite de 3h (opcional).</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div class="wiz-page" id="wizPage2" style="display:none;">
        <div class="muted" style="margin-bottom:16px;">Escolha como quer estudar:</div>
        <div class="mode-cards">
          <div class="mode selected" data-study="module">
            <div class="radio"></div>
            <div>
              <h3>Por M√≥dulo</h3>
              <p>Use m√≥dulos/cap√≠tulos para direcionar.</p>
            </div>
          </div>
          <div class="mode" data-study="weakness">
            <div class="radio"></div>
            <div>
              <h3>Por Fraquezas</h3>
              <p>Foco nos temas com menor acerto hist√≥rico.</p>
            </div>
          </div>
          <div class="mode" data-study="mixed">
            <div class="radio"></div>
            <div>
              <h3>Misturado</h3>
              <p>Todos os temas misturados para revis√£o geral.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE 3 -->
      <div class="wiz-page" id="wizPage3" style="display:none;">
        <div class="fields">
          <div class="field">
            <label>M√≥dulos</label>
            <div class="checklist" id="listModule"></div>
            <div class="hint">Marque um ou mais m√≥dulos (sem Ctrl/‚åò).</div>
          </div>
          <div class="field">
            <label>Cap√≠tulos</label>
            <div class="checklist" id="listChapter"></div>
            <div class="hint">Se nenhum cap√≠tulo for marcado, considera todos.</div>
          </div>
          <div class="field">
            <label for="selTheme">Tema</label>
            <select id="selTheme"></select>
          </div>
          <div class="field">
            <label for="selLevel">Dificuldade</label>
            <select id="selLevel"></select>
          </div>

          <div class="field">
            <label for="selQty">Quantidade</label>
            <select id="selQty">
              <option value="5">5 quest√µes (r√°pido)</option>
              <option value="10" selected>10 quest√µes</option>
              <option value="20">20 quest√µes</option>
              <option value="30">30 quest√µes</option>
              <option value="40">40 quest√µes</option>
              <option value="50">50 quest√µes</option>
              <option value="60">60 quest√µes (prova completa)</option>
            </select>
          </div>

          <div class="field">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand); text-transform:none; letter-spacing:0;">
              <input id="chkOfficialDuration" type="checkbox" />
              Dura√ß√£o oficial da prova? <span class="muted">(3h)</span>
            </label>
            <div class="hint">Se marcado, ao atingir 03:00:00 o simulado encerra automaticamente</div>
          </div>

          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand); text-transform:none; letter-spacing:0;">
              <input id="chkNoRepeat" type="checkbox" checked />
              Evitar quest√µes j√° respondidas
            </label>
            <div class="hint">Remove quest√µes que voc√™ j√° acertou anteriormente</div>
          </div>

          <div class="field full">
            <label for="searchText">Busca por texto</label>
            <input id="searchText" type="text" placeholder="Ex.: CCP, nova√ß√£o, margem, op√ß√µes..." />
            <div class="hint">Busca no texto da quest√£o e alternativas</div>
          </div>

          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand); text-transform:none; letter-spacing:0;">
              <input id="chkDistEnable" type="checkbox" />
              Distribuir quest√µes por m√≥dulo (opcional)
            </label>
            <div class="hint">Defina quantidade ou percentual por m√≥dulo (substitui "Quantidade" como distribui√ß√£o)</div>
          </div>
        </div>

        <div class="dist-box" id="distBox" style="display:none;">
          <div class="dist-head">
            <div class="dist-title">üìå Distribui√ß√£o por m√≥dulo</div>
            <div class="dist-controls">
              <span class="pill-mini">
                <input type="radio" name="distMode" id="distModeQty" checked />
                <label for="distModeQty" style="cursor:pointer;">Quantidade</label>
              </span>
              <span class="pill-mini">
                <input type="radio" name="distMode" id="distModePct" />
                <label for="distModePct" style="cursor:pointer;">Percentual</label>
              </span>
              <span id="distSumBadge" class="kpi-badge">‚Äî</span>
            </div>
          </div>

          <table class="dist-table">
            <thead>
              <tr>
                <th>M√≥dulo</th>
                <th style="width:160px;" id="distColTitle">Quantidade</th>
              </tr>
            </thead>
            <tbody id="distRows"></tbody>
          </table>

          <div class="dist-note" id="distNote">Informe a distribui√ß√£o. Se algum m√≥dulo ficar em branco, ele recebe 0.</div>
        </div>

        <div class="toast show info" id="filterInfo" style="margin-top:16px;">‚Äî</div>
      </div>

      <!-- PAGE 4 -->
      <div class="wiz-page" id="wizPage4" style="display:none;">
        <div class="muted" style="margin-bottom:16px;">Confira as configura√ß√µes do seu simulado:</div>
        <div class="manual-wrap" style="padding:18px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:20px;">
            <div>
              <h3 style="margin:0 0 8px 0; color:var(--brand);" id="confirmTitle">Simulado</h3>
              <div class="muted" id="confirmDetails">‚Äî</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:32px; font-weight:950; color:var(--brand-2);" id="confirmQty">0</div>
              <div class="muted">quest√µes</div>
            </div>
          </div>
          <div style="margin-top:14px; padding-top:14px; border-top:1px solid var(--border);">
            <div class="muted" style="margin-bottom:8px;">Configura√ß√µes aplicadas:</div>
            <div id="confirmFilters" style="font-size:13px; font-weight:650; line-height:1.6;"></div>
          </div>
        </div>
        <div class="toast show info" style="margin-top:16px;">‚≠ê Voc√™ pode marcar quest√µes para revisar depois.</div>
      </div>
    </div>

    <div class="modal-foot">
      <div class="muted" id="wizFooter">Selecione um curso para come√ßar</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnPrevStep" type="button" disabled>‚Üê Voltar</button>
        <button class="btn primary" id="btnNextStep" type="button">Continuar ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE RESULTADOS -->
<div class="backdrop" id="resultsBackdrop" aria-hidden="true">
  <div class="modal" style="max-width:900px;" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
    <div class="modal-head">
      <h2 id="resultsTitle">Resultado do Simulado</h2>
      <button class="btn ghost small" id="btnCloseResults" type="button" aria-label="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="resultsContent"></div>
    </div>
    <div class="modal-foot">
      <div class="muted" id="resultsFooter">Tempo total: 00:00</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnReviewWrong" type="button">üìù Revisar Erros</button>
        <button class="btn ghost" id="btnExportResult" type="button">üìä Exportar</button>
        <button class="btn primary" id="btnNewSimulado" type="button">üîÑ Novo Simulado</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST GLOBAL -->
<div id="globalToast" style="
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  z-index: 2000;
  width: min(720px, calc(100% - 24px));
  display: none;
">
  <div id="globalToastInner" class="toast show info" style="display:block; margin:0;"></div>
</div>

<script>
;(() => {
  'use strict';

  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelectorAll(sel);

  const LS_AUTH = "sim_auth_v3";
  const LS_HIST = "sim_hist_v3";
  const LS_SESS = "sim_sess_v3";
  const LS_BOOK = "sim_book_v3";
  const LS_STATS = "sim_stats_v3";
  const LS_EXCLUDED = "sim_excluded_v1";

  /* =========================================================
     Configura√ß√£o Inicial
  ========================================================= */
  const MANUAL_PDF = "./GUIA_POR_DENTRO_DA_B3_2024_final-min%201.pdf";

  const courses = [
    {
      id: "PQO",
      name: "PQO - Programa de Qualifica√ß√£o Operacional",
      desc: "Preparat√≥rio completo para a certifica√ß√£o PQO com quest√µes atualizadas do mercado financeiro.",
      jsonUrl: "./QuestoesPQO.json",
      tag: "Mais Popular",
      color: "#2563EB",
      icon: "üìà",
      stats: { questions: 0, modules: 0, avgTime: 0 }
    },
    {
      id: "CPA20",
      name: "CPA-20",
      desc: "Certifica√ß√£o Profissional ANBIMA - S√©rie 20. Prepara√ß√£o completa para o exame.",
      jsonUrl: "./QuestoesCPA20.json",
      tag: "Em Breve",
      color: "#22C55E",
      icon: "üè¶",
      stats: { questions: 0, modules: 0, avgTime: 0 }
    },
    {
      id: "CEA",
      name: "CEA - Certifica√ß√£o de Especialista",
      desc: "Certifica√ß√£o para profissionais de investimentos e assessoria financeira.",
      jsonUrl: "./QuestoesCEA.json",
      tag: "Em Breve",
      color: "#16A34A",
      icon: "‚≠ê",
      stats: { questions: 0, modules: 0, avgTime: 0 }
    }
  ];

  let selectedCourse = null;
  let currentUser = null;

  /* =========================================================
     Sistema de Autentica√ß√£o
  ========================================================= */
  class AuthManager {
    static getAuth() {
      try {
        let auth = JSON.parse(localStorage.getItem(LS_AUTH) || "null");
        if (!auth) auth = JSON.parse(sessionStorage.getItem(LS_AUTH) || "null");
        if (auth && Date.now() - auth.at < 30 * 24 * 60 * 60 * 1000) return auth;
      } catch {}
      return null;
    }

    static setAuth(user, remember = true) {
      const auth = {
        user,
        at: Date.now(),
        session: Date.now().toString(36) + Math.random().toString(36).substr(2)
      };
      if (remember) localStorage.setItem(LS_AUTH, JSON.stringify(auth));
      else sessionStorage.setItem(LS_AUTH, JSON.stringify(auth));
      return auth;
    }

    static clearAuth() {
      localStorage.removeItem(LS_AUTH);
      sessionStorage.removeItem(LS_AUTH);
    }

    static requireLogin() {
      const auth = AuthManager.getAuth();
      if (auth?.user) {
        currentUser = auth.user;
        $("loginBackdrop").classList.remove("show");
        $("loginBackdrop").setAttribute("aria-hidden", "true");
        $("pillUser").textContent = auth.user;
        return true;
      }
      $("loginBackdrop").classList.add("show");
      $("loginBackdrop").setAttribute("aria-hidden", "false");
      $("pillUser").textContent = "‚Äî";
      return false;
    }
  }

  /* =========================================================
     Sistema de Hist√≥rico e Estat√≠sticas
  ========================================================= */
  class StatsManager {
    static getHistory() {
      try { return JSON.parse(localStorage.getItem(LS_HIST) || "[]"); }
      catch { return []; }
    }

    static addSession(session) {
      const history = StatsManager.getHistory();
      history.unshift({
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        ...session,
        completedAt: Date.now()
      });
      if (history.length > 50) history.length = 50;
      localStorage.setItem(LS_HIST, JSON.stringify(history));
      return history;
    }

    static getQuestionStats() {
      try { return JSON.parse(localStorage.getItem(LS_STATS) || "{}"); }
      catch { return {}; }
    }

    static updateQuestionStats(questionId, correct, timeSpent = 0) {
      const stats = StatsManager.getQuestionStats();
      if (!stats[questionId]) {
        stats[questionId] = { attempts: 0, correct: 0, totalTime: 0, lastAttempt: Date.now() };
      }
      stats[questionId].attempts++;
      stats[questionId].totalTime += timeSpent;
      stats[questionId].lastAttempt = Date.now();
      if (correct) stats[questionId].correct++;
      localStorage.setItem(LS_STATS, JSON.stringify(stats));
      return stats[questionId];
    }

    static getWeakAreas(limit = 5) {
      const stats = StatsManager.getQuestionStats();
      const areas = {};
      Object.entries(stats).forEach(([id, data]) => {
        const parts = id.split('-');
        const area = parts.slice(0, 3).join('-');
        if (!areas[area]) areas[area] = { attempts: 0, correct: 0 };
        areas[area].attempts += data.attempts;
        areas[area].correct += data.correct;
      });
      return Object.entries(areas)
        .map(([area, data]) => ({
          area,
          accuracy: data.attempts > 0 ? (data.correct / data.attempts) * 100 : 0,
          attempts: data.attempts
        }))
        .sort((a, b) => a.accuracy - b.accuracy)
        .slice(0, limit);
    }
  }

  /* =========================================================
     Sistema de Bookmarks
  ========================================================= */
  class BookmarkManager {
    static getBookmarks() {
      try { return JSON.parse(localStorage.getItem(LS_BOOK) || "[]"); }
      catch { return []; }
    }

    static toggleBookmark(questionId) {
      const bookmarks = BookmarkManager.getBookmarks();
      const index = bookmarks.indexOf(questionId);
      if (index === -1) bookmarks.push(questionId);
      else bookmarks.splice(index, 1);
      localStorage.setItem(LS_BOOK, JSON.stringify(bookmarks));
      return index === -1;
    }

    static isBookmarked(questionId) {
      const bookmarks = BookmarkManager.getBookmarks();
      return bookmarks.includes(questionId);
    }
  }

  /* =========================================================
     Sistema de Exclus√£o de Alternativas
  ========================================================= */
  class ExclusionManager {
    static getExclusions() {
      try { return JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}"); }
      catch { return {}; }
    }

    static toggleExclusion(questionId, optionLetter) {
      const exclusions = ExclusionManager.getExclusions();
      if (!exclusions[questionId]) exclusions[questionId] = [];
      const index = exclusions[questionId].indexOf(optionLetter);
      if (index === -1) exclusions[questionId].push(optionLetter);
      else exclusions[questionId].splice(index, 1);
      localStorage.setItem(LS_EXCLUDED, JSON.stringify(exclusions));
      return index === -1;
    }

    static getExcludedOptions(questionId) {
      const exclusions = ExclusionManager.getExclusions();
      return exclusions[questionId] || [];
    }
  }

  /* =========================================================
     Sistema de Sess√£o Ativa
  ========================================================= */
  class SessionManager {
    static saveSession(session) { localStorage.setItem(LS_SESS, JSON.stringify(session)); }
    static getSession() {
      try {
        const session = JSON.parse(localStorage.getItem(LS_SESS) || "null");
        if (session && Date.now() - session.startedAt < 24 * 60 * 60 * 1000) return session;
      } catch {}
      return null;
    }
    static clearSession() { localStorage.removeItem(LS_SESS); }
  }

  /* =========================================================
     Banco de Quest√µes
  ========================================================= */
  const db = { all: [], modules: [], chapters: [], themes: [], levels: [] };

  async function loadCourseDb(course) {
    const res = await fetch(course.jsonUrl, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("Formato inv√°lido: esperado array");

    const questions = data.map((q, index) => {
      const id = String(q.id || `Q${index + 1}`).trim();
      const questionText = String(q.q || "").trim();
      const answer = String(q.answer || "").trim().toUpperCase();
      if (!questionText || !answer) return null;

      const options = {};
      ['A','B','C','D','E'].forEach(letter => {
        const optionText = q.options?.[letter] || q[`option${letter}`] || "";
        if (String(optionText || "").trim()) options[letter] = String(optionText).trim();
      });
      if (Object.keys(options).length === 0) return null;
      if (!options[answer]) return null;

      return {
        id,
        module: String(q.module || "Geral").trim(),
        chapter: String(q.chapter || "N√£o especificado").trim(),
        theme: String(q.theme || "Geral").trim(),
        level: String(q.level || "M√©dia").trim(),
        q: questionText,
        options,
        answer,
        explain: String(q.explain || "").trim()
      };
    }).filter(Boolean);

    if (questions.length === 0) throw new Error("Nenhuma quest√£o v√°lida encontrada no arquivo");
    return questions;
  }

  function uniqueSorted(arr) {
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b) => a.localeCompare(b, "pt-BR"));
  }

  function buildFilters() {
    db.modules = uniqueSorted(db.all.map(q => q.module));
    db.chapters = uniqueSorted(db.all.map(q => q.chapter));
    db.themes = uniqueSorted(db.all.map(q => q.theme));
    db.levels = uniqueSorted(db.all.map(q => q.level));

    renderChecklist($("listModule"), db.modules);
    renderChecklist($("listChapter"), db.chapters);
    fillSelectSingle($("selTheme"), db.themes, "Todos os temas");
    fillSelectSingle($("selLevel"), db.levels, "Todas as dificuldades");

    buildDistUI();
  }

  function fillSelectSingle(select, values, placeholder) {
    select.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = placeholder;
    select.appendChild(defaultOption);
    values.forEach(value => {
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  }

  function renderChecklist(container, items, getSub = null){
    if (!container) return;
    container.innerHTML = "";
    items.forEach(val => {
      const row = document.createElement("label");
      row.className = "chk-item";
      row.innerHTML = `
        <input type="checkbox" value="${escapeHtmlAttr(val)}">
        <div>
          <b>${escapeHtml(val)}</b>
          ${getSub ? `<small>${escapeHtml(getSub(val) || "")}</small>` : ``}
        </div>
      `;
      container.appendChild(row);
    });
  }

  function getCheckedValues(container){
    if (!container) return [];
    return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i => i.value)
      .filter(Boolean);
  }

  /* =========================================================
     Navega√ß√£o / Views
  ========================================================= */
  function showView(name) {
    $$('.nav a').forEach(a => a.classList.remove('active'));
    const navId = `nav${name.charAt(0).toUpperCase() + name.slice(1)}`;
    $(navId)?.classList.add('active');

    $$('.view').forEach(v => v.classList.remove('show'));
    const viewId = `view${name.charAt(0).toUpperCase() + name.slice(1)}`;
    $(viewId)?.classList.add('show');

    if (name === 'history') loadHistoryView();
    if (name === 'manuals') loadManuals();
  }

  function loadManuals() {
    const url = MANUAL_PDF;
    $("manualIframe").src = url;
    $("btnOpenManualNewTab").href = url;
    $("btnDownloadManual").href = url;
  }

  /* =========================================================
     Cursos
  ========================================================= */
  function renderCourses() {
    const searchTerm = ($("searchCourses").value || "").trim().toLowerCase();
    const grid = $("coursesGrid");
    if (!grid.dataset.loaded) grid.innerHTML = '<div class="loading"></div>';

    setTimeout(() => {
      const filtered = courses.filter(course => {
        if (!searchTerm) return true;
        const searchable = `${course.name} ${course.desc} ${course.tag}`.toLowerCase();
        return searchable.includes(searchTerm);
      });

      $("certCount").textContent = `(${filtered.length})`;

      grid.innerHTML = filtered.map(course => {
        const history = StatsManager.getHistory().filter(h => h.course === course.id);
        const totalQuestions = history.reduce((a,s)=>a+(s.totalQuestions||0),0);
        const avgAcc = history.length ? Math.round((history.reduce((a,s)=>a+(s.accuracy||0),0)/history.length)*10)/10 : 0;

        return `
          <div class="course-card ${selectedCourse?.id === course.id ? 'selected' : ''}"
              data-course="${course.id}"
              style="border-left: 4px solid ${course.color}">
            ${totalQuestions > 0 ? `<div class="progress-ring" title="${avgAcc}% de acerto">${avgAcc}%</div>` : ``}
            <div class="thumb" style="background: linear-gradient(120deg, ${course.color}22, ${course.color}44);">
              <div class="label">${course.tag}</div>
            </div>
            <div class="course-body">
              <h3 class="course-name">${course.icon} ${course.name}</h3>
              <p class="course-desc">${course.desc}</p>
              <div class="course-meta">
                <span title="Quest√µes dispon√≠veis">üìö ${course.stats.questions}+ quest√µes</span>
                <span title="M√≥dulos">üìñ ${course.stats.modules} m√≥dulos</span>
              </div>
              <div class="course-foot">
                <span class="chip" style="border-color: ${course.color}44; background: ${course.color}11; color: ${course.color};">${course.id}</span>
                <button class="btn ghost small" type="button" data-action="select">Selecionar</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      grid.dataset.loaded = true;

      $$('.course-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.closest('[data-action]')) {
            const courseId = card.dataset.course;
            selectCourse(courses.find(c => c.id === courseId), true);
          }
        });
        card.querySelector('[data-action="select"]')?.addEventListener('click', (e) => {
          e.stopPropagation();
          const courseId = card.dataset.course;
          selectCourse(courses.find(c => c.id === courseId), true);
        });
      });
    }, 200);
  }

  function selectCourse(course, autoOpenWizard = false) {
    selectedCourse = course;

    $$('.course-card').forEach(c => c.classList.remove('selected'));
    $(`[data-course="${course.id}"]`)?.classList.add('selected');

    $("btnOpenWizard").disabled = false;
    $("btnOpenWizard").textContent = `Configurar ${course.id}`;

    const loadPromise = (db.all.length === 0 || (selectedCourse && db.courseId !== selectedCourse.id))
      ? loadQuestionsForCourse(course)
      : Promise.resolve();

    loadPromise.then(() => {
      showToast(`Curso ${course.name} selecionado`, 'info');
      if (autoOpenWizard) openWizard();
    });
  }

  async function loadQuestionsForCourse(course) {
    try {
      const loadingToast = showToast(`Carregando quest√µes de ${course.id}...`, 'info', 0);
      const questions = await loadCourseDb(course);
      db.all = questions;
      db.courseId = course.id;
      course.stats.questions = questions.length;
      course.stats.modules = new Set(questions.map(q => q.module)).size;
      buildFilters();
      updateFilterInfo();
      updateConfirmText();
      loadingToast?.remove?.();
      showToast(`‚úÖ ${questions.length} quest√µes carregadas (${course.id})`, 'ok');
    } catch (error) {
      console.error("Erro ao carregar quest√µes:", error);
      showToast(`‚ùå Erro ao carregar quest√µes: ${error.message}`, 'bad', 4500);
      $("coursesGrid").innerHTML = `
        <div class="error-card" style="grid-column: 1 / -1;">
          <div class="error-title">Erro ao Carregar Quest√µes</div>
          <div class="muted">${error.message}</div>
          <button class="btn" onclick="location.reload()" style="margin-top: 15px;">Tentar Novamente</button>
        </div>
      `;
    }
  }

  /* =========================================================
     Wizard
  ========================================================= */
  let wizStep = 1;
  let wizMode = "quick";
  let wizStudyMode = "module";

  function openWizard() {
    if (!selectedCourse) { showToast("Selecione um curso primeiro", "bad"); return; }
    if (db.all.length === 0) {
      loadQuestionsForCourse(selectedCourse).then(openWizard);
      return;
    }
    $("wizardBackdrop").classList.add("show");
    $("wizardBackdrop").setAttribute("aria-hidden", "false");
    $("wizCourseName").textContent = selectedCourse.name;
    $("wizCourseName").style.color = selectedCourse.color;

    wizStep = 1;
    wizRender();
  }

  function closeWizard() {
    $("wizardBackdrop").classList.remove("show");
    $("wizardBackdrop").setAttribute("aria-hidden", "true");
  }

  function wizRender() {
    for (let i=1;i<=4;i++){
      $(`step${i}`).classList.toggle("active", i===wizStep);
      $(`wizPage${i}`).style.display = i===wizStep ? "" : "none";
    }
    $("btnPrevStep").disabled = wizStep===1;
    $("btnNextStep").disabled = false;
    $("btnNextStep").textContent = wizStep===4 ? "Iniciar Simulado ‚Üí" : "Continuar ‚Üí";

    const footers = [
      "Selecione o tipo de simulado",
      "Escolha sua estrat√©gia de estudo",
      "Ajuste os filtros conforme necess√°rio",
      "Revise e inicie seu simulado"
    ];
    $("wizFooter").textContent = footers[wizStep-1];
    $("wizSub").textContent = `Passo ${wizStep} de 4: ${footers[wizStep-1]}`;

    if (wizStep===3){ updateFilterInfo(); updateDistUIState(); }
    if (wizStep===4){ updateConfirmText(); }
  }

  function normalizeStr(s) {
    return String(s || "").toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s]/g, " ");
  }

  function applyWizardFilters() {
    if (!db.all || db.all.length === 0) return { base: [], qty: 0 };

    const modulesSel = getCheckedValues($("listModule"));
    const chaptersSel = getCheckedValues($("listChapter"));
    const theme = $("selTheme").value;
    const level = $("selLevel").value;
    const qty = Math.min(200, Math.max(1, parseInt($("selQty").value || "10", 10)));
    const noRepeat = $("chkNoRepeat").checked;
    const search = normalizeStr($("searchText").value);

    const official = $("chkOfficialDuration").checked;
    const distEnabled = $("chkDistEnable").checked;

    const questionStats = StatsManager.getQuestionStats();
    const answeredQuestions = noRepeat
      ? new Set(Object.keys(questionStats).filter(id => questionStats[id].correct > 0))
      : new Set();

    let questions = db.all.filter(q => {
      if (modulesSel.length && !modulesSel.includes(q.module)) return false;
      if (chaptersSel.length && !chaptersSel.includes(q.chapter)) return false;
      if (theme && q.theme !== theme) return false;
      if (level && q.level !== level) return false;

      if (search) {
        const big = normalizeStr([q.id,q.module,q.chapter,q.theme,q.level,q.q,...Object.values(q.options),q.explain].join(" "));
        if (!big.includes(search)) return false;
      }

      if (noRepeat && answeredQuestions.has(q.id)) return false;
      return true;
    });

    if (wizStudyMode === "weakness") {
      const weakAreas = StatsManager.getWeakAreas(3);
      questions = questions.filter(q => {
        const area = `${q.module}-${q.chapter}-${q.theme}`;
        return weakAreas.some(w => w.area === area);
      });
    }

    const shuffle = (arr) => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    if (distEnabled) {
      const distMode = $("distModePct").checked ? "pct" : "qty";
      const dist = readDistInputs();

      const filteredByModule = {};
      questions.forEach(q => {
        if (!filteredByModule[q.module]) filteredByModule[q.module] = [];
        filteredByModule[q.module].push(q);
      });

      const moduleList = Object.keys(filteredByModule);

      const targets = {};
      if (distMode === "pct") {
        let totalPct = moduleList.reduce((acc,m)=>acc+(Number(dist[m])||0),0);
        if (totalPct > 0) {
          moduleList.forEach(m => {
            const pct = Math.max(0, Number(dist[m]) || 0);
            targets[m] = Math.floor((pct / 100) * qty);
          });
          let currentSum = Object.values(targets).reduce((a,n)=>a+n,0);
          if (currentSum < qty) {
            const sorted = moduleList.slice().sort((a,b)=>(Number(dist[b])||0)-(Number(dist[a])||0));
            let k = 0;
            while (currentSum < qty && sorted.length) {
              targets[sorted[k % sorted.length]]++;
              currentSum++;
              k++;
            }
          } else if (currentSum > qty) {
            const sorted = moduleList.slice().sort((a,b)=>(Number(dist[a])||0)-(Number(dist[b])||0));
            let k = 0;
            while (currentSum > qty && sorted.length) {
              const mm = sorted[k % sorted.length];
              if (targets[mm] > 0) { targets[mm]--; currentSum--; }
              k++;
            }
          }
        }
      } else {
        moduleList.forEach(m => { targets[m] = Math.max(0, Math.floor(Number(dist[m]) || 0)); });
      }

      const sumTargets = Object.values(targets).reduce((a,n)=>a+n,0);
      if (sumTargets > 0) {
        let picked = [];
        moduleList.forEach(m => {
          const pool = shuffle((filteredByModule[m] || []).slice());
          const take = Math.min(targets[m] || 0, pool.length);
          picked = picked.concat(pool.slice(0, take));
        });

        if (picked.length < qty) {
          const pickedIds = new Set(picked.map(q => q.id));
          const remaining = shuffle(questions.filter(q => !pickedIds.has(q.id)));
          picked = picked.concat(remaining.slice(0, qty - picked.length));
        }

        questions = picked.slice(0, qty);
        return { base: questions, qty, noRepeat, modulesSel, chaptersSel, theme, level, s: $("searchText").value.trim(), official, distEnabled, distMode, dist };
      }
    }

    questions = shuffle(questions).slice(0, qty);

    return { base: questions, qty, noRepeat, modulesSel, chaptersSel, theme, level, s: $("searchText").value.trim(), official, distEnabled: false };
  }

  function updateFilterInfo() {
    const filtered = applyWizardFilters();
    const total = db.all.length;
    const percent = total > 0 ? Math.round((filtered.base.length / total) * 100) : 0;

    const official = $("chkOfficialDuration").checked;
    const badge = official ? ` ‚Ä¢ ‚è≥ 3h` : "";

    $("filterInfo").innerHTML = `
      <b>${filtered.base.length} quest√µes encontradas</b> (${percent}% do total)${badge}<br>
      <span class="muted">Base total: ${total} quest√µes</span>
    `;
    updateDistSumBadge();
  }

  function updateConfirmText() {
    const cfg = applyWizardFilters();
    $("confirmTitle").textContent = `Simulado ${selectedCourse?.id || ""}`;
    $("confirmQty").textContent = cfg.base.length;

    const parts = [];
    if (cfg.modulesSel?.length) parts.push(`M√≥dulos: ${cfg.modulesSel.length} selecionado(s)`);
    if (cfg.chaptersSel?.length) parts.push(`Cap√≠tulos: ${cfg.chaptersSel.length} selecionado(s)`);
    if (cfg.theme) parts.push(`Tema: ${cfg.theme}`);
    if (cfg.level) parts.push(`Dificuldade: ${cfg.level}`);
    if (cfg.s) parts.push(`Busca: "${cfg.s}"`);
    if (cfg.noRepeat) parts.push(`Evitar repetidas: sim`);
    if (cfg.official) parts.push(`Dura√ß√£o oficial: 3h`);
    if (cfg.distEnabled) parts.push(`Distribui√ß√£o por m√≥dulo: ${cfg.distMode === "pct" ? "percentual" : "quantidade"}`);

    $("confirmDetails").innerHTML = `${cfg.base.length} quest√µes ‚Ä¢ ${cfg.official ? "Limite 3h" : "Sem limite de tempo"}`;
    $("confirmFilters").innerHTML = parts.length ? parts.map(p => `‚Ä¢ ${p}`).join("<br>") : `<span class="muted">Nenhum filtro aplicado</span>`;
  }

  /* =========================================================
     Distribui√ß√£o por m√≥dulo (UI)
  ========================================================= */
  function buildDistUI() {
    const tbody = $("distRows");
    if (!tbody) return;
    tbody.innerHTML = "";

    db.modules.forEach(m => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(m)}</td>
        <td style="text-align:right;">
          <input class="dist-input" inputmode="numeric" data-mod="${escapeHtmlAttr(m)}" value="0" />
        </td>
      `;
      tbody.appendChild(tr);
    });

    $$("#distRows .dist-input").forEach(inp => {
      inp.addEventListener("input", () => {
        const v = String(inp.value || "").replace(/[^\d.]/g, "");
        inp.value = v;
        updateDistSumBadge();
        updateFilterInfo();
        updateConfirmText();
      });
    });
  }

  function updateDistUIState() {
    const enabled = $("chkDistEnable").checked;
    $("distBox").style.display = enabled ? "" : "none";
    updateDistSumBadge();
    updateFilterInfo();
    updateConfirmText();
  }

  function readDistInputs() {
    const out = {};
    $$("#distRows .dist-input").forEach(inp => {
      const mod = inp.getAttribute("data-mod");
      out[mod] = Number(inp.value || 0);
    });
    return out;
  }

  function updateDistSumBadge() {
    const badge = $("distSumBadge");
    if (!badge) return;

    if (!$("chkDistEnable").checked) {
      badge.textContent = "Distribui√ß√£o: desligada";
      badge.className = "kpi-badge";
      return;
    }

    const mode = $("distModePct").checked ? "pct" : "qty";
    const dist = readDistInputs();
    const sum = Object.values(dist).reduce((a,n)=>a+(Number(n)||0),0);

    if (mode === "pct") {
      badge.textContent = `Soma: ${sum}%`;
      badge.className = "kpi-badge " + (Math.round(sum) === 100 ? "ok" : "bad");
      $("distColTitle").textContent = "Percentual (%)";
      $("distNote").textContent = "No modo percentual, a soma ideal √© 100%. O sistema ajusta arredondamentos para fechar a quantidade total.";
    } else {
      const qty = parseInt($("selQty").value || "10", 10);
      badge.textContent = `Soma: ${sum}/${qty}`;
      badge.className = "kpi-badge " + (sum === qty ? "ok" : "bad");
      $("distColTitle").textContent = "Quantidade";
      $("distNote").textContent = "No modo quantidade, o ideal √© a soma bater a quantidade total. Se n√£o bater, o sistema completa com o restante.";
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function escapeHtmlAttr(s){ return escapeHtml(s); }

  /* =========================================================
     Simulado
  ========================================================= */
  const sim = {
    queue: [],
    idx: 0,
    answers: {},
    startedAt: null,
    timerId: null,
    selected: null,
    corrected: false,
    questionStartTime: null,
    excludedOptions: {},
    officialDuration: false,
    durationLimitMs: 3 * 60 * 60 * 1000
  };

  function startSimulado(config) {
    sim.queue = config.base;
    sim.idx = 0;
    sim.answers = {};
    sim.excludedOptions = {};
    sim.startedAt = Date.now();
    sim.officialDuration = !!config.official;

    sim.queue.forEach(q => {
      sim.excludedOptions[q.id] = ExclusionManager.getExcludedOptions(q.id);
    });

    SessionManager.saveSession({
      queue: sim.queue.map(q => q.id),
      idx: sim.idx,
      answers: sim.answers,
      excludedOptions: sim.excludedOptions,
      startedAt: sim.startedAt,
      course: selectedCourse.id,
      config
    });

    closeWizard();
    startTimer();
    renderQuiz();
    showView("quiz");
  }

  function startTimer() {
    if (sim.timerId) clearInterval(sim.timerId);

    $("qLimitPill").style.display = sim.officialDuration ? "inline-flex" : "none";
    $("qLimitPill").textContent = sim.officialDuration ? "‚è≥ 03:00:00" : "";

    sim.timerId = setInterval(() => {
      const elapsed = Date.now() - sim.startedAt;
      $("qTimer").textContent = formatTime(elapsed);

      if (sim.officialDuration) {
        const remaining = sim.durationLimitMs - elapsed;

        if (remaining <= 10 * 60 * 1000 && remaining > 0) {
          $("qTimer").style.color = "var(--warn)";
          $("qTimer").style.fontWeight = "900";
        }
        if (remaining <= 60 * 1000 && remaining > 0) {
          $("qTimer").style.color = "var(--bad)";
          $("qTimer").style.fontWeight = "900";
          $("qTimer").classList.add("timer-critical");
        } else {
          $("qTimer").classList.remove("timer-critical");
        }

        if (remaining <= 0) {
          stopTimer();
          showToast("‚è±Ô∏è Tempo limite (3h) atingido. Encerrando simulado...", "bad", 3500);
          finishSimulado(true);
        }
      }
    }, 200);
  }

  function stopTimer() {
    if (sim.timerId) {
      clearInterval(sim.timerId);
      sim.timerId = null;
    }
  }

  function formatTime(ms) {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    const HH = String(h).padStart(2,'0');
    const MM = String(m).padStart(2,'0');
    const SS = String(s).padStart(2,'0');
    return h > 0 ? `${HH}:${MM}:${SS}` : `${MM}:${SS}`;
  }

  function renderQuiz() {
    const total = sim.queue.length;
    const current = sim.queue[sim.idx];

    if (!current) { finishSimulado(false); return; }

    $("qCounter").textContent = `${sim.idx + 1}/${total}`;
    $("qCourseName").textContent = selectedCourse.name;
    $("qMeta").textContent = `${current.module} ‚Ä¢ ${current.theme}`;
    $("qId").textContent = `#${current.id}`;
    $("qDifficulty").textContent = current.level;
    $("qText").textContent = current.q;

    const savedAnswer = sim.answers[current.id];
    sim.selected = savedAnswer?.selected || null;
    sim.corrected = savedAnswer?.corrected || false;

    const progress = ((sim.idx) / total) * 100;
    $("progressBar").style.width = `${progress}%`;

    sim.questionStartTime = Date.now();

    $("btnPrev").disabled = sim.idx === 0;
    $("btnNext").disabled = false;
    $("btnCorrect").disabled = sim.corrected || !sim.selected;

    updateStarButton(current.id);
    updateQuestionStatus(savedAnswer);

    $("explanationBox").classList.remove("show");

    renderOptions(current);

    if (!sim.officialDuration) {
      $("qTimer").style.color = "";
      $("qTimer").style.fontWeight = "";
      $("qTimer").classList.remove("timer-critical");
    }

    renderQNav();
  }

  function renderQNav(){
    const grid = $("qnavGrid");
    const meta = $("qnavMeta");
    if (!grid || !meta) return;

    const total = sim.queue.length;

    let answered = 0;
    let corrected = 0;
    let correct = 0;
    let wrong = 0;
    let blank = 0;

    grid.innerHTML = "";

    for (let i = 0; i < total; i++){
      const q = sim.queue[i];
      const a = sim.answers[q.id];

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "qnav-btn";
      btn.textContent = String(i + 1);
      btn.title = `Quest√£o ${i + 1}: ${q.module} - ${q.theme}`;

      if (i === sim.idx) btn.classList.add("current");

      if (a?.selected) { 
        answered++; 
        btn.classList.add("answered"); 
      } else if (a?.corrected) {
        blank++;
        btn.classList.add("blank");
        btn.title += " (em branco)";
      }
      
      if (a?.corrected) {
        corrected++;
        if (a.correct) { 
          correct++; 
          btn.classList.add("correct"); 
          btn.title += " ‚úì Correta";
        } else { 
          wrong++; 
          btn.classList.add("wrong"); 
          btn.title += " ‚úó Errada";
        }
      } else if (a?.selected) {
        btn.classList.add("pending");
        btn.title += " ‚åõ Pendente";
      }

      btn.addEventListener("click", () => {
        sim.idx = i;
        renderQuiz();
      });

      grid.appendChild(btn);
    }

    meta.textContent =
      `Total: ${total} ‚Ä¢ Respondidas: ${answered} ‚Ä¢ Corrigidas: ${corrected} ‚Ä¢ ‚úÖ ${correct} / ‚ùå ${wrong} / ‚¨ú ${blank}`;
  }

  function updateStarButton(questionId) {
    const starBtn = $("btnStar");
    const isBookmarked = BookmarkManager.isBookmarked(questionId);
    starBtn.textContent = isBookmarked ? "‚òÖ" : "‚òÜ";
    starBtn.classList.toggle("active", isBookmarked);
    starBtn.title = isBookmarked ? "Remover da lista de revis√£o" : "Marcar para revis√£o";
  }

  function updateQuestionStatus(savedAnswer) {
    const el = $("qStatus");
    if (!savedAnswer) {
      el.innerHTML = '<span class="muted">N√£o respondida</span>';
      return;
    }
    if (savedAnswer.corrected) {
      const isCorrect = savedAnswer.correct;
      el.innerHTML = `
        <span class="result-indicator ${isCorrect ? 'correct' : 'incorrect'}">
          ${isCorrect ? '‚úÖ Correta' : '‚ùå Incorreta'}
        </span>
      `;
      return;
    }
    if (savedAnswer.selected) {
      el.innerHTML = '<span class="muted">Respondida (n√£o corrigida)</span>';
      return;
    }
    el.innerHTML = '<span class="muted">N√£o respondida</span>';
  }

  function renderOptions(current) {
    const optionsContainer = $("qOptions");
    optionsContainer.innerHTML = "";

    const letters = ['A','B','C','D','E'];
    const excluded = sim.excludedOptions[current.id] || [];

    letters.forEach(letter => {
      const optionText = current.options[letter];
      if (!optionText) return;

      const isExcluded = excluded.includes(letter);
      const optionDiv = document.createElement("div");
      optionDiv.className = `opt ${isExcluded ? 'excluded' : ''}`;

      if (sim.selected === letter) optionDiv.classList.add("selected");
      if (sim.corrected) {
        if (letter === current.answer) optionDiv.classList.add("correct");
        else if (letter === sim.selected) optionDiv.classList.add("wrong");
      }

      optionDiv.innerHTML = `
        <div class="radio"></div>
        <div class="txt"><span class="letter">${letter}.</span> ${escapeHtml(optionText)}</div>
        <button class="exclude-btn" data-letter="${letter}" title="${isExcluded ? 'Restaurar alternativa' : 'Excluir alternativa'}">‚úÇÔ∏è</button>
      `;

      if (!sim.corrected && !isExcluded) {
        optionDiv.addEventListener("click", (e) => {
          if (!e.target.closest('.exclude-btn')) selectOption(letter);
        });
      }

      optionDiv.querySelector('.exclude-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleExcludeOption(letter);
      });

      optionsContainer.appendChild(optionDiv);
    });
  }

  function selectOption(letter) {
    if (sim.corrected) return;
    const currentQuestion = sim.queue[sim.idx];
    const excluded = sim.excludedOptions[currentQuestion.id] || [];
    if (excluded.includes(letter)) {
      showToast("Esta alternativa foi exclu√≠da. Restaure-a primeiro.", "bad");
      return;
    }

    sim.selected = letter;

    $$(".opt").forEach(opt => opt.classList.remove("selected"));
    $$(".opt").forEach(opt => {
      const l = opt.querySelector(".letter")?.textContent?.charAt(0);
      if (l === letter) opt.classList.add("selected");
    });

    $("btnCorrect").disabled = false;
    updateQuestionStatus(sim.answers[currentQuestion.id]);
    renderQNav();
  }

  function toggleExcludeOption(letter) {
    const currentQuestion = sim.queue[sim.idx];
    const excludedNow = ExclusionManager.toggleExclusion(currentQuestion.id, letter);

    if (!sim.excludedOptions[currentQuestion.id]) sim.excludedOptions[currentQuestion.id] = [];
    const idx = sim.excludedOptions[currentQuestion.id].indexOf(letter);
    if (idx === -1) sim.excludedOptions[currentQuestion.id].push(letter);
    else sim.excludedOptions[currentQuestion.id].splice(idx, 1);

    if (sim.selected === letter && excludedNow) {
      sim.selected = null;
      $("btnCorrect").disabled = true;
    }
    renderQuiz();
  }

  function toggleStar() {
    const current = sim.queue[sim.idx];
    const added = BookmarkManager.toggleBookmark(current.id);
    updateStarButton(current.id);
    showToast(added ? "‚≠ê Quest√£o marcada para revis√£o" : "üìù Marca√ß√£o removida", "info");
  }

  function correctAnswer() {
    if (sim.corrected || !sim.selected) return;

    const current = sim.queue[sim.idx];
    const isCorrect = sim.selected === current.answer;
    const timeSpent = Date.now() - sim.questionStartTime;

    sim.answers[current.id] = { selected: sim.selected, correct: isCorrect, corrected: true, timeSpent };
    sim.corrected = true;

    StatsManager.updateQuestionStats(current.id, isCorrect, timeSpent);

    $("btnCorrect").disabled = true;
    updateQuestionStatus(sim.answers[current.id]);
    showExplanation(current, isCorrect);
    renderOptions(current);
    renderQNav();

    SessionManager.saveSession({
      queue: sim.queue.map(q => q.id),
      idx: sim.idx,
      answers: sim.answers,
      excludedOptions: sim.excludedOptions,
      startedAt: sim.startedAt,
      course: selectedCourse.id
    });
  }

  function showExplanation(question, isCorrect) {
    const box = $("explanationBox");
    const txt = $("explanationText");
    if (!question.explain) return;

    txt.textContent = question.explain;
    box.classList.add("show");

    const title = box.querySelector('.explanation-title');
    title.innerHTML = `üìù Explica√ß√£o <span class="result-indicator ${isCorrect ? 'correct' : 'incorrect'}">${isCorrect ? '‚úÖ Correta' : '‚ùå Incorreta'}</span>`;
  }

  function nextQuestion() {
    const current = sim.queue[sim.idx];

    if (sim.selected && !sim.corrected) {
      if (!sim.answers[current.id]) {
        sim.answers[current.id] = { selected: sim.selected, correct: false, corrected: false, timeSpent: Date.now() - sim.questionStartTime };
      } else {
        sim.answers[current.id].selected = sim.selected;
        sim.answers[current.id].corrected = false;
        sim.answers[current.id].timeSpent = Date.now() - sim.questionStartTime;
      }
    } else if (!sim.selected && !sim.answers[current.id]) {
      sim.answers[current.id] = { selected: null, correct: false, corrected: false, timeSpent: 0 };
    }

    sim.idx++;
    if (sim.idx >= sim.queue.length) finishSimulado(false);
    else renderQuiz();
  }

  function prevQuestion() {
    if (sim.idx === 0) return;
    sim.idx--;
    renderQuiz();
  }

  function finishSimulado(endedByTime = false) {
    const current = sim.queue[sim.idx];
    if (current && sim.selected && !sim.corrected && !sim.answers[current.id]) {
      sim.answers[current.id] = { selected: sim.selected, correct: false, corrected: false, timeSpent: Date.now() - sim.questionStartTime };
    }

    const uncorrected = sim.queue.filter(q => !sim.answers[q.id]?.corrected);

    sim.queue.forEach(q => {
      if (!sim.answers[q.id]) {
        sim.answers[q.id] = { selected: null, correct: false, corrected: false, timeSpent: 0 };
      }
    });

    uncorrected.forEach(q => {
      const rec = sim.answers[q.id];

      if (!rec.selected) {
        rec.correct = false;
        rec.corrected = true;
        return;
      }

      rec.correct = rec.selected === q.answer;
      rec.corrected = true;
      StatsManager.updateQuestionStats(q.id, rec.correct, rec.timeSpent || 0);
    });

    stopTimer();

    const total = sim.queue.length;
    const correct = Object.values(sim.answers).filter(a => a.correct).length;
    const blank = Object.values(sim.answers).filter(a => !a.selected).length;
    const accuracy = total > 0 ? (correct / total) * 100 : 0;
    const totalTime = Date.now() - sim.startedAt;

    StatsManager.addSession({
      course: selectedCourse.id,
      totalQuestions: total,
      correctAnswers: correct,
      blankAnswers: blank,
      accuracy: Math.round(accuracy * 10) / 10,
      timeSpent: totalTime,
      date: new Date().toISOString(),
      answers: sim.answers,
      autoCorrected: uncorrected.length,
      endedByTime: !!endedByTime
    });

    SessionManager.clearSession();

    showResults({
      total, correct, blank, accuracy,
      totalTime, answers: sim.answers,
      questions: sim.queue,
      autoCorrected: uncorrected.length,
      endedByTime
    });
  }

  function showResults(results) {
    const content = $("resultsContent");
    const timePerQuestion = results.total > 0 ? Math.round(results.totalTime / results.total / 1000) : 0;

    content.innerHTML = `
      <div class="manual-wrap" style="padding:18px;">
        <h2 style="margin:0 0 6px 0; font-weight:950; color:${selectedCourse.color};">Simulado Conclu√≠do!</h2>
        <div class="muted">${selectedCourse.name} ‚Ä¢ ${new Date().toLocaleDateString('pt-BR')} ${results.endedByTime ? '‚Ä¢ ‚è±Ô∏è Encerrado por tempo' : ''}</div>

        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:16px;">
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; text-align:center;">
            <div class="muted" style="font-weight:900; text-transform:uppercase; letter-spacing:.6px; font-size:11px;">Taxa de acerto</div>
            <div style="font-size:34px; font-weight:950; color:${results.accuracy>=70?'var(--ok)':results.accuracy>=50?'var(--warn)':'var(--bad)'}">${Math.round(results.accuracy)}%</div>
            <div class="muted">${results.correct}/${results.total} acertos ‚Ä¢ ${results.blank} em branco</div>
          </div>
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; text-align:center;">
            <div class="muted" style="font-weight:900; text-transform:uppercase; letter-spacing:.6px; font-size:11px;">Tempo total</div>
            <div style="font-size:34px; font-weight:950; color:var(--brand-2);">${formatTime(results.totalTime)}</div>
            <div class="muted">${timePerQuestion}s por quest√£o</div>
          </div>
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; text-align:center;">
            <div class="muted" style="font-weight:900; text-transform:uppercase; letter-spacing:.6px; font-size:11px;">Corre√ß√£o</div>
            <div style="font-size:34px; font-weight:950; color:var(--brand-2);">${results.autoCorrected}</div>
            <div class="muted">corrigidas automaticamente</div>
          </div>
        </div>

        ${(results.total - results.correct) > 0 ? `
          <div style="margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--border);">
            <h4 style="margin: 0 0 10px 0; color: var(--brand);">Quest√µes erradas (${results.total - results.correct})</h4>
            <div class="muted" style="max-height: 220px; overflow-y: auto; font-size: 12px;">
              ${Object.entries(results.answers)
                .filter(([_, a]) => a.selected && !a.correct)
                .map(([id, answer]) => {
                  const q = results.questions.find(qq => qq.id === id);
                  if (!q) return '';
                  return `
                    <div style="margin-bottom: 10px; padding: 10px; background: var(--bad-light); border-radius: 10px; border-left: 3px solid var(--bad);">
                      <div style="font-weight: 950; color: var(--bad);">${q.id} ‚Ä¢ ${escapeHtml(q.theme)}</div>
                      <div style="margin: 4px 0; font-weight: 700;">${escapeHtml(String(q.q).slice(0, 120))}${q.q.length>120?'...':''}</div>
                      <div style="font-size: 11px;">
                        <span style="color: var(--bad);">Sua resposta: ${answer.selected}</span> |
                        <span style="color: var(--ok);">Correta: ${q.answer}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
            </div>
          </div>
        ` : `
          <div style="margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--border); text-align:center;">
            <div style="font-weight:950; color:var(--ok);">üéâ Parab√©ns! Nenhum erro.</div>
          </div>
        `}
      </div>
    `;

    $("resultsFooter").textContent = `Tempo total: ${formatTime(results.totalTime)} ‚Ä¢ ${results.endedByTime ? 'Encerrado por tempo' : 'Conclu√≠do'}`;
    $("resultsBackdrop").classList.add("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "false");
  }

  /* =========================================================
     Hist√≥rico
  ========================================================= */
  function loadHistoryView() {
    const container = $("historyContent");
    const history = StatsManager.getHistory();
    const bookmarks = BookmarkManager.getBookmarks();
    const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'history';

    if (activeTab === 'history') {
      if (history.length === 0) {
        container.innerHTML = `
          <div class="manual-wrap" style="padding:18px; text-align:center;">
            <h3 style="color: var(--brand); margin: 0 0 10px 0;">Nenhum simulado encontrado</h3>
            <div class="muted">Comece fazendo seu primeiro simulado!</div>
            <button class="btn primary" onclick="showView('home')" style="margin-top: 15px;">Iniciar</button>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Curso</th>
              <th>Quest√µes</th>
              <th>Acerto</th>
              <th>Tempo</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${history.map(s => `
              <tr>
                <td>${new Date(s.completedAt).toLocaleDateString('pt-BR')}</td>
                <td><strong>${s.course}</strong></td>
                <td>${s.totalQuestions}</td>
                <td>
                  <span class="badge ${s.accuracy >= 70 ? 'correct' : s.accuracy >= 50 ? 'pending' : 'incorrect'}">
                    ${s.accuracy}%
                  </span>
                </td>
                <td>${formatTime(s.timeSpent)}</td>
                <td>${s.endedByTime ? '<span class="badge incorrect">tempo</span>' : '<span class="badge correct">ok</span>'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      return;
    }

    if (activeTab === 'bookmarks') {
      if (bookmarks.length === 0) {
        container.innerHTML = `
          <div class="manual-wrap" style="padding:18px; text-align:center;">
            <h3 style="color: var(--brand); margin: 0 0 10px 0;">Nenhuma quest√£o marcada</h3>
            <div class="muted">Marque quest√µes durante o simulado clicando no ‚≠ê</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="manual-wrap" style="padding:18px;">
          <h3 style="color: var(--brand); margin: 0 0 8px 0;">${bookmarks.length} Quest√µes Marcadas</h3>
          <div class="muted">Estas s√£o as quest√µes que voc√™ marcou para revis√£o.</div>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="manual-wrap" style="padding:18px;">
        <h3 style="color: var(--brand); margin: 0 0 8px 0;">Erros para revisar</h3>
        <div class="muted">Em breve: lista inteligente por tema/m√≥dulo.</div>
      </div>
    `;
  }

  /* =========================================================
     Utilit√°rios
  ========================================================= */
  function showToast(message, type = "info", duration = 3000) {
    const wrap = $("globalToast");
    const inner = $("globalToastInner");
    if (!wrap || !inner) return null;

    inner.className = `toast show ${type}`;
    inner.textContent = message;
    wrap.style.display = "block";

    if (duration > 0) {
      setTimeout(() => {
        wrap.style.display = "none";
        inner.textContent = "";
      }, duration);
    }
    return inner;
  }

  function exportData(format) {
    const history = StatsManager.getHistory();
    const stats = StatsManager.getQuestionStats();
    let data, filename, mimeType;

    if (format === 'csv') {
      let csv = "ID,Tentativas,Acertos,Taxa de Acerto,Tempo M√©dio (s),√öltima Tentativa\n";
      Object.entries(stats).forEach(([id, st]) => {
        const accuracy = st.attempts > 0 ? (st.correct / st.attempts * 100).toFixed(1) : "0";
        const avgTime = st.attempts > 0 ? Math.round(st.totalTime / st.attempts / 1000) : "0";
        csv += `"${id}",${st.attempts},${st.correct},${accuracy}%,${avgTime},"${new Date(st.lastAttempt).toLocaleDateString('pt-BR')}"\n`;
      });
      data = csv;
      filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.csv`;
      mimeType = 'text/csv;charset=utf-8;';
    } else {
      data = JSON.stringify({ history, stats, exportedAt: new Date().toISOString(), user: currentUser }, null, 2);
      filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.json`;
      mimeType = 'application/json';
    }

    const blob = new Blob([data], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    showToast(`‚úÖ Dados exportados: ${filename}`, 'ok');
  }

  /* =========================================================
     Event listeners
  ========================================================= */
  $("btnLogin").addEventListener("click", () => {
    const user = ($("loginUser").value || "").trim();
    const pass = ($("loginPass").value || "").trim();
    const remember = $("rememberMe").checked;

    if (!user || !pass) { showToast("Preencha usu√°rio e senha", "bad"); return; }

    AuthManager.setAuth(user, remember);
    AuthManager.requireLogin();
    renderCourses();
    showToast(`‚úÖ Bem-vindo, ${user}!`, "ok");
  });

  $("btnLogout").addEventListener("click", () => {
    AuthManager.clearAuth();
    selectedCourse = null;
    db.all = [];
    $("btnOpenWizard").disabled = true;
    showView("home");
    AuthManager.requireLogin();
    showToast("‚úÖ Logout realizado", "ok");
  });

  $$('.nav a').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const view = a.id.replace('nav', '').toLowerCase();
      showView(view);
    });
  });

  $$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      loadHistoryView();
    });
  });

  let searchTimeout;
  $("searchCourses").addEventListener("input", () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(renderCourses, 250);
  });

  $("btnOpenWizard").addEventListener("click", openWizard);
  $("btnCloseWizard").addEventListener("click", closeWizard);
  $("wizardBackdrop").addEventListener("click", (e) => {
    if (e.target === $("wizardBackdrop")) closeWizard();
  });

  $("btnPrevStep").addEventListener("click", () => { wizStep = Math.max(1, wizStep - 1); wizRender(); });

  $("btnNextStep").addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();

    if (wizStep === 4) {
      const config = applyWizardFilters();
      if (!config.base || config.base.length === 0) {
        showToast("Nenhuma quest√£o encontrada com esses filtros", "bad");
        wizStep = 3;
        wizRender();
        return;
      }
      startSimulado(config);
      return;
    }

    wizStep = Math.min(4, wizStep + 1);
    wizRender();
  });

  $$('.mode[data-mode]').forEach(mode => {
    mode.addEventListener('click', () => {
      $$('.mode[data-mode]').forEach(m => m.classList.remove('selected'));
      mode.classList.add('selected');
      wizMode = mode.dataset.mode;

      if (wizMode === 'quick') {
        $("selQty").value = "10";
        $("chkOfficialDuration").checked = false;
      }
      if (wizMode === 'exam') {
        $("selQty").value = "60";
      }

      updateFilterInfo();
      updateConfirmText();
    });
  });

  $$('.mode[data-study]').forEach(mode => {
    mode.addEventListener('click', () => {
      $$('.mode[data-study]').forEach(m => m.classList.remove('selected'));
      mode.classList.add('selected');
      wizStudyMode = mode.dataset.study;
      updateFilterInfo();
      updateConfirmText();
    });
  });

  ['selTheme','selLevel','selQty','chkNoRepeat','chkOfficialDuration','chkDistEnable'].forEach(id => {
    $(id).addEventListener('change', () => {
      updateDistUIState();
      updateFilterInfo();
      updateConfirmText();
    });
  });

  ["listModule","listChapter"].forEach(id => {
    $(id).addEventListener("change", () => {
      updateFilterInfo();
      updateConfirmText();
    });
  });

  $("distModeQty").addEventListener("change", () => { updateDistSumBadge(); updateFilterInfo(); updateConfirmText(); });
  $("distModePct").addEventListener("change", () => { updateDistSumBadge(); updateFilterInfo(); updateConfirmText(); });

  function debounce(func, wait) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => func(...args), wait);
    };
  }
  $("searchText").addEventListener('input', debounce(() => {
    updateFilterInfo();
    updateConfirmText();
  }, 250));

  $("btnCorrect").addEventListener("click", correctAnswer);
  $("btnNext").addEventListener("click", nextQuestion);
  $("btnPrev").addEventListener("click", prevQuestion);
  $("btnStar").addEventListener("click", toggleStar);
  $("btnFinish").addEventListener("click", () => finishSimulado(false));

  $("btnCloseResults").addEventListener("click", () => {
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "true");
    showView("home");
  });
  $("btnNewSimulado").addEventListener("click", () => {
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "true");
    openWizard();
  });

  $("btnExportCSV").addEventListener("click", () => exportData('csv'));
  $("btnExportJSON").addEventListener("click", () => exportData('json'));

  /* =========================================================
     Init
  ========================================================= */
  async function init() {
    AuthManager.requireLogin();

    loadManuals();

    selectedCourse = courses[0];
    try { await loadQuestionsForCourse(selectedCourse); }
    catch(e){}

    $("btnOpenWizard").disabled = false;
    $("btnOpenWizard").textContent = `Configurar ${selectedCourse.id}`;

    renderCourses();
  }

  window.showView = showView;
  init();

})();
</script>
</body>
</html>
