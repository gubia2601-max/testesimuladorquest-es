<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Certifica√ß√µes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* =========================================================
  DESIGN TOKENS (obrigat√≥rio)
========================================================= */
:root{
  /* identidade (mantida) */
  --bg:#F9FAFC;
  --panel:#FFFFFF;
  --panel-2:#F5F7FB;
  --text:#0F172A;
  --muted:#64748B;
  --border:#E2E8F0;
  --brand:#1E40AF;
  --brand-2:#3B82F6;
  --brand-3:#10B981;

  /* estados */
  --success:#10B981;
  --warning:#F59E0B;
  --danger:#EF4444;
  --info:#3B82F6;

  --success-bg:rgba(16, 185, 129, 0.10);
  --warning-bg:rgba(245, 158, 11, 0.10);
  --danger-bg:rgba(239, 68, 68, 0.10);
  --info-bg:rgba(59, 130, 246, 0.10);

  /* tipografia */
  --fs-12:12px;
  --fs-14:14px;
  --fs-16:16px;
  --fs-20:20px;
  --fs-24:24px;

  /* espa√ßamento */
  --space-1:4px;
  --space-2:8px;
  --space-3:12px;
  --space-4:16px;
  --space-5:20px;
  --space-6:24px;
  --space-7:32px;
  --space-8:40px;

  /* radius */
  --radius-sm:8px;
  --radius-md:12px;
  --radius-lg:16px;
  --radius-xl:24px;

  /* sombras */
  --shadow-sm:0 2px 12px rgba(15, 23, 42, 0.04);
  --shadow-md:0 4px 20px rgba(15, 23, 42, 0.06);
  --shadow-lg:0 10px 40px rgba(15, 23, 42, 0.10);

  /* foco */
  --focus-ring: 0 0 0 3px rgba(59, 130, 246, 0.20);

  --maxw:1180px;
}

/* =========================================================
  RESET E BASE
========================================================= */
*{ box-sizing:border-box; margin:0; padding:0; }
html,body{ height:100%; font-size:14px; }
body{
  font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height:1.5;
  overflow-x:hidden;
}
::selection{ background:rgba(59,130,246,.2); color:var(--text); }

a{ color:inherit; }
button, input, select, textarea{ font-family:inherit; }

/* =========================================================
  TOPBAR
========================================================= */
.topbar{
  height:64px;
  background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
  color: var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
  position: sticky;
  top:0;
  z-index: 100;
  border-bottom: 1px solid var(--border);
}
.topbar-inner{
  width: min(var(--maxw), calc(100% - 32px));
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
  font-weight: 800;
  font-size: 18px;
  color: var(--brand);
  letter-spacing:-0.2px;
}
.brand .logo{
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--brand-2), var(--brand));
  display:grid;
  place-items:center;
  font-weight: 800;
  color: white;
  font-size: 16px;
}
.nav{
  display:flex;
  align-items:center;
  gap:24px;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
}
.nav a{
  color: inherit;
  text-decoration:none;
  padding: 6px 0;
  position: relative;
  transition: color 0.2s;
  white-space: nowrap;
}
.nav a:hover{ color: var(--brand-2); }
.nav a.active{ color: var(--brand); font-weight:700; }
.nav a.active::after{
  content:"";
  position:absolute;
  bottom:-2px;
  left:0; right:0;
  height:2px;
  background: var(--brand);
  border-radius:2px;
}
.top-actions{ display:flex; align-items:center; gap:12px; }
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 16px;
  border-radius: 20px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 13px;
  white-space: nowrap;
  color: var(--text);
}

/* =========================================================
  LAYOUT
========================================================= */
.wrap{
  width: min(var(--maxw), calc(100% - 32px));
  margin: 24px auto 48px auto;
  min-height: calc(100vh - 120px);
}
.hero-banner{
  background: linear-gradient(135deg, #FFFFFF 0%, #F0F4FF 100%);
  border-radius: var(--radius-lg);
  padding: 40px 48px;
  position: relative;
  overflow:hidden;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  margin-bottom: 24px;
}
.hero-banner::before{
  content:"";
  position:absolute;
  top:0; right:0;
  width: 200px; height:200px;
  background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
  border-radius:50%;
  transform:translate(30%, -30%);
}
.hero-title{
  color: var(--text);
  font-weight: 800;
  font-size: 32px;
  letter-spacing:-0.4px;
  margin:0 0 12px 0;
  line-height:1.2;
}
.hero-sub{
  color: var(--muted);
  font-size: 16px;
  font-weight: 500;
  max-width: 760px;
  line-height:1.6;
}
.section-title{
  margin: 0 0 16px 0;
  font-size: 24px;
  font-weight: 800;
  letter-spacing:-0.3px;
  color: var(--text);
}

/* =========================================================
  COMPONENTES PADR√ÉO
========================================================= */
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow-sm);
  overflow:hidden;
}
.card-head{
  padding: var(--space-6);
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:var(--space-4);
}
.card-body{ padding: var(--space-6); }
.card-foot{
  padding: var(--space-6);
  border-top:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:var(--space-4);
  flex-wrap:wrap;
}

.btn{
  appearance:none;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  border-radius: 12px;
  padding: 12px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor:pointer;
  transition: all .18s ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  white-space: nowrap;
  outline: none;
}
.btn:focus-visible{ box-shadow: var(--focus-ring); border-color: var(--brand-2); }
.btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); border-color: var(--brand-2); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none !important; box-shadow:none !important; }

.btn.primary{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  border-color: transparent;
  color:#fff;
}
.btn.secondary{
  background: var(--panel-2);
  border-color: var(--border);
  color: var(--text);
}
.btn.ghost{
  background: transparent;
  border-color: rgba(59,130,246,.20);
  color: var(--brand-2);
}
.btn.danger{
  background: linear-gradient(135deg, #EF4444, #DC2626);
  border-color: transparent;
  color:#fff;
}
.btn.small{ padding: 8px 14px; font-size: 13px; border-radius: 10px; }

.field{ display:flex; flex-direction:column; gap:8px; }
.field label{ font-size:13px; font-weight:600; color:var(--text); }
.field input,.field select,.field textarea{
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline:none;
  font-weight: 500;
  font-size: 14px;
  background: var(--panel);
  transition: all .18s ease;
  color: var(--text);
}
.field input:hover,.field select:hover,.field textarea:hover{ border-color: rgba(59,130,246,.35); }
.field input:focus,.field select:focus,.field textarea:focus{
  border-color: var(--brand-2);
  box-shadow: var(--focus-ring);
}
.field .hint{ font-size: 12px; color: var(--muted); margin-top: 2px; }
.field .error{ font-size: 12px; color: var(--danger); display:none; }
.field.invalid input,.field.invalid select,.field.invalid textarea{ border-color: rgba(239,68,68,.6); box-shadow: 0 0 0 3px rgba(239,68,68,.12); }
.field.invalid .error{ display:block; }

.toast{
  margin-top: 16px;
  padding: 14px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font-weight: 500;
  font-size: 14px;
  display:none;
  white-space: pre-wrap;
  line-height: 1.5;
  box-shadow: var(--shadow-md);
}
.toast.show{ display:block; }
.toast.ok{ border-color: rgba(16,185,129,.35); background: var(--success-bg); color: var(--success); }
.toast.bad{ border-color: rgba(239,68,68,.35); background: var(--danger-bg); color: var(--danger); }
.toast.info{ border-color: rgba(59,130,246,.35); background: var(--info-bg); color: var(--brand-2); }

.muted{ color: var(--muted); font-weight:500; font-size:14px; }
.nowrap{ white-space:nowrap; }

/* =========================================================
  GRID CURSOS
========================================================= */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
  margin: 24px 0;
}
.course-card{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow:hidden;
  box-shadow: var(--shadow-sm);
  cursor:pointer;
  transition:all .22s ease;
  display:flex;
  flex-direction: column;
  position: relative;
  height: 100%;
}
.course-card:hover{ transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--brand-2); }
.course-card.selected{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59,130,246,.10), var(--shadow-md);
}
.course-card .progress-ring{
  position:absolute;
  top: 16px; right: 16px;
  width: 48px; height: 48px;
  background: var(--panel);
  border-radius: 50%;
  display:grid;
  place-items:center;
  font-weight: 800;
  font-size: 12px;
  color: var(--brand);
  border: 2px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.thumb{
  height: 140px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
  position: relative;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb .label{
  position:absolute;
  left:16px; top:16px;
  background: rgba(255,255,255,0.9);
  border: 1px solid var(--border);
  color: var(--brand);
  font-weight: 800;
  font-size: 11px;
  padding: 6px 12px;
  border-radius: 20px;
  text-transform: uppercase;
  letter-spacing: .5px;
  backdrop-filter: blur(10px);
}
.course-body{ padding: 24px; display:flex; flex-direction:column; gap: 12px; flex:1; }
.course-name{ font-weight:800; font-size:18px; margin:0; color:var(--text); line-height:1.3; }
.course-desc{ margin:0; color:var(--muted); font-weight:500; font-size:14px; line-height:1.5; flex:1; }
.course-meta{ display:flex; gap:16px; font-size:13px; color:var(--muted); font-weight:500; flex-wrap:wrap; }
.course-meta span{ display:flex; align-items:center; gap:6px; }
.course-foot{
  margin-top:auto;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.chip{
  font-size: 12px;
  font-weight: 800;
  padding: 6px 12px;
  border-radius: 20px;
  background: rgba(59,130,246,.10);
  border: 1px solid rgba(59,130,246,.20);
  color: var(--brand);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: .3px;
}

/* =========================================================
  DASHBOARD (HOME)
========================================================= */
.kpi-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap: 16px;
  margin: 16px 0 24px 0;
}
.kpi{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 18px;
  box-shadow: var(--shadow-sm);
}
.kpi .label{
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing:.5px;
}
.kpi .value{
  margin-top: 8px;
  font-size: 28px;
  font-weight: 900;
  letter-spacing: -0.4px;
}
.kpi .sub{
  margin-top: 6px;
  color: var(--muted);
  font-size: 13px;
  font-weight: 500;
  display:flex;
  align-items:center;
  gap: 8px;
}
.trend{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  border:1px solid var(--border);
  background: var(--panel-2);
}
.trend.up{ color: var(--success); border-color: rgba(16,185,129,.35); background: var(--success-bg); }
.trend.down{ color: var(--danger); border-color: rgba(239,68,68,.35); background: var(--danger-bg); }
.trend.flat{ color: var(--muted); }

.home-grid{
  display:grid;
  grid-template-columns: 1.3fr .7fr;
  gap: 16px;
  align-items:start;
}
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  background: var(--panel);
  border-radius: var(--radius-lg);
  overflow: hidden;
  border: 1px solid var(--border);
}
.table th{
  text-align:left;
  padding: 14px 16px;
  background: var(--panel-2);
  color: var(--text);
  font-weight: 800;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing:.5px;
  border-bottom: 1px solid var(--border);
}
.table td{
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  font-weight: 500;
}
.table tr:last-child td{ border-bottom:0; }
.table tr:hover{ background: rgba(59,130,246,.03); }

.mini-list{
  display:flex;
  flex-direction:column;
  gap: 10px;
}
.mini-item{
  padding: 12px 12px;
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: var(--radius-md);
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 10px;
}
.mini-item b{ font-weight:800; }
.mini-item small{ display:block; margin-top: 2px; color: var(--muted); font-weight:500; }

/* donut simples */
.donut{
  width: 160px; height:160px;
  border-radius:50%;
  background: conic-gradient(var(--brand-2) 0deg, var(--brand-2) var(--deg), var(--panel-2) var(--deg), var(--panel-2) 360deg);
  position: relative;
  margin: 10px auto 0 auto;
  border: 1px solid var(--border);
}
.donut::after{
  content:"";
  position:absolute; inset: 18px;
  border-radius:50%;
  background: var(--panel);
  border: 1px solid var(--border);
}
.donut-center{
  position:absolute; inset: 0;
  display:grid;
  place-items:center;
  text-align:center;
  z-index: 2;
}
.donut-center b{ font-size: 22px; font-weight: 900; }
.donut-center span{ font-size: 12px; color: var(--muted); font-weight: 600; }

/* =========================================================
  MODAIS / OVERLAYS com aria-*
========================================================= */
.backdrop{
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.70);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 20px;
  z-index: 1000;
  animation: fadeIn .18s ease;
  backdrop-filter: blur(4px);
}
.backdrop.show{ display:flex; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideUp { from{opacity:0; transform:translateY(16px)} to{opacity:1; transform:translateY(0)} }

.modal{
  width: min(900px, 100%);
  background: var(--panel);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  overflow:hidden;
  border: 1px solid var(--border);
  animation: slideUp .22s ease;
  display:flex;
  flex-direction:column;
  max-height: 90vh;
}
.modal-head{
  padding: 22px 26px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  background: var(--panel);
  flex-shrink: 0;
}
.modal-head h2{ margin:0; font-size: 20px; font-weight: 800; }
.modal-body{
  padding: 26px;
  overflow-y: auto;
  flex: 1;
  max-height: calc(90vh - 180px);
}
.modal-foot{
  padding: 18px 26px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
}

/* =========================================================
  WIZARD STEPS
========================================================= */
.steps{
  display:flex;
  align-items:center;
  gap: 8px;
  margin-bottom: 20px;
  overflow-x: auto;
  padding-bottom: 8px;
}
.step{
  flex: 1;
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 14px 14px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--panel);
  transition: all .18s ease;
  min-width: 180px;
}
.step.active{
  border-color: var(--brand-2);
  background: rgba(59,130,246,.08);
}
.step .dot{
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display:grid;
  place-items:center;
  font-weight: 900;
  color: var(--muted);
  background: var(--panel-2);
  transition: all .18s ease;
  flex-shrink: 0;
}
.step.active .dot{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  transform: scale(1.06);
}
.step .meta{ line-height:1.2; overflow:hidden; }
.step .meta b{ font-size: 14px; font-weight:800; display:block; }
.step .meta span{ display:block; font-size: 12px; color: var(--muted); font-weight: 500; margin-top:2px; }

.mode-cards{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
.mode{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 18px;
  background: var(--panel);
  cursor:pointer;
  transition:all .18s ease;
  display:flex;
  gap: 14px;
  align-items:flex-start;
}
.mode:hover{ transform: translateY(-2px); border-color: var(--brand-2); box-shadow: var(--shadow-md); }
.mode.selected{ border-color: var(--brand-2); background: rgba(59,130,246,.08); }
.mode .radio{
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--muted);
  margin-top: 2px;
  position: relative;
  flex-shrink: 0;
}
.mode.selected .radio{ border-color: var(--brand-2); background: var(--brand-2); }
.mode.selected .radio::after{ content:""; position:absolute; inset:4px; border-radius:50%; background:#fff; }
.mode h3{ margin:0; font-size: 15px; font-weight: 800; }
.mode p{ margin:6px 0 0 0; font-size: 13px; color: var(--muted); font-weight: 500; line-height:1.5; }

.fields{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.field.full{ grid-column: 1 / -1; }

/* Wizard loading progress */
.wiz-loading{
  width: 100%;
  display:none;
  gap: 10px;
  align-items:center;
}
.wiz-loading.show{ display:flex; }
.wiz-progress{
  flex: 1;
  height: 10px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 999px;
  overflow:hidden;
}
.wiz-progress > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand-3));
  transition: width .14s linear;
}
.wiz-pct{
  font-family: 'Roboto Mono', monospace;
  font-variant-numeric: tabular-nums;
  font-size: 12px;
  font-weight: 800;
  color: var(--muted);
  width: 56px;
  text-align:right;
}

/* =========================================================
  QUIZ
========================================================= */
.view{ display:none; animation: fadeIn .22s ease; }
.view.show{ display:block; }

.quiz-layout{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap: 24px;
  align-items:start;
  min-height: calc(100vh - 160px);
}
.qnav{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  height: calc(100vh - 200px);
  position: sticky;
  top: 100px;
}
.qnav-head{
  padding: 16px 16px 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
}
.qnav-title{ font-weight:900; font-size: 15px; }
.qnav-stats{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
.qnav-stat{ font-size: 12px; font-weight: 600; color: var(--muted); display:flex; align-items:center; gap: 4px; }
.qnav-stat .count{ font-weight:900; color: var(--text); }
.qnav-grid{
  padding: 14px;
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  overflow-y:auto;
  flex:1;
}
.qnav-btn{
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: 12px;
  padding: 10px 0;
  font-weight: 800;
  font-size: 13px;
  cursor:pointer;
  transition: all .12s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: 44px;
  aspect-ratio: 1;
  outline:none;
}
.qnav-btn:focus-visible{ box-shadow: var(--focus-ring); border-color: var(--brand-2); }
.qnav-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.qnav-btn.current{ border-color: var(--brand-2); box-shadow: 0 0 0 3px rgba(59,130,246,.10); }

.qnav-btn.unanswered{ background: var(--panel); }
.qnav-btn.answered{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.25); color: var(--brand); }
.qnav-btn.correct{ background: var(--success-bg); border-color: rgba(16,185,129,.30); color: var(--success); }
.qnav-btn.wrong{ background: var(--danger-bg); border-color: rgba(239,68,68,.30); color: var(--danger); }

.qnav-legend{
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  background: var(--panel);
}
.qnav-legend .leg{
  font-size: 12px;
  font-weight: 600;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background:var(--panel);
  display:flex;
  align-items:center;
  gap: 6px;
}
.qnav-legend .leg::before{
  content:"";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display:block;
}
.qnav-legend .unanswered::before{ background: var(--panel-2); border:1px solid var(--border); }
.qnav-legend .answered::before{ background: rgba(59,130,246,.35); }
.qnav-legend .correct::before{ background: var(--success); }
.qnav-legend .wrong::before{ background: var(--danger); }

.quiz-shell{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height: calc(100vh - 160px);
}
.quiz-top{
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap: 12px;
  background: var(--panel);
}
.quiz-top-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.q-counter{
  font-weight: 900;
  font-size: 18px;
  color: var(--brand);
  background: rgba(59,130,246,.10);
  padding: 8px 14px;
  border-radius: 12px;
  border: 1px solid rgba(59,130,246,.20);
}
.q-mini{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
  color: var(--muted);
  font-weight: 600;
  font-size: 13px;
}
.q-mini .sep{ opacity:.35; }
.timer-fixed{
  font-family:'Roboto Mono', monospace;
  font-variant-numeric: tabular-nums;
  min-width: 92px;
  text-align: right;
  font-weight: 800;
  font-size: 13px;
  color: var(--brand);
  background: rgba(59,130,246,.10);
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid rgba(59,130,246,.20);
}

.progress{
  width:100%;
  height:8px;
  background: var(--panel-2);
  border-radius: 999px;
  overflow:hidden;
  border:1px solid var(--border);
}
.progress > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand-3));
  border-radius: 999px;
  transition: width .22s ease;
}

.quiz-body{
  padding: 22px 22px 18px 22px;
  background: var(--panel);
  flex:1;
  overflow-y:auto;
  min-height:0;
}
.quiz-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 14px;
  border-bottom: 1px solid var(--border);
}
.quiz-header-left{
  display:flex;
  align-items:center;
  gap: 12px;
  flex:1;
}
.star-btn{
  background:none;
  border:none;
  cursor:pointer;
  padding: 8px;
  border-radius: 10px;
  color: var(--muted);
  font-size: 20px;
  transition: all .16s ease;
  width: 40px;
  height: 40px;
}
.star-btn:hover{ background: rgba(245,158,11,.12); color: var(--warning); }
.star-btn:focus-visible{ outline:none; box-shadow: var(--focus-ring); }
.star-btn.active{ color: var(--warning); background: rgba(245,158,11,.16); }

.q-id{ color: var(--brand-2); font-weight: 900; font-size: 16px; display:flex; align-items:center; gap: 10px; }
.q-id .difficulty{
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  font-weight: 800;
  color: var(--text);
}
.quiz-header-right{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-shrink:0;
}

.q-text{
  margin: 0 0 18px 0;
  font-size: 16px;
  font-weight: 600;
  line-height: 1.65;
  color: var(--text);
  white-space: pre-wrap;
}

.result-indicator{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  border:1px solid var(--border);
}
.result-indicator.correct{ background: var(--success-bg); color: var(--success); border-color: rgba(16,185,129,.30); }
.result-indicator.incorrect{ background: var(--danger-bg); color: var(--danger); border-color: rgba(239,68,68,.30); }

.opts{ display:flex; flex-direction:column; gap: 12px; margin-top: 10px; }

/* op√ß√µes agora com RADIO REAL */
.opt{
  display:flex;
  gap: 14px;
  align-items:flex-start;
  padding: 16px 16px;
  border-radius: 16px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor:pointer;
  transition: all .16s ease;
  position:relative;
}
.opt:hover{ border-color: var(--brand-2); box-shadow: var(--shadow-sm); }
.opt.selected{ border-color: var(--brand-2); background: rgba(59,130,246,.08); }
.opt.correct{ border-color: var(--success); background: var(--success-bg); }
.opt.wrong{ border-color: var(--danger); background: var(--danger-bg); }
.opt.excluded{ opacity:.45; text-decoration: line-through; background: var(--panel-2); cursor:not-allowed; }

.opt input[type="radio"]{
  margin-top: 3px;
  accent-color: var(--brand-2);
  width: 18px;
  height: 18px;
  flex: 0 0 auto;
}
.opt .txt{
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.55;
  white-space: pre-wrap;
  flex: 1;
}
.opt .letter{ font-weight: 900; color: var(--brand); margin-right: 8px; }

.opt .exclude-btn{
  background:none;
  border:none;
  cursor:pointer;
  padding: 4px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 18px;
  transition: all .14s ease;
  flex-shrink:0;
  width: 34px; height: 34px;
  display:grid;
  place-items:center;
}
.opt .exclude-btn:hover{ color: var(--danger); background: rgba(239,68,68,.10); }
.opt.excluded .exclude-btn{ color: var(--danger); }
.opt.excluded .exclude-btn:hover{ color: var(--success); background: rgba(16,185,129,.10); }

.explanation-box{
  margin-top: 18px;
  padding: 18px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: var(--panel-2);
  display:none;
}
.explanation-box.show{ display:block; }
.explanation-title{ font-size: 15px; font-weight: 900; margin: 0 0 10px 0; display:flex; align-items:center; gap: 10px; }
.explanation-content{ font-size: 15px; font-weight: 600; line-height:1.6; }

.quiz-foot{
  padding: 16px 18px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  background: var(--panel);
  position: sticky;
  bottom: 0;
}
.navigation-buttons{ display:flex; align-items:center; gap: 12px; flex:1; }
.finish-button{ display:flex; align-items:center; gap: 12px; }

/* =========================================================
  HISTORY / STATS helpers
========================================================= */
.tabs{
  display:flex;
  gap: 4px;
  background: var(--panel-2);
  border-radius: 12px;
  padding: 4px;
  margin: 24px 0;
  flex-wrap: wrap;
}
.tab{
  flex: 1;
  padding: 12px 20px;
  text-align:center;
  font-weight: 800;
  font-size: 13px;
  color: var(--muted);
  cursor:pointer;
  border-radius: 10px;
  transition: all .16s ease;
  min-width: 120px;
}
.tab:hover{ background: rgba(59,130,246,.06); }
.tab.active{ background: var(--panel); color: var(--brand); box-shadow: var(--shadow-sm); }

.chart-container{
  margin: 24px 0;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px;
}
.chart-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}
.chart-title{ font-weight: 900; margin: 0; font-size: 16px; }
.chart-selector{ display:flex; gap: 8px; flex-wrap:wrap; }
.chart-selector button{
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel);
  font-weight: 800;
  font-size: 12px;
  cursor: pointer;
  transition: all .14s ease;
  color: var(--text);
}
.chart-selector button.active{
  background: rgba(59,130,246,.10);
  border-color: rgba(59,130,246,.35);
  color: var(--brand);
}
.chart-bar{ margin-bottom: 12px; }
.bar-label{ display:flex; justify-content:space-between; margin-bottom: 8px; font-size: 13px; font-weight: 700; }
.bar-container{
  height: 22px;
  background: var(--panel-2);
  border-radius: 999px;
  overflow:hidden;
  position: relative;
  border: 1px solid var(--border);
}
.bar-fill{
  height: 100%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand));
  border-radius: 999px;
  transition: width .4s ease;
  min-width: 24px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right: 10px;
  color: #fff;
  font-size: 12px;
  font-weight: 900;
}
.bar-fill.worst{ background: linear-gradient(90deg, #EF4444, #DC2626); }

.stat-item{
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
}
.stat-item h4{
  margin: 0 0 8px 0;
  font-size: 12px;
  font-weight: 900;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.stat-item p{ margin:0; font-size: 16px; font-weight: 900; }

.review-buttons{ display:flex; gap: 12px; flex-wrap:wrap; margin-top: 16px; }

/* =========================================================
  LOADING / ERROR
========================================================= */
.loading{
  display:grid;
  place-items:center;
  padding: 60px;
  color: var(--muted);
  min-height: 200px;
}
.loading::after{
  content:"";
  width: 40px; height:40px;
  border: 3px solid var(--border);
  border-top-color: var(--brand-2);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to{ transform:rotate(360deg)} }

.error-card{
  background: var(--danger-bg);
  border: 1px solid rgba(239,68,68,.60);
  border-radius: var(--radius-lg);
  padding: 22px;
  text-align:center;
  margin: 24px 0;
}
.error-title{ color: var(--danger); font-weight: 900; font-size: 16px; margin: 0 0 10px 0; }

/* =========================================================
  LOGIN (reduzir fric√ß√£o)
========================================================= */
.login-shell{
  width: min(900px, calc(100% - 32px));
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
  align-items: stretch;
}
.login-left{
  border-radius: 20px;
  padding: 40px 34px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
  color:#fff;
  box-shadow: var(--shadow-lg);
  display:flex;
  flex-direction: column;
  justify-content: center;
}
.login-left h1{ margin:0; font-size: 30px; font-weight: 900; letter-spacing:-0.4px; line-height:1.2; }
.login-left p{ margin: 14px 0 0 0; color: rgba(255,255,255,0.92); font-weight: 600; line-height:1.6; font-size: 14px; }

.login-right{
  border-radius: 20px;
  background: var(--panel);
  box-shadow: var(--shadow-lg);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.login-right .head{
  padding: 26px 26px 16px 26px;
  border-bottom: 1px solid var(--border);
}
.login-right .head b{ font-size: 20px; font-weight: 900; display:block; margin-bottom: 6px; }
.login-right .body{ padding: 22px 26px; flex:1; }
.login-right .foot{
  padding: 18px 26px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.login-micro{ font-size: 13px; font-weight:600; color: var(--muted); margin-top: 6px; }

/* =========================================================
  RESPONSIVIDADE
========================================================= */
@media (max-width: 1024px){
  .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  .home-grid{ grid-template-columns: 1fr; }
  .quiz-layout{ grid-template-columns: 1fr; }
  .qnav{ position: static; height:auto; max-height: 360px; order:2; }
}
@media (max-width: 768px){
  .topbar-inner{ flex-direction:column; gap: 10px; padding: 12px 0; height:auto; }
  .nav{ width:100%; justify-content:center; gap: 14px; flex-wrap: wrap; }
  .hero-banner{ padding: 28px 22px; }
  .hero-title{ font-size: 24px; }
  .hero-sub{ font-size: 14px; }
  .grid{ grid-template-columns: 1fr; }
  .mode-cards{ grid-template-columns: 1fr; }
  .fields{ grid-template-columns: 1fr; }
  .login-shell{ grid-template-columns: 1fr; }
  .navigation-buttons,.finish-button{ width: 100%; }
  .btn{ width:100%; }
}
@media (max-width: 480px){
  .wrap{ width: calc(100% - 24px); }
  .qnav-grid{ grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>

<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand" aria-label="Simulador de Certifica√ß√µes">
      <div class="logo">Q</div>
      Simulador de Certifica√ß√µes
    </div>
    <nav class="nav" aria-label="Navega√ß√£o principal">
      <a href="#" id="navHome" class="active">Dashboard</a>
      <a href="#" id="navQuiz">Simulado</a>
      <a href="#" id="navHistory">Hist√≥rico</a>
      <a href="#" id="navStats">Estat√≠sticas</a>
      <a href="#" id="navManuals">Manuais</a>
    </nav>
    <div class="top-actions">
      <div class="pill" id="pillUser">‚Äî</div>
      <button class="btn ghost small" id="btnLogout" type="button">Sair</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section class="view show" id="viewHome">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Simulador de Certifica√ß√µes</h1>
        <div class="hero-sub">
          Prepare-se para a PQO com foco em desempenho: acerto, tempo e t√≥picos cr√≠ticos.
        </div>
      </div>
    </div>

    <div id="homeDashboard"></div>

    <h2 class="section-title">Certifica√ß√µes Dispon√≠veis <span class="muted" id="certCount">(1)</span></h2>
    <div class="grid" id="coursesGrid"></div>
  </section>

  <!-- QUIZ -->
  <section class="view" id="viewQuiz">
    <div class="quiz-layout">
      <aside class="qnav" aria-label="Navega√ß√£o de quest√µes">
        <div class="qnav-head">
          <div class="qnav-title">Quest√µes</div>
          <div class="qnav-stats" aria-live="polite">
            <div class="qnav-stat"><span class="count" id="statTotal">0</span> total</div>
            <div class="qnav-stat"><span class="count" id="statAnswered">0</span> respondidas</div>
            <div class="qnav-stat"><span class="count" id="statCorrect">0</span> corrigidas</div>
            <div class="qnav-stat"><span class="count" id="statRight">0</span> ‚úÖ</div>
            <div class="qnav-stat"><span class="count" id="statWrong">0</span> ‚ùå</div>
          </div>
        </div>
        <div class="qnav-grid" id="qnavGrid"></div>
        <div class="qnav-legend" aria-hidden="true">
          <span class="leg unanswered">N√£o respondida</span>
          <span class="leg answered">Respondida</span>
          <span class="leg correct">Acertou</span>
          <span class="leg wrong">Errou</span>
        </div>
      </aside>

      <div class="quiz-shell">
        <div class="quiz-top">
          <div class="quiz-top-row">
            <div class="q-counter" id="qCounter">1/0</div>
            <div class="q-mini">
              <span class="timer-fixed" id="qTimer">00:00</span><span class="sep">‚Ä¢</span>
              <span id="qCourseName">‚Äî</span><span class="sep">‚Ä¢</span>
              <span id="qMeta">‚Äî</span>
              <span id="qLimitPill" class="result-indicator" style="display:none;">‚è≥ 03:00:00</span>
            </div>
          </div>
          <div class="progress" aria-label="Progresso do simulado">
            <div id="progressBar"></div>
          </div>
        </div>

        <div class="quiz-body">
          <div class="quiz-header">
            <div class="quiz-header-left">
              <button class="star-btn" id="btnStar" type="button" title="Marcar para revis√£o" aria-label="Marcar para revis√£o">‚òÜ</button>
              <div class="q-id">
                <span id="qId">#‚Äî</span>
                <span class="difficulty" id="qDifficulty">‚Äî</span>
              </div>
            </div>
            <div class="quiz-header-right">
              <div class="q-mini" id="qStatus" aria-live="polite"></div>
              <button class="btn ghost small" id="btnToggleExplanation" type="button" style="display:none;">üìò Explica√ß√£o</button>
            </div>
          </div>

          <p class="q-text" id="qText">‚Äî</p>

          <div class="opts" id="qOptions" role="radiogroup" aria-label="Alternativas"></div>

          <div class="explanation-box" id="explanationBox" aria-live="polite">
            <h3 class="explanation-title">Explica√ß√£o</h3>
            <p class="explanation-content" id="explanationText"></p>
          </div>
        </div>

        <div class="quiz-foot">
          <div class="navigation-buttons">
            <button class="btn" id="btnPrev" type="button">‚Üê Anterior</button>
            <button class="btn primary" id="btnCorrect" type="button" disabled>‚úì Corrigir</button>
            <button class="btn" id="btnNext" type="button">Pr√≥xima ‚Üí</button>
          </div>
          <div class="finish-button">
            <button class="btn danger" id="btnFinish" type="button">Finalizar Simulado</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section class="view" id="viewHistory">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Hist√≥rico de Simulados</h1>
        <div class="hero-sub">Acompanhe seu progresso e revise quest√µes j√° respondidas.</div>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Hist√≥rico">
      <div class="tab active" data-tab="history" role="tab" tabindex="0" aria-selected="true">Simulados Completos</div>
      <div class="tab" data-tab="bookmarks" role="tab" tabindex="0" aria-selected="false">Quest√µes Marcadas</div>
      <div class="tab" data-tab="wrong" role="tab" tabindex="0" aria-selected="false">Erros para Revisar</div>
    </div>
    <div id="historyContent"></div>
  </section>

  <!-- ESTAT√çSTICAS -->
  <section class="view" id="viewStats">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Dashboard de Desempenho</h1>
        <div class="hero-sub">Indicadores que orientam decis√£o de estudo: acerto, tempo e t√≥picos cr√≠ticos.</div>
      </div>
    </div>
    <div class="card" style="margin: 18px 0;">
      <div class="card-head">
        <div>
          <b style="font-size:16px; font-weight:900;">Exportar Dados</b>
          <div class="muted">Exporte seu hist√≥rico para an√°lise externa ou backup.</div>
        </div>
      </div>
      <div class="card-body" style="display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnExportCSV" type="button">üìä Exportar CSV</button>
        <button class="btn ghost" id="btnExportJSON" type="button">üìù Exportar JSON</button>
        <button class="btn ghost" id="btnExportPDF" type="button" disabled>üìÑ Exportar PDF (em breve)</button>
      </div>
    </div>
    <div id="statsContent"></div>
  </section>

  <!-- MANUAIS -->
  <section class="view" id="viewManuals">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Manuais</h1>
        <div class="hero-sub">Acesse materiais oficiais (ex.: Guia Por Dentro da B3).</div>
      </div>
    </div>
    <div class="card" style="height: calc(100vh - 200px);">
      <div class="card-head">
        <div>
          <b style="font-size: 15px; font-weight:900;">üìò GUIA POR DENTRO DA B3 (2024)</b>
          <div class="muted">Visualize no navegador ou abra em uma nova aba.</div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a class="btn ghost small" id="btnOpenManualNewTab" href="#" target="_blank" rel="noopener">üîó Abrir</a>
          <a class="btn primary small" id="btnDownloadManual" href="#" download>‚¨áÔ∏è Baixar</a>
        </div>
      </div>
      <div class="card-body" style="padding:0; height:100%;">
        <iframe class="manual-iframe" id="manualIframe" title="Manual B3" style="width:100%; height:100%; border:0; background:var(--panel);"></iframe>
      </div>
    </div>
  </section>
</main>

<!-- LOGIN -->
<div class="backdrop show" id="loginBackdrop" aria-hidden="false">
  <div class="login-shell" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="login-left">
      <h1>Bem-vindo üëã</h1>
      <p>Entre para acessar simulados, hist√≥rico, revis√£o de erros e m√©tricas de estudo.</p>
      <p style="margin-top:16px; font-size:13px; opacity:.92;">
        üîê Seus dados ficam apenas neste navegador (modo local).
      </p>
    </div>
    <div class="login-right">
      <div class="head">
        <b id="loginTitle">Login</b>
        <div class="login-micro">Acesso local para iniciar ‚Äî sem servidor</div>
      </div>
      <div class="body">
        <div class="field" id="fieldUser">
          <label for="loginUser">Usu√°rio</label>
          <input id="loginUser" type="text" placeholder="Ex.: Gustavo" autocomplete="username" />
          <div class="error" id="errUser">Digite um usu√°rio (ex.: Gustavo).</div>
        </div>

        <div class="field" id="fieldPass" style="margin-top:12px;">
          <label for="loginPass">Senha</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          <div class="error" id="errPass">Digite uma senha (qualquer uma serve no modo local).</div>
        </div>

        <div class="field full" style="margin-top:12px;">
          <label style="display:flex;align-items:center;gap:10px;font-weight:600;color:var(--text);">
            <input type="checkbox" id="rememberMe" checked />
            Lembrar neste dispositivo
          </label>
          <div class="hint">Primeiro acesso? Qualquer usu√°rio/senha funciona.</div>
        </div>

        <div class="toast show info" id="loginMsg">‚ö° Dica: escolha o curso e a configura√ß√£o abre automaticamente.</div>
      </div>
      <div class="foot">
        <div class="muted" id="loginInfo">Acesso local ‚Ä¢ sem servidor</div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WIZARD MODAL -->
<div class="backdrop" id="wizardBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
    <div class="modal-head">
      <div>
        <h2 id="wizTitle">Configurar Simulado</h2>
        <div class="muted" id="wizSub">Personalize seu simulado</div>
      </div>
      <button class="btn ghost small" id="btnCloseWizard" type="button" aria-label="Fechar">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="steps">
        <div class="step active" id="step1">
          <div class="dot">1</div>
          <div class="meta"><b>Modalidade</b><span>Prova ou Personalizado</span></div>
        </div>
        <div class="step" id="step2">
          <div class="dot">2</div>
          <div class="meta"><b>Configura√ß√µes</b><span>Quantidade e tempo</span></div>
        </div>
        <div class="step" id="step3" style="display:none;">
          <div class="dot">3</div>
          <div class="meta"><b>Filtros</b><span>Ajuste sua base</span></div>
        </div>
        <div class="step" id="step4">
          <div class="dot">4</div>
          <div class="meta"><b>Revis√£o</b><span>Confirmar e iniciar</span></div>
        </div>
      </div>

      <!-- PAGE 1 -->
      <div class="wiz-page" id="wizPage1">
        <div class="muted" style="margin-bottom:16px;">
          Curso selecionado: <b id="wizCourseName" style="color:var(--brand);">‚Äî</b>
        </div>
        <div class="mode-cards">
          <div class="mode selected" data-mode="exam" role="button" tabindex="0" aria-pressed="true">
            <div class="radio"></div>
            <div>
              <h3>Modo Prova</h3>
              <p>60 quest√µes ‚Ä¢ 3h ‚Ä¢ sem filtros avan√ßados.</p>
            </div>
          </div>
          <div class="mode" data-mode="custom" role="button" tabindex="0" aria-pressed="false">
            <div class="radio"></div>
            <div>
              <h3>Personalizado</h3>
              <p>Quantidade + filtros reais (m√≥dulo/cap√≠tulo/tema/dificuldade/busca).</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div class="wiz-page" id="wizPage2" style="display:none;">
        <div class="muted" style="margin-bottom:16px;">Configura√ß√µes gerais:</div>
        <div class="fields">
          <div class="field" id="fieldQty">
            <label for="selQty">Quantidade de quest√µes</label>
            <select id="selQty">
              <option value="5">5 quest√µes (r√°pido)</option>
              <option value="10">10 quest√µes</option>
              <option value="20">20 quest√µes</option>
              <option value="30">30 quest√µes</option>
              <option value="40">40 quest√µes</option>
              <option value="50">50 quest√µes</option>
              <option value="60" selected>60 quest√µes (prova completa)</option>
            </select>
            <div class="hint" id="qtyHint">No modo prova: 60 fixas.</div>
          </div>

          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:600;color:var(--text);">
              <input id="chkNoRepeat" type="checkbox" checked />
              Evitar quest√µes j√° acertadas
            </label>
            <div class="hint">Remove quest√µes que voc√™ j√° acertou anteriormente.</div>
          </div>

          <div class="field full" id="durationField">
            <label style="display:flex;align-items:center;gap:10px;font-weight:600;color:var(--text);">
              <input id="chkOfficialDuration" type="checkbox" />
              Dura√ß√£o oficial da prova (3h)
            </label>
            <div class="hint">Se marcado, ao atingir 03:00:00 o simulado encerra automaticamente.</div>
          </div>
        </div>
      </div>

      <!-- PAGE 3 -->
      <div class="wiz-page" id="wizPage3" style="display:none;">
        <div class="muted" style="margin-bottom:16px;">Filtros (apenas no Personalizado):</div>

        <div class="fields">
          <div class="field">
            <label for="selTheme">Tema</label>
            <select id="selTheme"></select>
          </div>
          <div class="field">
            <label for="selLevel">Dificuldade</label>
            <select id="selLevel"></select>
          </div>

          <div class="field">
            <label>M√≥dulos</label>
            <div class="card" style="max-height:200px; overflow:auto; padding:10px;" id="listModule"></div>
            <div class="hint">Selecione um ou mais.</div>
          </div>
          <div class="field">
            <label>Cap√≠tulos</label>
            <div class="card" style="max-height:200px; overflow:auto; padding:10px;" id="listChapter"></div>
            <div class="hint">Se nenhum for marcado, considera todos.</div>
          </div>

          <div class="field full">
            <label for="searchText">Busca por texto</label>
            <input id="searchText" type="text" placeholder="Ex.: CCP, nova√ß√£o, margem, op√ß√µes..." />
            <div class="hint">Busca no enunciado, alternativas e explica√ß√£o.</div>
          </div>

          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:600;color:var(--text);">
              <input id="chkDistEnable" type="checkbox" />
              Distribuir quest√µes por estrutura oficial (opcional)
            </label>
            <div class="hint">A distribui√ß√£o s√≥ atua no modo Personalizado.</div>
          </div>
        </div>

        <div class="toast show info" id="filterInfo" style="margin-top:16px;">‚Äî</div>

        <div class="card" id="distBox" style="display:none; margin-top:16px;">
          <div class="card-head">
            <div>
              <b style="font-weight:900;">üìä Distribui√ß√£o por T√≠tulo/Cap√≠tulo</b>
              <div class="muted">Use quantidade ou percentual. O sistema ajusta para fechar o total.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <label class="pill" style="padding:8px 12px; border-radius:999px;">
                <input type="radio" name="distMode" id="distModeQty" checked />
                <span style="font-size:13px; font-weight:800;">Quantidade</span>
              </label>
              <label class="pill" style="padding:8px 12px; border-radius:999px;">
                <input type="radio" name="distMode" id="distModePct" />
                <span style="font-size:13px; font-weight:800;">Percentual</span>
              </label>
              <span id="distSumBadge" class="result-indicator">‚Äî</span>
            </div>
          </div>
          <div class="card-body">
            <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
              <table class="table" style="margin:0;">
                <thead>
                  <tr>
                    <th>T√≠tulo / Cap√≠tulo</th>
                    <th style="width:180px;" id="distColTitle">Quantidade</th>
                  </tr>
                </thead>
                <tbody id="distRows"></tbody>
              </table>
            </div>
            <div style="margin-top:10px; display:flex; justify-content:center;">
              <button class="btn ghost small" id="btnAutoFill" type="button">üîÑ Preencher com distribui√ß√£o oficial</button>
            </div>
            <div class="muted" id="distNote" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <!-- PAGE 4 -->
      <div class="wiz-page" id="wizPage4" style="display:none;">
        <div class="muted" style="margin-bottom:16px;">Revise antes de iniciar:</div>
        <div class="card">
          <div class="card-body">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:18px;">
              <div>
                <h3 style="margin:0 0 6px 0; color:var(--brand);" id="confirmTitle">Simulado</h3>
                <div class="muted" id="confirmDetails">‚Äî</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:34px; font-weight:900; color:var(--brand-2);" id="confirmQty">0</div>
                <div class="muted">quest√µes</div>
              </div>
            </div>
            <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
              <div class="muted" style="margin-bottom:10px;">Configura√ß√µes aplicadas:</div>
              <div id="confirmFilters" style="font-size:14px; font-weight:600; line-height:1.6;"></div>
            </div>
          </div>
        </div>
        <div class="toast show info" style="margin-top:16px;">‚≠ê Voc√™ pode marcar quest√µes para revisar depois.</div>
      </div>
    </div>

    <div class="modal-foot">
      <div class="muted" id="wizFooter">Selecione o tipo de simulado</div>

      <div class="wiz-loading" id="wizLoading" aria-live="polite">
        <div class="wiz-progress" aria-label="Carregando">
          <div id="wizProgressFill"></div>
        </div>
        <div class="wiz-pct" id="wizProgressPct">0%</div>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn" id="btnPrevStep" type="button" disabled>‚Üê Voltar</button>
        <button class="btn primary" id="btnNextStep" type="button">Continuar ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE RESULTADOS -->
<div class="backdrop" id="resultsBackdrop" aria-hidden="true">
  <div class="modal" style="max-width:900px;" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
    <div class="modal-head">
      <h2 id="resultsTitle">Resultado do Simulado</h2>
      <button class="btn ghost small" id="btnCloseResults" type="button" aria-label="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="resultsContent"></div>
    </div>
    <div class="modal-foot">
      <div class="muted" id="resultsFooter">Tempo total: 00:00</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnReviewAll" type="button">üìö Revisar Simulado</button>
        <button class="btn ghost" id="btnReviewWrong" type="button">üìù Revisar Erros</button>
        <button class="btn ghost" id="btnExportResult" type="button">üìä Exportar</button>
        <button class="btn primary" id="btnNewSimulado" type="button">üîÑ Novo Simulado</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST GLOBAL -->
<div id="globalToast" style="position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); z-index: 2000; width: min(600px, calc(100% - 32px)); display: none;">
  <div id="globalToastInner" class="toast show info" style="display:block; margin:0;"></div>
</div>

<script>
;(() => {
  'use strict';

  // =========================================================
  // HELPERS
  // =========================================================
  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelectorAll(sel);
  const qs = (sel) => document.querySelector(sel);

  const clamp = (n,min,max) => Math.max(min, Math.min(max, n));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeHtmlAttr(s){ return escapeHtml(s); }

  // Toast global
  let toastTimer = null;
  function showToast(msg, type='info', ms=2400){
    const wrap = $("globalToast");
    const inner = $("globalToastInner");
    inner.className = `toast show ${type}`;
    inner.innerHTML = msg;
    wrap.style.display = "block";
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { wrap.style.display="none"; }, ms);
    return inner;
  }

  // =========================================================
  // STORAGE KEYS
  // =========================================================
  const LS_AUTH = "sim_auth_v5";
  const LS_HIST = "sim_hist_v5";
  const LS_SESS = "sim_sess_v5";
  const LS_BOOK = "sim_book_v5";
  const LS_STATS = "sim_stats_v5";
  const LS_EXCLUDED = "sim_excluded_v3"; // Alterada para v3

  // =========================================================
  // ESTRUTURA OFICIAL DA PROVA - PQO
  // =========================================================
  const examStructure = {
    "T√çTULO I ‚Äì Aspectos institucionais (10%)": {
      weight: 10,
      chapters: {
        "Cap√≠tulo I ‚Äì Sistema Financeiro Nacional (3%)": 3,
        "Cap√≠tulo II ‚Äì Infraestrutura do mercado (4%)": 4,
        "Cap√≠tulo III ‚Äì A B3 no mercado financeiro e de capitais (3%)": 3
      }
    },
    "T√çTULO II ‚Äì Mercados de bolsa e de balc√£o (35%)": {
      weight: 35,
      chapters: {
        "Cap√≠tulo I ‚Äì Mercado de renda vari√°vel (6%)": 6,
        "Cap√≠tulo II ‚Äì Mercado de derivativos (10%)": 10,
        "Cap√≠tulo III ‚Äì Mercado de renda fixa (5%)": 5,
        "Cap√≠tulo IV ‚Äì Mercado de c√¢mbio (3%)": 3,
        "Cap√≠tulo V ‚Äì Fundos de investimento (5%)": 5,
        "Cap√≠tulo VI ‚Äì Clubes de investimento (2%)": 2,
        "Cap√≠tulo VII ‚Äì Outros ativos e servi√ßos (2%)": 2,
        "Cap√≠tulo VIII ‚Äì Tributa√ß√£o do mercado financeiro (2%)": 2
      }
    },
    "T√çTULO III ‚Äì Estrutura de contas e cadastro (3%)": {
      weight: 3,
      chapters: {
        "Cap√≠tulo I ‚Äì Cadastro de investidores residentes (2%)": 2,
        "Cap√≠tulo II ‚Äì Cadastro de investidores n√£o residentes (1%)": 1
      }
    },
    "T√çTULO IV ‚Äì Gest√£o de risco (22%)": {
      weight: 22,
      chapters: {
        "Cap√≠tulo I ‚Äì Gest√£o de risco na C√¢mara (14%)": 14,
        "Cap√≠tulo II ‚Äì Risco corporativo e controles internos (8%)": 8
      }
    },
    "T√çTULO V ‚Äì Negocia√ß√£o (8%)": {
      weight: 8,
      chapters: {
        "Cap√≠tulo I ‚Äì Mercados organizados (5%)": 5,
        "Cap√≠tulo II ‚Äì Ambiente de negocia√ß√£o (3%)": 3
      }
    },
    "T√çTULO VI ‚Äì C√¢mara de compensa√ß√£o e liquida√ß√£o (17%)": {
      weight: 17,
      chapters: { "Cap√≠tulo I ‚Äì C√¢mara B3 (17%)": 17 }
    },
    "T√çTULO VII ‚Äì Central deposit√°ria (3%)": {
      weight: 3,
      chapters: { "Cap√≠tulo I ‚Äì Central deposit√°ria da B3 (3%)": 3 }
    },
    "T√çTULO VIII ‚Äì Compliance (2%)": {
      weight: 2,
      chapters: {
        "Cap√≠tulo I ‚Äì PLD/FTP (0,8%)": 0.8,
        "Cap√≠tulo II ‚Äì Prote√ß√£o de dados pessoais e privacidade (0,4%)": 0.4,
        "Cap√≠tulo III ‚Äì Adequa√ß√£o ao perfil do cliente ‚Äì Suitability (0,4%)": 0.4,
        "Cap√≠tulo IV ‚Äì Opera√ß√µes il√≠citas (0,4%)": 0.4
      }
    }
  };

  // =========================================================
  // CONFIG
  // =========================================================
  const MANUAL_PDF = "./GUIA_POR_DENTRO_DA_B3_2024_final-min%201.pdf";

  const courses = [
    {
      id: "PQO",
      name: "PQO - Programa de Qualifica√ß√£o Operacional",
      desc: "Preparat√≥rio completo para a certifica√ß√£o PQO com quest√µes atualizadas do mercado financeiro.",
      jsonUrl: "./QuestoesPQO.json",
      tag: "Dispon√≠vel",
      color: "#3B82F6",
      icon: "üìà",
      stats: { questions: 0, modules: 0 }
    }
  ];

  let selectedCourse = null;
  let currentUser = null;

  // =========================================================
  // AUTH
  // =========================================================
  class AuthManager {
    static getAuth() {
      try {
        let auth = JSON.parse(localStorage.getItem(LS_AUTH) || "null");
        if (!auth) auth = JSON.parse(sessionStorage.getItem(LS_AUTH) || "null");
        if (auth && Date.now() - auth.at < 30 * 24 * 60 * 60 * 1000) return auth;
      } catch {}
      return null;
    }
    static setAuth(user, remember = true) {
      const auth = { user, at: Date.now(), session: Date.now().toString(36)+Math.random().toString(36).slice(2) };
      if (remember) localStorage.setItem(LS_AUTH, JSON.stringify(auth));
      else sessionStorage.setItem(LS_AUTH, JSON.stringify(auth));
      return auth;
    }
    static clearAuth() {
      localStorage.removeItem(LS_AUTH);
      sessionStorage.removeItem(LS_AUTH);
    }
    static requireLogin() {
      const auth = AuthManager.getAuth();
      if (auth?.user) {
        currentUser = auth.user;
        $("loginBackdrop").classList.remove("show");
        $("loginBackdrop").setAttribute("aria-hidden","true");
        $("pillUser").textContent = auth.user;
        return true;
      }
      $("loginBackdrop").classList.add("show");
      $("loginBackdrop").setAttribute("aria-hidden","false");
      $("pillUser").textContent = "‚Äî";
      return false;
    }
  }

  // =========================================================
  // STATS
  // =========================================================
  class StatsManager {
    static getHistory() {
      try { return JSON.parse(localStorage.getItem(LS_HIST) || "[]"); }
      catch { return []; }
    }
    static addSession(session) {
      const history = StatsManager.getHistory();
      history.unshift({ id: Date.now().toString(36)+Math.random().toString(36).slice(2), ...session, completedAt: Date.now() });
      if (history.length > 80) history.length = 80;
      localStorage.setItem(LS_HIST, JSON.stringify(history));
      return history;
    }
    static getQuestionStats() {
      try { return JSON.parse(localStorage.getItem(LS_STATS) || "{}"); }
      catch { return {}; }
    }
    static updateQuestionStats(questionId, correct, timeSpent=0) {
      const stats = StatsManager.getQuestionStats();
      if (!stats[questionId]) stats[questionId] = { attempts:0, correct:0, totalTime:0, lastAttempt: Date.now() };
      stats[questionId].attempts++;
      stats[questionId].totalTime += timeSpent;
      stats[questionId].lastAttempt = Date.now();
      if (correct) stats[questionId].correct++;
      localStorage.setItem(LS_STATS, JSON.stringify(stats));
      return stats[questionId];
    }
    static getWeakAreas(limit=5) {
      const stats = StatsManager.getQuestionStats();
      const areas = {};
      Object.entries(stats).forEach(([id,data]) => {
        // fallback simples: agrupar por prefixo/tema quando existir
        const area = id.split('-').slice(0,3).join('-') || id;
        if (!areas[area]) areas[area] = { attempts:0, correct:0 };
        areas[area].attempts += data.attempts;
        areas[area].correct += data.correct;
      });
      return Object.entries(areas)
        .map(([area,data]) => ({ area, attempts: data.attempts, accuracy: data.attempts ? (data.correct/data.attempts)*100 : 0 }))
        .sort((a,b)=>a.accuracy-b.accuracy)
        .slice(0, limit);
    }
  }

  // =========================================================
  // BOOKMARKS
  // =========================================================
  class BookmarkManager {
    static getBookmarks() {
      try { return JSON.parse(localStorage.getItem(LS_BOOK) || "[]"); }
      catch { return []; }
    }
    static toggleBookmark(questionId) {
      const arr = BookmarkManager.getBookmarks();
      const idx = arr.indexOf(questionId);
      if (idx === -1) arr.push(questionId);
      else arr.splice(idx,1);
      localStorage.setItem(LS_BOOK, JSON.stringify(arr));
      return idx === -1;
    }
    static isBookmarked(questionId) {
      return BookmarkManager.getBookmarks().includes(questionId);
    }
  }

  // =========================================================
  // EXCLUSIONS (MODIFICADO PARA ISOLAR POR SESS√ÉO)
  // =========================================================
  class ExclusionManager {
    static getExclusions(sessionId = '') {
      try {
        const all = JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
        // Se n√£o houver sessionId, retorna vazio (evita "vazamento")
        return sessionId ? (all[sessionId] || {}) : {};
      } catch {
        return {};
      }
    }

    static toggleExclusion(sessionId, questionId, optionLetter) {
      const all = JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
      if (!all[sessionId]) all[sessionId] = {};
      if (!all[sessionId][questionId]) all[sessionId][questionId] = [];

      const idx = all[sessionId][questionId].indexOf(optionLetter);
      if (idx === -1) {
        all[sessionId][questionId].push(optionLetter);
      } else {
        all[sessionId][questionId].splice(idx, 1);
      }

      localStorage.setItem(LS_EXCLUDED, JSON.stringify(all));
      return idx === -1;
    }

    static getExcludedOptions(sessionId, questionId) {
      const all = JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
      return (all[sessionId] && all[sessionId][questionId]) || [];
    }

    static clearSessionExclusions(sessionId) {
      const all = JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
      delete all[sessionId];
      localStorage.setItem(LS_EXCLUDED, JSON.stringify(all));
    }

    static cleanupOldSessions(maxAgeHours = 24) {
      const all = JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
      const now = Date.now();
      const maxAge = maxAgeHours * 60 * 60 * 1000;
      let changed = false;
      
      Object.keys(all).forEach(sessionId => {
        // Se a sessionId √© um timestamp, podemos verificar se √© antigo
        // Mas para simplificar, vamos manter apenas sess√µes ativas
        // Nesta implementa√ß√£o, n√£o vamos limpar automaticamente
      });
      
      if (changed) {
        localStorage.setItem(LS_EXCLUDED, JSON.stringify(all));
      }
    }
  }

  // =========================================================
  // SESSION
  // =========================================================
  class SessionManager {
    static saveSession(session){ localStorage.setItem(LS_SESS, JSON.stringify(session)); }
    static getSession(){
      try {
        const s = JSON.parse(localStorage.getItem(LS_SESS) || "null");
        if (s && Date.now() - s.startedAt < 24*60*60*1000) return s;
      } catch {}
      return null;
    }
    static clearSession(){ localStorage.removeItem(LS_SESS); }
  }

  // =========================================================
  // DB
  // =========================================================
  const db = { all:[], modules:[], chapters:[], themes:[], levels:[], courseId:null };

  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  }

  async function loadCourseDb(course) {
    const res = await fetch(course.jsonUrl, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("Formato inv√°lido: esperado array");

    const questions = data.map((q, index) => {
      const id = String(q.id || `Q${index+1}`).trim();
      const questionText = String(q.q || "").trim();
      const options = q.options && typeof q.options === "object" ? q.options : {};
      const answer = String(q.answer || "").trim().toUpperCase();
      const explain = String(q.explain || "").trim();
      const module = String(q.module || "").trim();
      const chapter = String(q.chapter || "").trim();
      const theme = String(q.theme || "").trim();
      const level = String(q.level || "").trim();

      // normaliza alternativas A-D (aceita A..E mas o layout suporta qualquer chave do objeto)
      const optKeys = Object.keys(options).sort();
      return {
        id,
        q: questionText,
        options,
        optKeys,
        answer,
        explain,
        module,
        chapter,
        theme,
        level,
      };
    });

    db.all = questions;
    db.courseId = course.id;
    db.modules = uniqueSorted(questions.map(q => q.module));
    db.chapters = uniqueSorted(questions.map(q => q.chapter));
    db.themes = uniqueSorted(questions.map(q => q.theme));
    db.levels = uniqueSorted(questions.map(q => q.level));

    // stats do curso
    course.stats.questions = questions.length;
    course.stats.modules = db.modules.length;

    return db;
  }

  // =========================================================
  // UI: NAV
  // =========================================================
  const views = {
    home: $("viewHome"),
    quiz: $("viewQuiz"),
    history: $("viewHistory"),
    stats: $("viewStats"),
    manuals: $("viewManuals"),
  };

  function setActiveNav(navId){
    ["navHome","navQuiz","navHistory","navStats","navManuals"].forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.classList.toggle("active", id===navId);
    });
  }

  function showView(name){
    Object.values(views).forEach(v => v.classList.remove("show"));
    views[name].classList.add("show");
  }

  // =========================================================
  // DASHBOARD HOME
  // =========================================================
  function renderHomeDashboard(){
    const hist = StatsManager.getHistory();
    const qsStats = StatsManager.getQuestionStats();
    const totalAttempts = Object.values(qsStats).reduce((s,x)=>s+(x.attempts||0),0);
    const totalCorrect = Object.values(qsStats).reduce((s,x)=>s+(x.correct||0),0);
    const acc = totalAttempts ? Math.round((totalCorrect/totalAttempts)*100) : 0;

    const last = hist[0];
    const lastInfo = last
      ? `${new Date(last.completedAt).toLocaleString("pt-BR")} ‚Ä¢ ${last.courseName || "‚Äî"} ‚Ä¢ ${last.correct || 0}/${last.total || 0}`
      : "Nenhum simulado finalizado ainda.";

    const weak = StatsManager.getWeakAreas(5);

    $("homeDashboard").innerHTML = `
      <div class="kpi-grid">
        <div class="kpi">
          <div class="label">Acur√°cia geral</div>
          <div class="value">${acc}%</div>
          <div class="sub"><span class="trend ${acc>=70?'up':acc>=50?'flat':'down'}">‚óè</span>base: ${totalAttempts} tentativas</div>
        </div>
        <div class="kpi">
          <div class="label">Simulados</div>
          <div class="value">${hist.length}</div>
          <div class="sub"><span class="trend flat">‚óè</span>√∫ltimo: ${escapeHtml(lastInfo)}</div>
        </div>
        <div class="kpi">
          <div class="label">Quest√µes √∫nicas</div>
          <div class="value">${Object.keys(qsStats).length}</div>
          <div class="sub"><span class="trend flat">‚óè</span>com estat√≠sticas</div>
        </div>
        <div class="kpi">
          <div class="label">Marcadas</div>
          <div class="value">${BookmarkManager.getBookmarks().length}</div>
          <div class="sub"><span class="trend flat">‚óè</span>para revis√£o</div>
        </div>
      </div>

      <div class="home-grid">
        <div>
          <table class="table" aria-label="√Åreas fracas (heur√≠stica)">
            <thead>
              <tr><th>√Årea (heur√≠stica)</th><th>Tentativas</th><th>Acur√°cia</th></tr>
            </thead>
            <tbody>
              ${
                weak.length
                  ? weak.map(w => `
                    <tr>
                      <td><b>${escapeHtml(w.area)}</b></td>
                      <td>${w.attempts}</td>
                      <td>${Math.round(w.accuracy)}%</td>
                    </tr>
                  `).join("")
                  : `<tr><td colspan="3" class="muted">Sem dados suficientes ainda.</td></tr>`
              }
            </tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-head">
            <div>
              <b style="font-size:16px; font-weight:900;">Resumo r√°pido</b>
              <div class="muted">Dicas para hoje</div>
            </div>
          </div>
          <div class="card-body">
            <div class="mini-list">
              <div class="mini-item">
                <div>
                  <b>‚≠ê Marque e revise</b>
                  <small>Use a estrela para guardar quest√µes dif√≠ceis.</small>
                </div>
                <div class="chip">Revis√£o</div>
              </div>
              <div class="mini-item">
                <div>
                  <b>üß† Erros primeiro</b>
                  <small>Na tela de resultados, revise s√≥ os erros.</small>
                </div>
                <div class="chip">Foco</div>
              </div>
              <div class="mini-item">
                <div>
                  <b>‚è±Ô∏è Tempo</b>
                  <small>Ative "dura√ß√£o oficial" para treinar prova.</small>
                </div>
                <div class="chip">Prova</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // =========================================================
  // COURSES GRID
  // =========================================================
  function renderCourses(){
    $("certCount").textContent = `(${courses.length})`;
    const qsStats = StatsManager.getQuestionStats();

    $("coursesGrid").innerHTML = courses.map(c => {
      // progresso: % de quest√µes com pelo menos 1 acerto
      const ids = Object.keys(qsStats);
      // heur√≠stica simples: se id existir em stats e correct>0
      let correctCount = 0;
      ids.forEach(id => { if (qsStats[id]?.correct>0) correctCount++; });
      const pct = db.courseId === c.id && db.all.length ? Math.round((correctCount/db.all.length)*100) : 0;

      return `
        <div class="course-card" data-course="${escapeHtmlAttr(c.id)}" tabindex="0" role="button" aria-label="Selecionar ${escapeHtmlAttr(c.name)}">
          <div class="progress-ring" title="Progresso (heur√≠stico)">${clamp(pct,0,100)}%</div>
          <div class="thumb">
            <div class="label">${escapeHtml(c.tag)}</div>
            <div style="font-size:44px;">${escapeHtml(c.icon)}</div>
          </div>
          <div class="course-body">
            <h3 class="course-name">${escapeHtml(c.name)}</h3>
            <p class="course-desc">${escapeHtml(c.desc)}</p>
            <div class="course-meta">
              <span>üìå <b>${c.stats.questions || "‚Äî"}</b> quest√µes</span>
              <span>üìö <b>${c.stats.modules || "‚Äî"}</b> m√≥dulos</span>
            </div>
            <div class="course-foot">
              <span class="chip">Abrir</span>
              <span class="muted">Clique para configurar</span>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // =========================================================
  // WIZARD (CONFIG)
  // =========================================================
  const wizard = {
    step: 1,
    mode: "exam", // exam | custom
    qty: 60,
    noRepeatCorrect: true,
    officialDuration: false,
    filters: {
      theme: "ALL",
      level: "ALL",
      modules: new Set(),
      chapters: new Set(),
      search: "",
      distEnable: false,
      distMode: "qty", // qty | pct
      distMap: {} // key -> number (qty or pct)
    }
  };

  function openWizard(course){
    selectedCourse = course;
    $("wizardBackdrop").classList.add("show");
    $("wizardBackdrop").setAttribute("aria-hidden","false");

    $("wizCourseName").textContent = course.name;
    $("wizSub").textContent = "Personalize seu simulado";

    wizard.step = 1;
    wizard.mode = "exam";
    wizard.qty = 60;
    wizard.noRepeatCorrect = true;
    wizard.officialDuration = false;
    wizard.filters = {
      theme: "ALL",
      level: "ALL",
      modules: new Set(),
      chapters: new Set(),
      search: "",
      distEnable: false,
      distMode: "qty",
      distMap: {}
    };

    // UI reset
    setWizardStep(1, true);
    $("selQty").value = "60";
    $("chkNoRepeat").checked = true;
    $("chkOfficialDuration").checked = false;
    $("searchText").value = "";
    $("chkDistEnable").checked = false;
    $("distBox").style.display = "none";
    $("distModeQty").checked = true;
    $("distModePct").checked = false;
    updateDistUI();
    fillFilterSelects();
    renderModuleChapterLists();
    updateFilterInfo();
  }

  function closeWizard(){
    $("wizardBackdrop").classList.remove("show");
    $("wizardBackdrop").setAttribute("aria-hidden","true");
  }

  function setWizardStep(step, silent=false){
    wizard.step = step;

    // steps visuais
    ["step1","step2","step3","step4"].forEach((id, idx)=>{
      const el = $(id);
      if (!el) return;
      el.classList.toggle("active", (idx+1)===step);
    });

    // page show/hide
    $("wizPage1").style.display = step===1 ? "" : "none";
    $("wizPage2").style.display = step===2 ? "" : "none";
    $("wizPage3").style.display = step===3 ? "" : "none";
    $("wizPage4").style.display = step===4 ? "" : "none";

    // step3 s√≥ aparece no modo custom
    $("step3").style.display = wizard.mode === "custom" ? "" : "none";

    // bot√µes
    $("btnPrevStep").disabled = step===1;
    $("btnNextStep").textContent = step===4 ? "Iniciar Simulado ‚úÖ" : "Continuar ‚Üí";

    // footer
    const footTxt = {
      1: "Selecione o tipo de simulado",
      2: "Defina quantidade e comportamento",
      3: "Aplique filtros (opcional)",
      4: "Revise antes de iniciar",
    };
    $("wizFooter").textContent = footTxt[step] || "‚Äî";

    // ajustes do modo exam vs custom
    const isExam = wizard.mode === "exam";
    $("qtyHint").textContent = isExam ? "No modo prova: 60 fixas." : "Escolha a quantidade desejada.";
    $("selQty").disabled = isExam;
    if (isExam) $("selQty").value = "60";
    $("durationField").style.display = ""; // mant√©m nos 2 modos
    if (!silent) updateConfirm();
  }

  function setMode(mode){
    wizard.mode = mode;
    $$(".mode").forEach(m=>{
      const ok = m.getAttribute("data-mode")===mode;
      m.classList.toggle("selected", ok);
      m.setAttribute("aria-pressed", ok ? "true" : "false");
    });
    // step3 depende do modo
    if (wizard.mode === "exam" && wizard.step === 3) setWizardStep(4);
    setWizardStep(wizard.step, true);
    updateConfirm();
  }

  function fillFilterSelects(){
    // Tema
    const themeSel = $("selTheme");
    themeSel.innerHTML = `<option value="ALL">Todos</option>` + db.themes.map(t=>`<option value="${escapeHtmlAttr(t)}">${escapeHtml(t)}</option>`).join("");

    // Dificuldade
    const levelSel = $("selLevel");
    levelSel.innerHTML = `<option value="ALL">Todas</option>` + db.levels.map(l=>`<option value="${escapeHtmlAttr(l)}">${escapeHtml(l)}</option>`).join("");
  }

  function renderModuleChapterLists(){
    const wrapM = $("listModule");
    const wrapC = $("listChapter");
    wrapM.innerHTML = db.modules.map(m => {
      const id = "m_"+Math.random().toString(36).slice(2);
      return `
        <label style="display:flex; gap:10px; padding:8px 8px; border-radius:10px; cursor:pointer;">
          <input type="checkbox" data-type="module" data-val="${escapeHtmlAttr(m)}" />
          <span style="font-weight:700;">${escapeHtml(m)}</span>
        </label>
      `;
    }).join("") || `<div class="muted">Sem m√≥dulos encontrados.</div>`;

    wrapC.innerHTML = db.chapters.map(c => `
      <label style="display:flex; gap:10px; padding:8px 8px; border-radius:10px; cursor:pointer;">
        <input type="checkbox" data-type="chapter" data-val="${escapeHtmlAttr(c)}" />
        <span style="font-weight:700;">${escapeHtml(c)}</span>
      </label>
    `).join("") || `<div class="muted">Sem cap√≠tulos encontrados.</div>`;
  }

  function updateFilterInfo(){
    const f = wizard.filters;
    const mods = f.modules.size ? `${f.modules.size} m√≥dulo(s)` : "todos os m√≥dulos";
    const chaps = f.chapters.size ? `${f.chapters.size} cap√≠tulo(s)` : "todos os cap√≠tulos";
    const theme = f.theme==="ALL" ? "todos os temas" : `tema: ${f.theme}`;
    const level = f.level==="ALL" ? "todas as dificuldades" : `dificuldade: ${f.level}`;
    const search = f.search ? `busca: "${f.search}"` : "sem busca por texto";
    const dist = f.distEnable ? `distribui√ß√£o: ON (${f.distMode})` : "distribui√ß√£o: OFF";

    $("filterInfo").innerHTML = `üß© Filtros atuais: <b>${escapeHtml(theme)}</b> ‚Ä¢ <b>${escapeHtml(level)}</b> ‚Ä¢ <b>${escapeHtml(mods)}</b> ‚Ä¢ <b>${escapeHtml(chaps)}</b> ‚Ä¢ <b>${escapeHtml(search)}</b> ‚Ä¢ <b>${escapeHtml(dist)}</b>`;
    updateConfirm();
  }

  // =========================================================
  // DISTRIBUI√á√ÉO (T√çTULO/CAP√çTULO)
  // =========================================================
  function getStructureRows(){
    // retorna array de linhas: t√≠tulos e cap√≠tulos (como itens)
    const rows = [];
    Object.entries(examStructure).forEach(([title, tdata]) => {
      rows.push({ key: title, type:"title", weight: tdata.weight });
      Object.entries(tdata.chapters).forEach(([chap, w]) => {
        rows.push({ key: chap, type:"chapter", weight: w, parent: title });
      });
    });
    return rows;
  }

  function updateDistUI(){
    const enabled = $("chkDistEnable").checked;
    $("distBox").style.display = enabled ? "" : "none";
    wizard.filters.distEnable = enabled;

    const mode = $("distModePct").checked ? "pct" : "qty";
    wizard.filters.distMode = mode;

    // header col
    $("distColTitle").textContent = mode === "pct" ? "Percentual (%)" : "Quantidade";

    const rows = getStructureRows();
    const tbody = $("distRows");
    tbody.innerHTML = rows.map(r=>{
      const v = wizard.filters.distMap[r.key] ?? "";
      const isTitle = r.type==="title";
      return `
        <tr>
          <td style="${isTitle?'font-weight:900;':'font-weight:700;'}">
            ${escapeHtml(r.key)}
          </td>
          <td>
            <input
              class="dist-input"
              data-key="${escapeHtmlAttr(r.key)}"
              type="number"
              min="0"
              step="${mode==='pct'?'0.1':'1'}"
              value="${v!=="" ? escapeHtmlAttr(v) : ""}"
              placeholder="${mode==='pct' ? r.weight : ""}"
              style="width: 140px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); outline:none; font-weight:800;"
            />
          </td>
        </tr>
      `;
    }).join("");

    // soma badge
    computeDistBadge();
    updateDistNote();
  }

  function updateDistNote(){
    const mode = wizard.filters.distMode;
    const note = mode === "pct"
      ? "Dica: some 100% (t√≠tulos+cap√≠tulos). O sistema ajusta o restante automaticamente ao iniciar."
      : "Dica: some a quantidade total. O sistema ajusta automaticamente para fechar a quantidade do simulado.";
    $("distNote").textContent = note;
  }

  function computeDistBadge(){
    const mode = wizard.filters.distMode;
    const sum = Object.values(wizard.filters.distMap).reduce((s,v)=>s+(Number(v)||0),0);
    if (mode === "pct"){
      const ok = Math.abs(sum - 100) < 0.01;
      $("distSumBadge").className = `result-indicator ${ok?'correct':'incorrect'}`;
      $("distSumBadge").textContent = `Œ£ ${sum.toFixed(1)}%`;
    } else {
      $("distSumBadge").className = `result-indicator`;
      $("distSumBadge").textContent = `Œ£ ${Math.round(sum)} itens`;
    }
  }

  function autoFillOfficialDist(){
    // preenche com pesos oficiais: t√≠tulos e cap√≠tulos
    const mode = wizard.filters.distMode;
    const rows = getStructureRows();
    wizard.filters.distMap = {};

    if (mode === "pct"){
      rows.forEach(r => {
        wizard.filters.distMap[r.key] = Number(r.weight);
      });
    } else {
      // qty: usa a quantidade selecionada e distribui proporcionalmente ao peso (cap√≠tulos primeiro)
      const total = wizard.mode === "exam" ? 60 : Number($("selQty").value || 60);
      const chapRows = rows.filter(r=>r.type==="chapter");
      const weights = chapRows.map(r => r.weight);
      const wsum = weights.reduce((s,x)=>s+x,0) || 1;

      // distribui√ß√£o inteira com arredondamento
      let allocated = 0;
      const base = chapRows.map(r => {
        const raw = (r.weight/wsum) * total;
        const q = Math.floor(raw);
        allocated += q;
        return { key: r.key, raw, q };
      });

      // distribui o resto pelos maiores "decimais"
      let rest = total - allocated;
      base
        .sort((a,b)=>(b.raw-b.q)-(a.raw-a.q))
        .forEach(x=>{
          if (rest>0){
            x.q += 1; rest -= 1;
          }
        });

      base.forEach(x => wizard.filters.distMap[x.key] = x.q);

      // t√≠tulos ficam em branco no qty
      rows.filter(r=>r.type==="title").forEach(r => { wizard.filters.distMap[r.key] = ""; });
    }

    updateDistUI();
    showToast("Distribui√ß√£o oficial aplicada ‚úÖ","ok");
  }

  // =========================================================
  // CONFIRM PAGE
  // =========================================================
  function updateConfirm(){
    if (!selectedCourse) return;

    const isExam = wizard.mode === "exam";
    const qty = isExam ? 60 : Number($("selQty").value || 60);

    wizard.qty = qty;
    wizard.noRepeatCorrect = $("chkNoRepeat").checked;
    wizard.officialDuration = $("chkOfficialDuration").checked;

    const parts = [];
    parts.push(isExam ? "Modo Prova" : "Personalizado");
    parts.push(`${qty} quest√µes`);
    parts.push(wizard.noRepeatCorrect ? "evitar j√° acertadas" : "permitir repeti√ß√£o");
    parts.push(wizard.officialDuration ? "dura√ß√£o oficial (3h)" : "sem tempo limite");

    $("confirmTitle").textContent = `${selectedCourse.name}`;
    $("confirmDetails").textContent = parts.join(" ‚Ä¢ ");
    $("confirmQty").textContent = qty;

    const f = wizard.filters;
    const lines = [];

    lines.push(`‚Ä¢ Curso: <b>${escapeHtml(selectedCourse.name)}</b>`);
    lines.push(`‚Ä¢ Modo: <b>${escapeHtml(isExam ? "Prova" : "Personalizado")}</b>`);
    lines.push(`‚Ä¢ Quantidade: <b>${qty}</b>`);
    lines.push(`‚Ä¢ Evitar j√° acertadas: <b>${wizard.noRepeatCorrect ? "Sim" : "N√£o"}</b>`);
    lines.push(`‚Ä¢ Dura√ß√£o oficial (3h): <b>${wizard.officialDuration ? "Sim" : "N√£o"}</b>`);

    if (!isExam){
      lines.push(`‚Ä¢ Tema: <b>${escapeHtml(f.theme==="ALL"?"Todos":f.theme)}</b>`);
      lines.push(`‚Ä¢ Dificuldade: <b>${escapeHtml(f.level==="ALL"?"Todas":f.level)}</b>`);
      lines.push(`‚Ä¢ M√≥dulos: <b>${f.modules.size?escapeHtml(Array.from(f.modules).join(" | ")):"Todos"}</b>`);
      lines.push(`‚Ä¢ Cap√≠tulos: <b>${f.chapters.size?escapeHtml(Array.from(f.chapters).join(" | ")):"Todos"}</b>`);
      lines.push(`‚Ä¢ Busca: <b>${f.search?escapeHtml(f.search):"‚Äî"}</b>`);
      lines.push(`‚Ä¢ Distribui√ß√£o oficial: <b>${f.distEnable ? ("Sim ("+escapeHtml(f.distMode)+")") : "N√£o"}</b>`);
    } else {
      lines.push(`‚Ä¢ Filtros: <b>desabilitados no modo prova</b>`);
    }

    $("confirmFilters").innerHTML = lines.join("<br/>");
  }

  // =========================================================
  // QUIZ ENGINE (MODIFICADO PARA USAR SESSION ID)
  // =========================================================
  const quiz = {
    active: false,
    course: null,
    questions: [],
    idx: 0,
    answers: {},        // qid -> { chosen:'A', corrected:true, correct:true, timeSpentMs }
    startedAt: 0,
    qStartedAt: 0,
    totalTimer: null,
    tickTimer: null,
    elapsedMs: 0,
    limitMs: 0,
    reviewMode: "all",  // all | wrong
    sessionId: "",      // ID √∫nico para esta sess√£o
  };

  function formatMs(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = String(Math.floor(s/3600)).padStart(2,"0");
    const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function formatMinSec(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  function questionMatchesSearch(q, term){
    if (!term) return true;
    const t = term.toLowerCase();
    const hay = [
      q.q,
      q.explain,
      q.module,
      q.chapter,
      q.theme,
      q.level,
      ...Object.values(q.options||{})
    ].join("\n").toLowerCase();
    return hay.includes(t);
  }

  function filterQuestionsBase(){
    const isExam = wizard.mode==="exam";
    let pool = db.all.slice();

    if (!isExam){
      const f = wizard.filters;
      if (f.theme !== "ALL") pool = pool.filter(x => x.theme === f.theme);
      if (f.level !== "ALL") pool = pool.filter(x => x.level === f.level);
      if (f.modules.size) pool = pool.filter(x => f.modules.has(x.module));
      if (f.chapters.size) pool = pool.filter(x => f.chapters.has(x.chapter));
      if (f.search) pool = pool.filter(x => questionMatchesSearch(x, f.search));
    }

    // Evitar j√° acertadas
    if ($("chkNoRepeat").checked){
      const stats = StatsManager.getQuestionStats();
      pool = pool.filter(q => !(stats[q.id]?.correct > 0));
    }

    return pool;
  }

  function pickRandom(arr, n){
    const a = arr.slice();
    for (let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a.slice(0, n);
  }

  function applyDistribution(pool, total){
    // se n√£o habilitado, retorna random
    const f = wizard.filters;
    if (!f.distEnable) return pickRandom(pool, total);

    const mode = f.distMode; // qty | pct
    const distMap = f.distMap || {};

    // distribui√ß√£o por cap√≠tulo (preferencial)
    const wantByChapter = {};
    if (mode === "pct"){
      // converte percentuais em quantidades (cap√≠tulos apenas, se existirem; sen√£o usa t√≠tulos)
      const rows = getStructureRows();
      const chapKeys = rows.filter(r=>r.type==="chapter").map(r=>r.key);
      const hasChap = chapKeys.some(k => Number(distMap[k])>0);

      const targets = [];
      if (hasChap){
        chapKeys.forEach(k => {
          const pct = Number(distMap[k]) || 0;
          targets.push({ key:k, pct });
        });
      } else {
        // fallback para t√≠tulos
        rows.filter(r=>r.type==="title").forEach(r => {
          const pct = Number(distMap[r.key]) || 0;
          targets.push({ key:r.key, pct, isTitle:true });
        });
      }

      // normaliza soma (se usu√°rio colocou qualquer coisa)
      const sumPct = targets.reduce((s,x)=>s+x.pct,0) || 0;
      targets.forEach(t => {
        const eff = sumPct ? (t.pct/sumPct)*100 : 0;
        wantByChapter[t.key] = (eff/100)*total; // float
      });

      // arredonda
      const list = Object.entries(wantByChapter).map(([k,v])=>({k, raw:v, q:Math.floor(v)}));
      let allocated = list.reduce((s,x)=>s+x.q,0);
      let rest = total - allocated;
      list.sort((a,b)=> (b.raw-b.q)-(a.raw-a.q)).forEach(x=>{
        if (rest>0){ x.q+=1; rest-=1; }
      });
      list.forEach(x => wantByChapter[x.k]=x.q);

    } else {
      // qty
      Object.entries(distMap).forEach(([k,v])=>{
        const n = Number(v);
        if (!Number.isFinite(n)) return;
        if (n>0) wantByChapter[k] = Math.floor(n);
      });
    }

    // agora seleciona respeitando a distribui√ß√£o por chapter/title
    const selected = [];
    const used = new Set();

    const takeFrom = (subset, n) => {
      const pick = pickRandom(subset.filter(q => !used.has(q.id)), n);
      pick.forEach(q => { selected.push(q); used.add(q.id); });
      return pick.length;
    };

    // primeiro tenta por cap√≠tulo
    const rows = getStructureRows();
    const chapRows = rows.filter(r=>r.type==="chapter");
    const titleRows = rows.filter(r=>r.type==="title");

    let requested = 0;
    Object.entries(wantByChapter).forEach(([,v])=> requested += Number(v)||0);

    // se usu√°rio colocou mais/menos, ajusta total
    if (requested !== total && requested>0){
      // escala proporcionalmente
      const scale = total / requested;
      const items = Object.entries(wantByChapter).map(([k,v])=>({k, raw:v*scale, q:Math.floor(v*scale)}));
      let allocated = items.reduce((s,x)=>s+x.q,0);
      let rest = total - allocated;
      items.sort((a,b)=> (b.raw-b.q)-(a.raw-a.q)).forEach(x=>{
        if (rest>0){ x.q+=1; rest-=1; }
      });
      const nm = {};
      items.forEach(x=>nm[x.k]=x.q);
      Object.assign(wantByChapter, nm);
    }

    // aplicar: se existir keys de cap√≠tulos, prioriza cap√≠tulos
    let anyChap = chapRows.some(r => Number(wantByChapter[r.key])>0);
    if (anyChap){
      chapRows.forEach(r=>{
        const need = Number(wantByChapter[r.key])||0;
        if (!need) return;
        const subset = pool.filter(q => q.chapter === r.key);
        takeFrom(subset, need);
      });
    } else {
      // fallback: por t√≠tulos (mapeia t√≠tulo -> m√≥dulo/chapter via includes)
      titleRows.forEach(r=>{
        const need = Number(wantByChapter[r.key])||0;
        if (!need) return;
        const subset = pool.filter(q => (q.module && r.key.includes(q.module)) || (q.chapter && r.key.includes(q.chapter)) );
        takeFrom(subset, need);
      });
    }

    // completa o resto com aleat√≥rio
    if (selected.length < total){
      takeFrom(pool, total - selected.length);
    }

    return selected.slice(0,total);
  }

  function buildQuizQuestions(){
    const isExam = wizard.mode==="exam";
    const qty = isExam ? 60 : Number($("selQty").value || 60);
    const pool = filterQuestionsBase();

    if (!pool.length) return { ok:false, msg:"Nenhuma quest√£o encontrada com os filtros atuais." };

    const picked = isExam
      ? pickRandom(pool, Math.min(qty, pool.length))
      : applyDistribution(pool, Math.min(qty, pool.length));

    if (!picked.length) return { ok:false, msg:"N√£o foi poss√≠vel montar o simulado com a base atual." };

    return { ok:true, questions: picked };
  }

  function startQuiz(){
    const build = buildQuizQuestions();
    if (!build.ok){
      showToast(`‚ùå ${escapeHtml(build.msg)}`,"bad", 3400);
      return;
    }

    quiz.active = true;
    quiz.course = selectedCourse;
    quiz.questions = build.questions;
    quiz.idx = 0;
    quiz.answers = {};
    quiz.startedAt = Date.now();
    quiz.qStartedAt = Date.now();
    quiz.elapsedMs = 0;
    
    // GERAR UM ID √öNICO PARA ESTA SESS√ÉO
    quiz.sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2);

    quiz.limitMs = $("chkOfficialDuration").checked ? 3*60*60*1000 : 0;

    // LIMPAR EXCLUS√ïES DE SESS√ïES ANTIGAS (opcional)
    // ExclusionManager.clearSessionExclusions(quiz.sessionId);

    SessionManager.saveSession({
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      startedAt: quiz.startedAt,
      questions: quiz.questions.map(q=>q.id),
      answers: quiz.answers,
      idx: quiz.idx,
      limitMs: quiz.limitMs,
      sessionId: quiz.sessionId // Salvar tamb√©m na sess√£o
    });

    closeWizard();
    showView("quiz");
    setActiveNav("navQuiz");
    $("qCourseName").textContent = quiz.course.name;
    $("qLimitPill").style.display = quiz.limitMs ? "" : "none";
    if (quiz.limitMs) $("qLimitPill").textContent = `‚è≥ ${formatMs(quiz.limitMs)}`;

    buildQNav();
    renderQuestion();
    startTimers();
  }

  function resumeQuizIfAny(){
    const s = SessionManager.getSession();
    if (!s) return false;
    if (!db.all.length) return false;

    const qMap = new Map(db.all.map(q=>[q.id,q]));
    const qs = (s.questions || []).map(id=>qMap.get(id)).filter(Boolean);
    if (!qs.length) return false;

    quiz.active = true;
    quiz.course = courses.find(c=>c.id===s.courseId) || selectedCourse || courses[0];
    quiz.questions = qs;
    quiz.idx = clamp(Number(s.idx||0), 0, qs.length-1);
    quiz.answers = s.answers || {};
    quiz.startedAt = s.startedAt || Date.now();
    quiz.qStartedAt = Date.now();
    quiz.limitMs = Number(s.limitMs||0);
    quiz.sessionId = s.sessionId || Date.now().toString(36) + Math.random().toString(36).slice(2);

    showToast("üìå Sess√£o recuperada (√∫ltimas 24h).","info", 2800);
    showView("quiz");
    setActiveNav("navQuiz");
    $("qCourseName").textContent = quiz.course.name;
    $("qLimitPill").style.display = quiz.limitMs ? "" : "none";
    if (quiz.limitMs) $("qLimitPill").textContent = `‚è≥ ${formatMs(quiz.limitMs)}`;

    buildQNav();
    renderQuestion();
    startTimers();
    return true;
  }

  function stopTimers(){
    if (quiz.tickTimer) clearInterval(quiz.tickTimer);
    quiz.tickTimer = null;
  }

  function startTimers(){
    stopTimers();
    const started = Date.now();
    quiz.qStartedAt = Date.now();

    quiz.tickTimer = setInterval(()=>{
      // elapsed total
      quiz.elapsedMs = Date.now() - quiz.startedAt;
      $("qTimer").textContent = formatMinSec(quiz.elapsedMs);

      // time limit
      if (quiz.limitMs){
        const remain = quiz.limitMs - quiz.elapsedMs;
        $("qLimitPill").textContent = `‚è≥ ${formatMs(remain)}`;
        if (remain <= 0){
          finishQuiz(true);
        }
      }
    }, 500);
  }

  function buildQNav(){
    const total = quiz.questions.length;
    $("statTotal").textContent = total;

    const answered = Object.values(quiz.answers).filter(a => a?.chosen).length;
    const corrected = Object.values(quiz.answers).filter(a => a?.corrected).length;
    const right = Object.values(quiz.answers).filter(a => a?.correct===true).length;
    const wrong = Object.values(quiz.answers).filter(a => a?.correct===false).length;

    $("statAnswered").textContent = answered;
    $("statCorrect").textContent = corrected;
    $("statRight").textContent = right;
    $("statWrong").textContent = wrong;

    const grid = $("qnavGrid");
    grid.innerHTML = quiz.questions.map((q,i)=>{
      const a = quiz.answers[q.id];
      const cls = [
        "qnav-btn",
        i===quiz.idx ? "current" : "",
        a?.corrected ? (a.correct ? "correct" : "wrong") : (a?.chosen ? "answered" : "unanswered")
      ].filter(Boolean).join(" ");

      return `<button class="${cls}" type="button" data-idx="${i}" aria-label="Quest√£o ${i+1}">${i+1}</button>`;
    }).join("");
  }

  function updateProgress(){
    const total = quiz.questions.length;
    const corrected = Object.values(quiz.answers).filter(a => a?.corrected).length;
    const pct = total ? Math.round((corrected/total)*100) : 0;
    $("progressBar").style.width = `${pct}%`;
  }

  function renderQuestion(){
    const q = quiz.questions[quiz.idx];
    if (!q) return;

    // header
    $("qCounter").textContent = `${quiz.idx+1}/${quiz.questions.length}`;
    $("qId").textContent = `#${q.id}`;
    $("qDifficulty").textContent = q.level || "‚Äî";
    $("qMeta").textContent = [q.module,q.chapter,q.theme].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";

    // bookmark
    const starred = BookmarkManager.isBookmarked(q.id);
    $("btnStar").classList.toggle("active", starred);
    $("btnStar").textContent = starred ? "‚òÖ" : "‚òÜ";

    // status indicator
    const a = quiz.answers[q.id];
    if (a?.corrected){
      $("qStatus").innerHTML = a.correct
        ? `<span class="result-indicator correct">‚úÖ Acertou</span>`
        : `<span class="result-indicator incorrect">‚ùå Errou</span>`;
    } else if (a?.chosen){
      $("qStatus").innerHTML = `<span class="result-indicator">üìù Respondida</span>`;
    } else {
      $("qStatus").innerHTML = `<span class="result-indicator">‚è≥ Em aberto</span>`;
    }

    // text
    $("qText").textContent = q.q || "‚Äî";

    // explanation
    const showExpBtn = !!q.explain && (a?.corrected);
    $("btnToggleExplanation").style.display = showExpBtn ? "" : "none";
    $("explanationText").textContent = q.explain || "";
    $("explanationBox").classList.remove("show");

    // options
    // ALTERADO: Agora usa sessionId para isolar exclus√µes
    const excluded = ExclusionManager.getExcludedOptions(quiz.sessionId, q.id);
    const groupName = `opt_${q.id}`;
    const chosen = a?.chosen || "";

    $("qOptions").innerHTML = q.optKeys.map(letter=>{
      const text = String(q.options[letter] ?? "");
      const isExcluded = excluded.includes(letter);
      const selected = chosen === letter;

      let extraClass = "";
      if (a?.corrected){
        if (letter === q.answer) extraClass = "correct";
        else if (letter === chosen && chosen && chosen !== q.answer) extraClass = "wrong";
      } else {
        if (selected) extraClass = "selected";
      }

      return `
        <div class="opt ${extraClass} ${isExcluded?'excluded':''}" data-letter="${escapeHtmlAttr(letter)}" role="radio" aria-checked="${selected}">
          <input type="radio" name="${escapeHtmlAttr(groupName)}" ${selected?'checked':''} ${isExcluded?'disabled':''} />
          <div class="txt"><span class="letter">${escapeHtml(letter)})</span>${escapeHtml(text)}</div>
          <button class="exclude-btn" type="button" title="${isExcluded?'Reativar alternativa':'Eliminar alternativa'}" aria-label="${isExcluded?'Reativar alternativa':'Eliminar alternativa'}">${isExcluded?'‚Ü©':'‚úï'}</button>
        </div>
      `;
    }).join("");

    // corrigir bot√£o
    $("btnCorrect").disabled = !chosen || a?.corrected;

    // update nav + progress
    buildQNav();
    updateProgress();

    // reset start time da quest√£o
    quiz.qStartedAt = Date.now();
  }

  function setChosen(letter){
    const q = quiz.questions[quiz.idx];
    if (!q) return;
    const a = quiz.answers[q.id] || { chosen:"", corrected:false, correct:null, timeSpentMs:0 };

    // n√£o deixa trocar se j√° corrigiu
    if (a.corrected) return;

    a.chosen = letter;
    quiz.answers[q.id] = a;

    SessionManager.saveSession({
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      startedAt: quiz.startedAt,
      questions: quiz.questions.map(q=>q.id),
      answers: quiz.answers,
      idx: quiz.idx,
      limitMs: quiz.limitMs,
      sessionId: quiz.sessionId
    });

    $("btnCorrect").disabled = !letter;
    renderQuestion();
  }

  function correctCurrent(){
    const q = quiz.questions[quiz.idx];
    if (!q) return;
    const a = quiz.answers[q.id];
    if (!a?.chosen) return;
    if (a.corrected) return;

    // tempo gasto nesta quest√£o
    const spent = Date.now() - quiz.qStartedAt;
    a.timeSpentMs = (a.timeSpentMs||0) + spent;
    a.corrected = true;
    a.correct = a.chosen === q.answer;

    quiz.answers[q.id] = a;

    // stats global por quest√£o
    StatsManager.updateQuestionStats(q.id, a.correct, spent);

    // persist session
    SessionManager.saveSession({
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      startedAt: quiz.startedAt,
      questions: quiz.questions.map(q=>q.id),
      answers: quiz.answers,
      idx: quiz.idx,
      limitMs: quiz.limitMs,
      sessionId: quiz.sessionId
    });

    showToast(a.correct ? "‚úÖ Correto!" : "‚ùå Incorreto!", a.correct ? "ok" : "bad", 1200);

    renderQuestion();
  }

  function gotoIdx(i){
    quiz.idx = clamp(i, 0, quiz.questions.length-1);
    SessionManager.saveSession({
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      startedAt: quiz.startedAt,
      questions: quiz.questions.map(q=>q.id),
      answers: quiz.answers,
      idx: quiz.idx,
      limitMs: quiz.limitMs,
      sessionId: quiz.sessionId
    });
    renderQuestion();
  }

  function next(){
    gotoIdx(quiz.idx+1);
  }
  function prev(){
    gotoIdx(quiz.idx-1);
  }

  // =========================================================
  // RESULTADOS + FINALIZA√á√ÉO
  // =========================================================
  function openResults(){
    $("resultsBackdrop").classList.add("show");
    $("resultsBackdrop").setAttribute("aria-hidden","false");
  }
  function closeResults(){
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden","true");
  }

  function buildResultsHtml(session){
    const total = session.total || 0;
    const correct = session.correct || 0;
    const wrong = session.wrong || 0;
    const answered = session.answered || 0;
    const acc = total ? Math.round((correct/total)*100) : 0;

    const deg = clamp(Math.round((acc/100)*360), 0, 360);
    const donut = `<div class="donut" style="--deg:${deg}deg;">
      <div class="donut-center">
        <div><b>${acc}%</b></div>
        <span>Acur√°cia</span>
      </div>
    </div>`;

    const statsList = `
      <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:18px;">
        <div class="stat-item"><h4>Total</h4><p>${total}</p></div>
        <div class="stat-item"><h4>‚úÖ Acertos</h4><p>${correct}</p></div>
        <div class="stat-item"><h4>‚ùå Erros</h4><p>${wrong}</p></div>
      </div>
      <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; margin-top:12px;">
        <div class="stat-item"><h4>Respondidas</h4><p>${answered}</p></div>
        <div class="stat-item"><h4>Tempo total</h4><p>${formatMinSec(session.durationMs||0)}</p></div>
      </div>
    `;

    return `
      <div class="card">
        <div class="card-body">
          <div style="display:grid; grid-template-columns: 220px 1fr; gap:18px; align-items:center;">
            <div>${donut}</div>
            <div>
              <h3 style="margin:0; font-size:18px; font-weight:900;">${escapeHtml(session.courseName||"Simulado")}</h3>
              <div class="muted" style="margin-top:6px;">
                ${new Date(session.completedAt).toLocaleString("pt-BR")} ‚Ä¢
                ${escapeHtml(session.mode || "‚Äî")}
              </div>
              ${statsList}
            </div>
          </div>
        </div>
      </div>

      <div class="review-buttons">
        <div class="toast show info" style="display:block;">
          üí° Dica: clique em "Revisar Erros" para refor√ßar rapidamente.
        </div>
      </div>
    `;
  }

  function autoCorrectAllOnFinish({ updateStats = true } = {}){
    const now = Date.now();

    quiz.questions.forEach((q) => {
      let a = quiz.answers[q.id];

      // se nunca respondeu nada, cria estrutura
      if (!a) {
        a = { chosen: "", corrected: false, correct: null, timeSpentMs: 0 };
      }

      // se j√° estava corrigida, n√£o mexe
      if (a.corrected) {
        quiz.answers[q.id] = a;
        return;
      }

      // se escolheu alternativa, corrige
      if (a.chosen) {
        a.corrected = true;
        a.correct = (a.chosen === q.answer);

        // N√ÉO temos como saber tempo real aqui; mantemos 0
        a.timeSpentMs = a.timeSpentMs || 0;

        // opcional: registra tentativa no stats (sem tempo)
        if (updateStats) {
          StatsManager.updateQuestionStats(q.id, a.correct, 0);
        }
      } else {
        // n√£o respondeu -> conta como errada para resultado final
        a.corrected = true;
        a.correct = false;
        a.timeSpentMs = a.timeSpentMs || 0;
        // aqui eu recomendo N√ÉO registrar stats, pq n√£o houve tentativa real
      }

      quiz.answers[q.id] = a;
    });

    // persiste sess√£o (se ainda existir)
    SessionManager.saveSession({
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      startedAt: quiz.startedAt,
      questions: quiz.questions.map(q => q.id),
      answers: quiz.answers,
      idx: quiz.idx,
      limitMs: quiz.limitMs,
      sessionId: quiz.sessionId
    });
  }

  function finishQuiz(auto=false){
    if (!quiz.active) return;

    stopTimers();

    autoCorrectAllOnFinish({ updateStats: true });

    const total = quiz.questions.length;
    const vals = Object.values(quiz.answers);
    const answered = vals.filter(a => a?.chosen).length;
    const corrected = vals.filter(a => a?.corrected).length;
    const correct = vals.filter(a => a?.correct===true).length;
    const wrong = vals.filter(a => a?.correct===false).length;

    const session = {
      courseId: quiz.course.id,
      courseName: quiz.course.name,
      mode: wizard.mode === "exam" ? "Modo Prova" : "Personalizado",
      total,
      answered,
      corrected,
      correct,
      wrong,
      durationMs: Date.now() - quiz.startedAt,
      questions: quiz.questions.map(q=>q.id),
      answers: quiz.answers,
      completedAt: Date.now(),
      sessionId: quiz.sessionId // Incluir sessionId no hist√≥rico
    };

    StatsManager.addSession(session);
    SessionManager.clearSession();
    
    // LIMPAR EXCLUS√ïES DESTA SESS√ÉO (opcional, se quiser limpar ap√≥s finalizar)
    // ExclusionManager.clearSessionExclusions(quiz.sessionId);

    quiz.active = false;

    $("resultsContent").innerHTML = buildResultsHtml(session);
    $("resultsFooter").textContent = `Tempo total: ${formatMinSec(session.durationMs)}` + (auto ? " ‚Ä¢ encerrado por tempo" : "");
    openResults();

    // volta para home depois do modal? mantemos em quiz para revis√£o
    showToast("Simulado finalizado ‚úÖ","ok", 1600);
  }

  function setReviewMode(mode){
    // mode: all | wrong
    quiz.reviewMode = mode;

    if (mode === "wrong"){
      // filtra o set para apenas erradas (corrigidas e incorretas)
      const wrongIds = new Set(Object.entries(quiz.answers).filter(([,a])=>a?.corrected && a.correct===false).map(([id])=>id));
      const qMap = new Map(db.all.map(q=>[q.id,q]));
      const qs = Array.from(wrongIds).map(id=>qMap.get(id)).filter(Boolean);
      if (!qs.length){
        showToast("üéâ Nenhum erro para revisar.","ok");
        return;
      }
      quiz.questions = qs;
      quiz.idx = 0;
      buildQNav();
      renderQuestion();
      showToast("Modo revis√£o: apenas erros.","info");
    } else {
      // n√£o temos o snapshot do simulado finalizado aqui se quiz.active = false
      // ent√£o, se usu√°rio clicou revisar ap√≥s finalizar, reconstru√≠mos a partir do √∫ltimo hist√≥rico
      const hist = StatsManager.getHistory();
      const last = hist[0];
      if (!last) return;
      const qMap = new Map(db.all.map(q=>[q.id,q]));
      const qs = (last.questions||[]).map(id=>qMap.get(id)).filter(Boolean);
      quiz.questions = qs;
      quiz.answers = last.answers || {};
      quiz.idx = 0;
      quiz.active = false; // revis√£o p√≥s-prova
      buildQNav();
      renderQuestion();
      showToast("Modo revis√£o: simulado completo.","info");
    }
  }

  // =========================================================
  // HIST√ìRICO
  // =========================================================
  function renderHistoryTab(tab){
    const hist = StatsManager.getHistory();
    const bookmarks = BookmarkManager.getBookmarks();
    const qStats = StatsManager.getQuestionStats();

    if (tab === "history"){
      if (!hist.length){
        $("historyContent").innerHTML = `<div class="loading" style="min-height:140px;"></div><div class="muted" style="text-align:center; margin-top:-30px;">Sem simulados ainda.</div>`;
        return;
      }

      $("historyContent").innerHTML = hist.map(h=>{
        const acc = h.total ? Math.round((h.correct/h.total)*100) : 0;
        return `
          <div class="card" style="margin: 14px 0;">
            <div class="card-head">
              <div>
                <b style="font-weight:900;">${escapeHtml(h.courseName||"Simulado")}</b>
                <div class="muted">${new Date(h.completedAt).toLocaleString("pt-BR")} ‚Ä¢ ${escapeHtml(h.mode||"‚Äî")}</div>
              </div>
              <div class="chip">${acc}%</div>
            </div>
            <div class="card-body" style="display:flex; gap:14px; flex-wrap:wrap;">
              <span class="pill">Total: <b>${h.total}</b></span>
              <span class="pill">‚úÖ ${h.correct}</span>
              <span class="pill">‚ùå ${h.wrong}</span>
              <span class="pill">‚è±Ô∏è ${formatMinSec(h.durationMs||0)}</span>
              <button class="btn ghost small" data-action="review" data-id="${escapeHtmlAttr(h.id)}" type="button">üìö Revisar</button>
            </div>
          </div>
        `;
      }).join("");

      return;
    }

    if (tab === "bookmarks"){
      if (!bookmarks.length){
        $("historyContent").innerHTML = `<div class="muted" style="text-align:center; margin-top:18px;">Voc√™ n√£o tem quest√µes marcadas.</div>`;
        return;
      }
      const qMap = new Map(db.all.map(q=>[q.id,q]));
      const list = bookmarks.map(id=>qMap.get(id)).filter(Boolean);

      $("historyContent").innerHTML = `
        <div class="card" style="margin-top: 16px;">
          <div class="card-head">
            <div>
              <b style="font-weight:900;">Quest√µes marcadas</b>
              <div class="muted">${list.length} item(ns)</div>
            </div>
            <button class="btn ghost small" id="btnStartBookmarks" type="button">‚ñ∂Ô∏è Iniciar revis√£o</button>
          </div>
          <div class="card-body">
            ${list.map(q=>`
              <div class="mini-item" style="margin-bottom:10px;">
                <div style="max-width: 720px;">
                  <b>${escapeHtml(q.id)}</b>
                  <small>${escapeHtml(q.q).slice(0,160)}${q.q.length>160?"‚Ä¶":""}</small>
                </div>
                <div class="chip">${escapeHtml(q.level||"‚Äî")}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
      return;
    }

    if (tab === "wrong"){
      // quest√µes com acur√°cia < 50% e tentativas >= 2 (heur√≠stica)
      const weakIds = Object.entries(qStats)
        .filter(([,s]) => (s.attempts||0) >= 2 && (s.correct||0)/(s.attempts||1) < 0.5)
        .sort((a,b)=> ((a[1].correct||0)/(a[1].attempts||1)) - ((b[1].correct||0)/(b[1].attempts||1)))
        .slice(0, 60)
        .map(([id])=>id);

      if (!weakIds.length){
        $("historyContent").innerHTML = `<div class="muted" style="text-align:center; margin-top:18px;">Sem erros recorrentes suficientes ainda.</div>`;
        return;
      }

      const qMap = new Map(db.all.map(q=>[q.id,q]));
      const list = weakIds.map(id=>qMap.get(id)).filter(Boolean);

      $("historyContent").innerHTML = `
        <div class="card" style="margin-top: 16px;">
          <div class="card-head">
            <div>
              <b style="font-weight:900;">Erros para revisar</b>
              <div class="muted">Baseado em tentativas e acur√°cia</div>
            </div>
            <button class="btn ghost small" id="btnStartWeak" type="button">‚ñ∂Ô∏è Iniciar revis√£o</button>
          </div>
          <div class="card-body">
            ${list.map(q=>`
              <div class="mini-item" style="margin-bottom:10px;">
                <div style="max-width: 720px;">
                  <b>${escapeHtml(q.id)}</b>
                  <small>${escapeHtml(q.q).slice(0,160)}${q.q.length>160?"‚Ä¶":""}</small>
                </div>
                <div class="chip">${escapeHtml(q.theme||"‚Äî")}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
      return;
    }
  }

  function setupHistoryTabs(){
    $$(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        $$(".tab").forEach(x=>{ x.classList.remove("active"); x.setAttribute("aria-selected","false"); });
        t.classList.add("active");
        t.setAttribute("aria-selected","true");
        const tab = t.getAttribute("data-tab");
        renderHistoryTab(tab);
      });
      t.addEventListener("keydown", (e)=>{
        if (e.key==="Enter" || e.key===" "){
          e.preventDefault();
          t.click();
        }
      });
    });
  }

  // =========================================================
  // STATS VIEW + EXPORT
  // =========================================================
  function renderStats(){
    const hist = StatsManager.getHistory();
    const qs = StatsManager.getQuestionStats();

    const totalSessions = hist.length;
    const totalQs = Object.keys(qs).length;
    const totalAttempts = Object.values(qs).reduce((s,x)=>s+(x.attempts||0),0);
    const totalCorrect = Object.values(qs).reduce((s,x)=>s+(x.correct||0),0);
    const acc = totalAttempts ? Math.round((totalCorrect/totalAttempts)*100) : 0;

    // barras simples (sem libs)
    const last10 = hist.slice(0,10).reverse();
    const chart = `
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">√öltimos simulados (acur√°cia)</h3>
          <div class="muted">${last10.length} registro(s)</div>
        </div>
        ${
          last10.length
            ? last10.map((h, i)=>{
              const a = h.total ? Math.round((h.correct/h.total)*100) : 0;
              const worst = a < 50 ? "worst" : "";
              return `
                <div class="chart-bar">
                  <div class="bar-label">
                    <span>${escapeHtml(new Date(h.completedAt).toLocaleDateString("pt-BR"))} ‚Ä¢ ${escapeHtml(h.mode||"‚Äî")}</span>
                    <span><b>${a}%</b></span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill ${worst}" style="width:${clamp(a,0,100)}%">${a}%</div>
                  </div>
                </div>
              `;
            }).join("")
            : `<div class="muted">Sem simulados para exibir.</div>`
        }
      </div>
    `;

    $("statsContent").innerHTML = `
      <div class="kpi-grid">
        <div class="kpi"><div class="label">Acur√°cia geral</div><div class="value">${acc}%</div><div class="sub">tentativas: ${totalAttempts}</div></div>
        <div class="kpi"><div class="label">Simulados</div><div class="value">${totalSessions}</div><div class="sub">hist√≥rico local</div></div>
        <div class="kpi"><div class="label">Quest√µes com stats</div><div class="value">${totalQs}</div><div class="sub">base: localStorage</div></div>
        <div class="kpi"><div class="label">Acertos</div><div class="value">${totalCorrect}</div><div class="sub">no total</div></div>
      </div>
      ${chart}
    `;
  }

  function exportJSON(){
    const payload = {
      exportedAt: new Date().toISOString(),
      auth: AuthManager.getAuth(),
      history: StatsManager.getHistory(),
      questionStats: StatsManager.getQuestionStats(),
      bookmarks: BookmarkManager.getBookmarks(),
      exclusions: ExclusionManager.getExclusions()
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `simulador_export_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function exportCSV(){
    const hist = StatsManager.getHistory();
    const header = ["completedAt","courseName","mode","total","answered","correct","wrong","durationSec"].join(",");
    const rows = hist.map(h => {
      const dt = new Date(h.completedAt).toISOString();
      const dur = Math.round((h.durationMs||0)/1000);
      const vals = [
        dt,
        `"${String(h.courseName||"").replace(/"/g,'""')}"`,
        `"${String(h.mode||"").replace(/"/g,'""')}"`,
        h.total||0,
        h.answered||0,
        h.correct||0,
        h.wrong||0,
        dur
      ];
      return vals.join(",");
    });
    const blob = new Blob([header+"\n"+rows.join("\n")], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `simulador_historico_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // =========================================================
  // MANUAIS
  // =========================================================
  function initManual(){
    $("manualIframe").src = MANUAL_PDF;
    $("btnOpenManualNewTab").href = MANUAL_PDF;
    $("btnDownloadManual").href = MANUAL_PDF;
  }

  // =========================================================
  // LOGIN
  // =========================================================
  function handleLogin(){
    const user = ($("loginUser").value || "").trim();
    const pass = ($("loginPass").value || "").trim();
    const remember = $("rememberMe").checked;

    $("fieldUser").classList.toggle("invalid", !user);
    $("fieldPass").classList.toggle("invalid", !pass);

    if (!user || !pass){
      showToast("Preencha usu√°rio e senha.","bad");
      return;
    }

    AuthManager.setAuth(user, remember);
    AuthManager.requireLogin();
    renderHomeDashboard();
    showToast("Bem-vindo! ‚úÖ","ok");
  }

  // =========================================================
  // EVENTS
  // =========================================================
  function wireEvents(){
    // nav
    $("navHome").addEventListener("click", (e)=>{ e.preventDefault(); showView("home"); setActiveNav("navHome"); renderHomeDashboard(); renderCourses(); });
    $("navQuiz").addEventListener("click", (e)=>{ e.preventDefault(); showView("quiz"); setActiveNav("navQuiz"); });
    $("navHistory").addEventListener("click", (e)=>{ e.preventDefault(); showView("history"); setActiveNav("navHistory"); renderHistoryTab(qs(".tab.active")?.getAttribute("data-tab") || "history"); });
    $("navStats").addEventListener("click", (e)=>{ e.preventDefault(); showView("stats"); setActiveNav("navStats"); renderStats(); });
    $("navManuals").addEventListener("click", (e)=>{ e.preventDefault(); showView("manuals"); setActiveNav("navManuals"); });

    // logout
    $("btnLogout").addEventListener("click", ()=>{
      AuthManager.clearAuth();
      currentUser = null;
      SessionManager.clearSession();
      $("pillUser").textContent = "‚Äî";
      $("loginBackdrop").classList.add("show");
      $("loginBackdrop").setAttribute("aria-hidden","false");
      showToast("Sess√£o encerrada.","info");
    });

    // login
    $("btnLogin").addEventListener("click", handleLogin);
    $("loginPass").addEventListener("keydown", (e)=>{ if (e.key==="Enter") handleLogin(); });
    $("loginUser").addEventListener("keydown", (e)=>{ if (e.key==="Enter") handleLogin(); });

    // course select
    $("coursesGrid").addEventListener("click", async (e)=>{
      const card = e.target.closest(".course-card");
      if (!card) return;
      const id = card.getAttribute("data-course");
      const course = courses.find(c=>c.id===id);
      if (!course) return;

      // load DB se necess√°rio
      const loadToast = showToast("Carregando quest√µes‚Ä¶","info", 999999);
      try{
        await loadCourseDb(course);
        renderCourses();
        renderHomeDashboard();
        openWizard(course);
        showToast("Base carregada ‚úÖ","ok");
      }catch(err){
        console.error(err);
        showToast(`‚ùå Falha ao carregar JSON: ${escapeHtml(err.message || err)}`,"bad", 4200);
      }
    });

    // wizard: close
    $("btnCloseWizard").addEventListener("click", closeWizard);

    // wizard: mode cards
    $$(".mode").forEach(m=>{
      m.addEventListener("click", ()=> setMode(m.getAttribute("data-mode")));
      m.addEventListener("keydown", (e)=>{
        if (e.key==="Enter" || e.key===" "){ e.preventDefault(); m.click(); }
      });
    });

    // wizard: step buttons
    $("btnPrevStep").addEventListener("click", ()=>{
      const isExam = wizard.mode==="exam";
      if (wizard.step === 4 && isExam) { setWizardStep(2); return; }
      if (wizard.step === 4 && !isExam) { setWizardStep(3); return; }
      if (wizard.step === 3) { setWizardStep(2); return; }
      if (wizard.step === 2) { setWizardStep(1); return; }
    });

    $("btnNextStep").addEventListener("click", async ()=>{
      updateConfirm();

      // fluxo de steps depende do modo
      if (wizard.step === 1){
        setWizardStep(2);
        return;
      }
      if (wizard.step === 2){
        // se custom, vai para filtros; se exam, pula para revis√£o
        if (wizard.mode === "custom") setWizardStep(3);
        else setWizardStep(4);
        return;
      }
      if (wizard.step === 3){
        setWizardStep(4);
        return;
      }
      if (wizard.step === 4){
        startQuiz();
      }
    });

    // wizard config watchers
    $("selQty").addEventListener("change", ()=>{ updateConfirm(); if (wizard.filters.distEnable) computeDistBadge(); });
    $("chkNoRepeat").addEventListener("change", ()=> updateConfirm());
    $("chkOfficialDuration").addEventListener("change", ()=> updateConfirm());

    $("selTheme").addEventListener("change", ()=>{
      wizard.filters.theme = $("selTheme").value;
      updateFilterInfo();
    });
    $("selLevel").addEventListener("change", ()=>{
      wizard.filters.level = $("selLevel").value;
      updateFilterInfo();
    });

    // module/chapter checkbox delegation
    $("listModule").addEventListener("change", (e)=>{
      const cb = e.target;
      if (cb?.matches('input[type="checkbox"][data-type="module"]')){
        const v = cb.getAttribute("data-val");
        if (cb.checked) wizard.filters.modules.add(v);
        else wizard.filters.modules.delete(v);
        updateFilterInfo();
      }
    });
    $("listChapter").addEventListener("change", (e)=>{
      const cb = e.target;
      if (cb?.matches('input[type="checkbox"][data-type="chapter"]')){
        const v = cb.getAttribute("data-val");
        if (cb.checked) wizard.filters.chapters.add(v);
        else wizard.filters.chapters.delete(v);
        updateFilterInfo();
      }
    });

    $("searchText").addEventListener("input", ()=>{
      wizard.filters.search = $("searchText").value.trim();
      updateFilterInfo();
    });

    $("chkDistEnable").addEventListener("change", ()=>{ updateDistUI(); updateFilterInfo(); });
    $("distModeQty").addEventListener("change", ()=>{ updateDistUI(); updateFilterInfo(); });
    $("distModePct").addEventListener("change", ()=>{ updateDistUI(); updateFilterInfo(); });

    $("distRows").addEventListener("input", (e)=>{
      const inp = e.target;
      if (!inp?.matches(".dist-input")) return;
      const key = inp.getAttribute("data-key");
      const val = inp.value;
      wizard.filters.distMap[key] = val === "" ? "" : Number(val);
      computeDistBadge();
    });

    $("btnAutoFill").addEventListener("click", autoFillOfficialDist);

    // quiz actions
    $("btnPrev").addEventListener("click", prev);
    $("btnNext").addEventListener("click", next);
    $("btnCorrect").addEventListener("click", correctCurrent);
    $("btnFinish").addEventListener("click", ()=> finishQuiz(false));

    $("qnavGrid").addEventListener("click", (e)=>{
      const b = e.target.closest(".qnav-btn");
      if (!b) return;
      gotoIdx(Number(b.getAttribute("data-idx")));
    });

    $("qOptions").addEventListener("click", (e)=>{
      const opt = e.target.closest(".opt");
      if (!opt) return;

      // exclude - ALTERADO: Agora usa sessionId
      if (e.target.closest(".exclude-btn")){
        const q = quiz.questions[quiz.idx];
        if (!q) return;
        const letter = opt.getAttribute("data-letter");
        const nowExcluded = ExclusionManager.toggleExclusion(quiz.sessionId, q.id, letter);
        renderQuestion();
        showToast(nowExcluded ? "Alternativa eliminada." : "Alternativa reativada.", nowExcluded ? "bad" : "ok", 1200);
        return;
      }

      // choose
      const letter = opt.getAttribute("data-letter");
      setChosen(letter);
    });

    $("btnStar").addEventListener("click", ()=>{
      const q = quiz.questions[quiz.idx];
      if (!q) return;
      const on = BookmarkManager.toggleBookmark(q.id);
      renderQuestion();
      showToast(on ? "Marcada ‚≠ê" : "Desmarcada","info", 1200);
    });

    $("btnToggleExplanation").addEventListener("click", ()=>{
      $("explanationBox").classList.toggle("show");
    });

    // results modal
    $("btnCloseResults").addEventListener("click", closeResults);
    $("btnNewSimulado").addEventListener("click", ()=>{
      closeResults();
      showView("home");
      setActiveNav("navHome");
      renderHomeDashboard();
      showToast("Selecione o curso para iniciar.","info");
    });

    $("btnReviewAll").addEventListener("click", ()=>{
      closeResults();
      // carrega √∫ltimo hist√≥rico para revis√£o
      const last = StatsManager.getHistory()[0];
      if (!last) return;
      const qMap = new Map(db.all.map(q=>[q.id,q]));
      quiz.questions = (last.questions||[]).map(id=>qMap.get(id)).filter(Boolean);
      quiz.answers = last.answers || {};
      quiz.idx = 0;
      quiz.sessionId = last.sessionId || Date.now().toString(36) + Math.random().toString(36).slice(2);
      showView("quiz");
      setActiveNav("navQuiz");
      buildQNav();
      renderQuestion();
    });

    $("btnReviewWrong").addEventListener("click", ()=>{
      closeResults();
      const last = StatsManager.getHistory()[0];
      if (!last) return;
      const wrongIds = new Set(Object.entries(last.answers||{}).filter(([,a])=>a?.corrected && a.correct===false).map(([id])=>id));
      const qMap = new Map(db.all.map(q=>[q.id,q]));
      quiz.questions = Array.from(wrongIds).map(id=>qMap.get(id)).filter(Boolean);
      quiz.answers = last.answers || {};
      quiz.idx = 0;
      quiz.sessionId = last.sessionId || Date.now().toString(36) + Math.random().toString(36).slice(2);
      showView("quiz");
      setActiveNav("navQuiz");
      buildQNav();
      renderQuestion();
    });

    $("btnExportResult").addEventListener("click", exportJSON);

    // stats export
    $("btnExportCSV").addEventListener("click", exportCSV);
    $("btnExportJSON").addEventListener("click", exportJSON);

    // history actions
    $("historyContent").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      if (action === "review"){
        const id = btn.getAttribute("data-id");
        const hist = StatsManager.getHistory();
        const sess = hist.find(x=>x.id===id);
        if (!sess) return;

        const qMap = new Map(db.all.map(q=>[q.id,q]));
        quiz.questions = (sess.questions||[]).map(qid=>qMap.get(qid)).filter(Boolean);
        quiz.answers = sess.answers || {};
        quiz.idx = 0;
        quiz.sessionId = sess.sessionId || Date.now().toString(36) + Math.random().toString(36).slice(2);

        showView("quiz");
        setActiveNav("navQuiz");
        buildQNav();
        renderQuestion();
        showToast("Revis√£o carregada.","info");
      }
    });

    // bookmarks/weak start buttons (delegados)
    $("viewHistory").addEventListener("click", (e)=>{
      const b1 = e.target.closest("#btnStartBookmarks");
      if (b1){
        const qMap = new Map(db.all.map(q=>[q.id,q]));
        const list = BookmarkManager.getBookmarks().map(id=>qMap.get(id)).filter(Boolean);
        if (!list.length){ showToast("Sem marcadas.","info"); return; }
        quiz.questions = pickRandom(list, Math.min(30, list.length));
        quiz.answers = {};
        quiz.idx = 0;
        quiz.sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2);
        showView("quiz");
        setActiveNav("navQuiz");
        buildQNav();
        renderQuestion();
        return;
      }
      const b2 = e.target.closest("#btnStartWeak");
      if (b2){
        const qStats = StatsManager.getQuestionStats();
        const weakIds = Object.entries(qStats)
          .filter(([,s]) => (s.attempts||0) >= 2 && (s.correct||0)/(s.attempts||1) < 0.5)
          .slice(0, 60)
          .map(([id])=>id);
        const qMap = new Map(db.all.map(q=>[q.id,q]));
        const list = weakIds.map(id=>qMap.get(id)).filter(Boolean);
        if (!list.length){ showToast("Sem lista de erros.","info"); return; }
        quiz.questions = pickRandom(list, Math.min(30, list.length));
        quiz.answers = {};
        quiz.idx = 0;
        quiz.sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2);
        showView("quiz");
        setActiveNav("navQuiz");
        buildQNav();
        renderQuestion();
      }
    });
  }

  // =========================================================
  // INIT
  // =========================================================
  async function init(){
    initManual();
    setupHistoryTabs();
    wireEvents();

    // auth
    const ok = AuthManager.requireLogin();
    if (!ok) return;

    // tenta carregar curso padr√£o (opcional: s√≥ se existir arquivo)
    try{
      await loadCourseDb(courses[0]);
    }catch(err){
      console.warn("N√£o carregou JSON automaticamente:", err);
    }

    renderCourses();
    renderHomeDashboard();

    // retomar sess√£o se existir
    if (db.all.length) resumeQuizIfAny();
  }

  // start
  init();

})();
</script>
</body>
</html>
