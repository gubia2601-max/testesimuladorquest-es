<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Quest√µes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
    --bg:#F3F5F9;
    --panel:#FFFFFF;
    --panel-2:#F7F8FC;
    --text:#0B1220;
    --muted:#637189;
    --border:rgba(15,23,42,.12);
    --shadow:0 14px 40px rgba(2,8,23,.10);
    --shadow-light:0 8px 24px rgba(2,8,23,.06);
    --shadow-heavy:0 20px 60px rgba(2,8,23,.20);
    --brand:#2D2A5C;
    --brand-2:#3B37A0;
    --brand-3:#6B66FF;
    --brand-light:rgba(107,102,255,.10);
    --ok:#22C55E;
    --ok-light:rgba(34,197,94,.08);
    --warn:#F59E0B;
    --warn-light:rgba(245,158,11,.08);
    --bad:#EF4444;
    --bad-light:rgba(239,68,68,.08);
    --r-lg:18px;
    --r-md:14px;
    --r-sm:12px;
    --maxw: 1180px;
}
*{
    box-sizing:border-box;
}
html,body{
    height:100%;
}
body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* ===== Topbar ===== */
.topbar{
    height:64px;
    background: linear-gradient(180deg, #2b2e3f, #26293a);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 8px 18px rgba(2,8,23,.18);
    position: sticky;
    top:0;
    z-index: 10;
}
.topbar-inner{
    width: min(var(--maxw), calc(100% - 24px));
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 14px;
}
.brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight: 950;
    letter-spacing:.2px;
}
.brand .logo{
    width: 34px;
    height: 34px;
    border-radius: 12px;
    background: rgba(107,102,255,.18);
    border: 1px solid rgba(255,255,255,.18);
    display:grid;
    place-items:center;
    font-weight: 950;
}
.nav{
    display:flex;
    align-items:center;
    gap:18px;
    color: rgba(255,255,255,.86);
    font-weight: 800;
    font-size: 13px;
}
.nav a{
    color: inherit;
    text-decoration:none;
    opacity:.9;
    padding: 6px 0;
    position: relative;
}
.nav a.active::after{
    content:"";
    position:absolute;
    bottom:-2px;
    left:0;
    right:0;
    height:2px;
    background: var(--brand-3);
    border-radius:2px;
}
.nav a:hover{
    opacity: 1;
}
.top-actions{
    display:flex;
    align-items:center;
    gap:10px;
}
.pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.14);
    font-weight: 900;
    font-size: 12px;
    white-space: nowrap;
}

/* ===== Layout ===== */
.wrap{
    width: min(var(--maxw), calc(100% - 24px));
    margin: 18px auto 40px auto;
    min-height: calc(100vh - 120px);
}
.hero-banner{
    height: 160px;
    border-radius: var(--r-lg);
    background: radial-gradient(900px 220px at 70% 30%, rgba(107,102,255,.25), transparent 55%),
                radial-gradient(900px 220px at 20% 10%, rgba(59,55,160,.25), transparent 55%),
                linear-gradient(90deg, #0f1226, #0b0d1c);
    position: relative;
    overflow:hidden;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,.06);
    display:flex;
    align-items:center;
    padding: 0 30px;
}
.hero-title{
    color:#fff;
    font-weight: 950;
    font-size: 28px;
    letter-spacing:.2px;
    margin:0;
}
.hero-sub{
    color: rgba(255,255,255,.75);
    font-size: 14px;
    font-weight: 600;
    margin-top: 8px;
    max-width: 600px;
}

/* ===== Dashboard Cards ===== */
.stats-grid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin: 20px 0;
}
@media (max-width: 1100px){
    .stats-grid{ grid-template-columns: repeat(2, 1fr);}
}
@media (max-width: 640px){
    .stats-grid{ grid-template-columns: 1fr;}
}
.stat-card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    padding: 20px;
    box-shadow: var(--shadow-light);
    transition: transform .2s ease;
}
.stat-card:hover{
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}
.stat-value{
    font-size: 32px;
    font-weight: 950;
    margin: 10px 0;
    color: var(--brand-2);
}
.stat-label{
    font-size: 12px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .5px;
}
.stat-trend{
    display:flex;
    align-items:center;
    gap: 6px;
    font-size: 12px;
    font-weight: 800;
    margin-top: 10px;
}
.stat-trend.up{
    color: var(--ok);
}
.stat-trend.down{
    color: var(--bad);
}

/* ===== Cards / Sections ===== */
.section-title{
    margin: 18px 0 12px 0;
    font-size: 22px;
    font-weight: 950;
    letter-spacing:.2px;
}
.toolbar{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    padding: 14px 18px;
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    box-shadow: var(--shadow-light);
    margin: 20px 0;
}
.search{
    flex: 1 1 300px;
    display:flex;
    gap: 10px;
    align-items:center;
    position: relative;
}
.search input{
    width:100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    outline:none;
    font-weight: 700;
    font-size: 13px;
    background: #fff;
    transition: all .2s ease;
}
.search input:focus{
    border-color: rgba(107,102,255,.55);
    box-shadow: 0 0 0 4px rgba(107,102,255,.14);
}
.search-icon{
    position:absolute;
    right:14px;
    color: var(--muted);
    pointer-events:none;
}
.btn{
    appearance:none;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: 900;
    font-size: 13px;
    cursor:pointer;
    transition: all .2s ease;
    display:inline-flex;
    align-items:center;
    gap: 10px;
    white-space: nowrap;
    outline: none;
}
.btn:focus-visible{
    box-shadow: 0 0 0 3px rgba(107,102,255,.25);
}
.btn:hover{
    transform: translateY(-1px);
    box-shadow: var(--shadow-light);
}
.btn.primary{
    background: linear-gradient(135deg, var(--brand), var(--brand-2));
    border-color: rgba(107,102,255,.35);
    color:#fff;
}
.btn.ghost{
    background: transparent;
    border-color: rgba(107,102,255,.28);
    color: var(--brand-2);
}
.btn.small{
    padding: 6px 12px;
    font-size: 12px;
}
.btn:disabled{
    opacity:.55;
    cursor:not-allowed;
    transform:none !important;
    box-shadow:none !important;
}

/* ===== Grid de Cursos ===== */
.grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0;
}
@media (max-width: 1100px){
    .grid{ grid-template-columns: repeat(2, 1fr);}
}
@media (max-width: 640px){
    .grid{ grid-template-columns: 1fr;}
}
.course-card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    overflow:hidden;
    box-shadow: var(--shadow-light);
    cursor:pointer;
    transition:all .2s ease;
    min-height: 320px;
    display:flex;
    flex-direction: column;
    position: relative;
}
.course-card.selected{
    border-color: var(--brand-3);
    box-shadow: 0 0 0 3px rgba(107,102,255,.15), var(--shadow);
}
.course-card:hover{
    transform: translateY(-4px);
    box-shadow: var(--shadow);
    border-color: rgba(107,102,255,.28);
}
.course-card .progress-ring{
    position:absolute;
    top: 15px;
    right: 15px;
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,.9);
    border-radius: 50%;
    display:grid;
    place-items:center;
    font-weight: 900;
    font-size: 12px;
    color: var(--brand);
    border: 2px solid var(--border);
}
.thumb{
    height: 160px;
    background: radial-gradient(700px 240px at 60% 30%, rgba(107,102,255,.20), transparent 55%),
                linear-gradient(120deg, #2b2e3f, #151728);
    position: relative;
}
.thumb .label{
    position:absolute;
    left:12px;
    top:12px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.18);
    color:#fff;
    font-weight: 900;
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 999px;
    text-transform: uppercase;
    letter-spacing: .5px;
}
.course-body{
    padding: 18px;
    display:flex;
    flex-direction: column;
    gap: 10px;
    flex: 1 1 auto;
}
.course-name{
    font-weight: 950;
    font-size: 17px;
    margin:0;
    color: var(--brand-2);
}
.course-desc{
    margin:0;
    color: var(--muted);
    font-weight: 600;
    font-size: 13px;
    line-height: 1.4;
    flex: 1;
}
.course-meta{
    display:flex;
    gap: 12px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
}
.course-meta span{
    display:flex;
    align-items:center;
    gap: 4px;
}
.course-foot{
    margin-top:auto;
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid var(--border);
}
.chip{
    font-size: 11px;
    font-weight: 900;
    padding: 6px 10px;
    border-radius: 999px;
    background: var(--brand-light);
    border: 1px solid rgba(107,102,255,.22);
    color: var(--brand);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: .3px;
}

/* ===== Modais ===== */
.backdrop{
    position: fixed;
    inset: 0;
    background: rgba(2,8,23,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 14px;
    z-index: 999;
    animation: fadeIn .2s ease;
}
.backdrop.show{
    display:flex;
}
.modal{
    width: min(980px, 100%);
    background: #fff;
    border-radius: 20px;
    box-shadow: var(--shadow-heavy);
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
    animation: slideUp .3s ease;
}
.modal-head{
    padding: 18px 22px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(180deg, rgba(107,102,255,.10), rgba(255,255,255,0));
}
.modal-head h2{
    margin:0;
    font-size: 16px;
    font-weight: 950;
}
.modal-body{
    padding: 22px;
}
.modal-foot{
    padding: 18px 22px;
    border-top: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    background: #fff;
    position: relative;
    z-index: 10;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== Campos de Formul√°rio ===== */
.fields{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}
.field{
    display:flex;
    flex-direction: column;
    gap: 8px;
}
.field.full{
    grid-column: 1 / -1;
}
.field label{
    font-size: 12px;
    font-weight: 900;
    color: var(--brand);
    text-transform: uppercase;
    letter-spacing: .5px;
}
.field input,.field select,.field textarea{
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    outline:none;
    font-weight: 600;
    font-size: 13px;
    background: #fff;
    transition: all .2s ease;
}
.field input:focus,.field select:focus,.field textarea:focus{
    border-color: rgba(107,102,255,.55);
    box-shadow: 0 0 0 4px rgba(107,102,255,.14);
}
.field .hint{
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
}

/* ===== Wizard Steps ===== */
.steps{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 24px;
}
.step{
    flex: 1 1 auto;
    display:flex;
    align-items:center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: #fff;
    transition: all .2s ease;
}
.step.active{
    border-color: rgba(107,102,255,.40);
    background: rgba(107,102,255,.04);
}
.step .dot{
    width: 32px;
    height: 32px;
    border-radius: 999px;
    display:grid;
    place-items:center;
    font-weight: 950;
    color:#fff;
    background: rgba(99,113,137,.35);
    transition: all .2s ease;
}
.step.active .dot{
    background: linear-gradient(135deg, var(--brand), var(--brand-2));
    transform: scale(1.1);
}
.step .meta{
    line-height: 1.2;
}
.step .meta b{
    font-size: 13px;
    font-weight: 950;
}
.step .meta span{
    display:block;
    font-size: 11px;
    color: var(--muted);
    font-weight: 700;
    margin-top:2px;
}

/* ===== Cards de Modalidade ===== */
.mode-cards{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}
@media (max-width: 900px){
    .mode-cards{ grid-template-columns: 1fr; }
}
.mode{
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
    background: #fff;
    cursor:pointer;
    transition:all .2s ease;
    display:flex;
    gap: 14px;
    align-items:flex-start;
}
.mode:hover{
    transform: translateY(-2px);
    border-color: rgba(107,102,255,.30);
    box-shadow: var(--shadow);
}
.mode.selected{
    border-color: var(--brand-3);
    background: rgba(107,102,255,.04);
    box-shadow: 0 16px 34px rgba(2,8,23,.10);
}
.mode .radio{
    width: 20px;
    height: 20px;
    border-radius: 999px;
    border: 2px solid rgba(99,113,137,.45);
    margin-top: 2px;
    position: relative;
    flex-shrink: 0;
}
.mode.selected .radio{
    border-color: var(--brand-3);
}
.mode.selected .radio::after{
    content:"";
    position:absolute;
    inset: 4px;
    border-radius: 999px;
    background: var(--brand-3);
    animation: fadeIn .2s ease;
}
.mode h3{
    margin:0;
    font-size: 14px;
    font-weight: 950;
    color: var(--brand);
}
.mode p{
    margin:8px 0 0 0;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
    line-height: 1.4;
}
.muted{
    color: var(--muted);
    font-weight: 600;
    font-size: 12px;
    line-height: 1.5;
}

/* ===== Quiz Page - ATUALIZADO COM BOT√ïES DE EXCLUS√ÉO ===== */
.quiz-shell{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    box-shadow: var(--shadow);
    overflow:hidden;
    margin: 20px 0;
}
.quiz-top{
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    background: linear-gradient(180deg, rgba(107,102,255,.08), rgba(255,255,255,0));
}
.quiz-top .left{
    display:flex;
    align-items:center;
    gap: 16px;
    flex-wrap: wrap;
}
.q-counter{
    font-weight: 950;
    font-size: 18px;
    color: var(--brand);
    background: rgba(107,102,255,.1);
    padding: 6px 12px;
    border-radius: 10px;
}
.q-mini{
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap: wrap;
    color: var(--muted);
    font-weight: 700;
    font-size: 13px;
}
.q-mini .sep{
    opacity:.4;
}
.progress{
    width: 100%;
    height: 10px;
    background: rgba(15,23,42,.08);
    border-radius: 999px;
    overflow:hidden;
    margin-top: 12px;
}
.progress > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, var(--ok), var(--warn), var(--bad));
    border-radius: 999px;
    transition: width .3s ease;
}
.quiz-body{
    padding: 24px 24px 16px 24px;
    background: #fff;
}
.q-id{
    color: var(--brand-2);
    font-weight: 950;
    font-size: 13px;
    margin-bottom: 10px;
    display:flex;
    align-items:center;
    gap: 10px;
}
.q-id .difficulty{
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    background: var(--brand-light);
}
.q-text{
    margin: 16px 0;
    font-size: 15px;
    font-weight: 700;
    line-height: 1.6;
    color: rgba(11,18,32,.95);
    white-space: pre-wrap;
}

/* Op√ß√µes do Quiz - ATUALIZADO COM BOT√ïES DE EXCLUS√ÉO */
.opts{
    margin-top: 20px;
    display:flex;
    flex-direction: column;
    gap: 12px;
}
.opt{
    display:flex;
    gap: 16px;
    align-items:flex-start;
    padding: 18px;
    border-radius: 16px;
    border: 2px solid var(--border);
    background: var(--panel-2);
    cursor:pointer;
    transition:all .2s ease;
    position: relative;
    overflow: hidden;
}
.opt::before{
    content:"";
    position:absolute;
    left:0;
    top:0;
    bottom:0;
    width: 4px;
    background: transparent;
    transition: background .2s ease;
}
.opt:hover{
    transform: translateY(-2px);
    border-color: rgba(107,102,255,.40);
    box-shadow: var(--shadow-light);
}
.opt.selected{
    border-color: rgba(107,102,255,.60);
    background: rgba(107,102,255,.04);
}
.opt.correct{
    border-color: var(--ok);
    background: var(--ok-light);
}
.opt.correct::before{
    background: var(--ok);
}
.opt.wrong{
    border-color: var(--bad);
    background: var(--bad-light);
}
.opt.wrong::before{
    background: var(--bad);
}
.opt.excluded {
    opacity: 0.5;
    filter: blur(0.5px);
    text-decoration: line-through;
    border-color: rgba(99,113,137,.2);
    background: rgba(99,113,137,.05);
}
.opt.excluded:hover {
    transform: none;
    box-shadow: none;
    cursor: not-allowed;
}
.opt .radio{
    width: 20px;
    height: 20px;
    border-radius: 999px;
    border: 2px solid rgba(99,113,137,.50);
    margin-top: 2px;
    position: relative;
    flex: 0 0 auto;
    background:#fff;
    transition: all .2s ease;
}
.opt.selected .radio{
    border-color: rgba(107,102,255,.80);
}
.opt.selected .radio::after{
    content:"";
    position:absolute;
    inset: 4px;
    border-radius: 999px;
    background: rgba(107,102,255,.70);
    animation: fadeIn .2s ease;
}
.opt.correct .radio{
    border-color: var(--ok);
    background: var(--ok);
}
.opt.wrong .radio{
    border-color: var(--bad);
    background: var(--bad);
}
.opt .txt{
    font-size: 14px;
    font-weight: 600;
    color: rgba(11,18,32,.92);
    line-height: 1.5;
    white-space: pre-wrap;
    flex: 1;
}
.opt .letter{
    font-weight: 900;
    color: var(--brand);
    margin-right: 8px;
}
.opt .exclude-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    color: var(--muted);
    font-size: 18px;
    transition: all 0.2s ease;
    flex-shrink: 0;
    margin-left: 8px;
}
.opt .exclude-btn:hover {
    color: var(--bad);
    background: rgba(239,68,68,.1);
}
.opt.excluded .exclude-btn {
    color: var(--bad);
}
.opt.excluded .exclude-btn:hover {
    color: var(--ok);
    background: rgba(34,197,94,.1);
}

/* ===== Quiz Footer - ATUALIZADO COM LAYOT RESPONSIVO ===== */
.quiz-foot{
    padding: 18px 24px;
    border-top: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    background: #fff;
}
.quiz-foot .nav-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.quiz-foot .action-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.quiz-foot .right-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-wide{
    min-width: 160px;
    justify-content: center;
    padding: 12px 18px;
    border-radius: 12px;
    font-weight: 900;
}
.toast{
    margin-top: 16px;
    padding: 14px 16px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(15,23,42,.03);
    color: rgba(11,18,32,.82);
    font-weight: 700;
    font-size: 13px;
    display:none;
    white-space: pre-wrap;
    line-height: 1.5;
    animation: fadeIn .3s ease;
}
.toast.show{
    display:block;
}
.toast.ok{
    border-color: rgba(34,197,94,.35);
    background: var(--ok-light);
    color: rgba(13,122,78,.95);
}
.toast.bad{
    border-color: rgba(239,68,68,.30);
    background: var(--bad-light);
    color: rgba(185,28,28,.95);
}
.toast.info{
    border-color: rgba(107,102,255,.30);
    background: rgba(107,102,255,.08);
    color: var(--brand);
}

/* ===== Modal de Resultados - ATUALIZADO COM MAIS INDICADORES ===== */
.result-card{
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    border: 1px solid var(--border);
}
.result-title{
    font-size: 24px;
    font-weight: 950;
    color: var(--brand);
    margin: 0 0 10px 0;
}
.result-stats{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin: 20px 0;
}
@media (max-width: 900px) {
    .result-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 640px) {
    .result-stats {
        grid-template-columns: 1fr;
    }
}
.result-stat{
    text-align:center;
    padding: 20px;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
}
.result-value{
    font-size: 36px;
    font-weight: 950;
    margin: 10px 0;
}
.result-value.good{
    color: var(--ok);
}
.result-value.medium{
    color: var(--warn);
}
.result-value.bad{
    color: var(--bad);
}
.result-label{
    font-size: 12px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}
.result-trend {
    font-size: 11px;
    margin-top: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(99,113,137,.08);
    font-weight: 700;
}
.result-trend.up {
    color: var(--ok);
    background: rgba(34,197,94,.08);
}
.result-trend.down {
    color: var(--bad);
    background: rgba(239,68,68,.08);
}

/* Dashboard de Desempenho Avan√ßado */
.performance-dashboard {
    margin: 24px 0;
}
.performance-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}
@media (max-width: 1100px) {
    .performance-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 640px) {
    .performance-grid {
        grid-template-columns: 1fr;
    }
}
.performance-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    padding: 20px;
    box-shadow: var(--shadow-light);
}
.performance-card h3 {
    margin: 0 0 16px 0;
    font-size: 14px;
    font-weight: 950;
    color: var(--brand);
}
.weak-area-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.weak-area-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--panel-2);
    border-radius: 10px;
    border: 1px solid var(--border);
}
.weak-area-name {
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
}
.weak-area-accuracy {
    font-size: 11px;
    font-weight: 900;
    padding: 4px 8px;
    border-radius: 999px;
    background: var(--bad-light);
    color: var(--bad);
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(15,23,42,.08);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 8px;
}
.progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--bad), var(--warn), var(--ok));
}

/* ===== Views ===== */
.view{
    display:none;
}
.view.show{
    display:block;
}

/* ===== Loading States ===== */
.loading{
    display:grid;
    place-items:center;
    padding: 40px;
    color: var(--muted);
}
.loading::after{
    content:"";
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--brand-3);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== Error States ===== */
.error-card{
    background: var(--bad-light);
    border: 1px solid var(--bad);
    border-radius: var(--r-lg);
    padding: 30px;
    text-align:center;
    margin: 20px 0;
}
.error-title{
    color: var(--bad);
    font-weight: 950;
    font-size: 18px;
    margin: 0 0 10px 0;
}

/* ===== Tab Navigation ===== */
.tabs{
    display:flex;
    gap: 2px;
    background: var(--panel-2);
    border-radius: 12px;
    padding: 4px;
    margin: 20px 0;
}
.tab{
    flex: 1;
    padding: 12px 16px;
    text-align:center;
    font-weight: 900;
    font-size: 13px;
    color: var(--muted);
    cursor:pointer;
    border-radius: 8px;
    transition: all .2s ease;
}
.tab:hover{
    background: rgba(107,102,255,.05);
}
.tab.active{
    background: white;
    color: var(--brand);
    box-shadow: var(--shadow-light);
}

/* ===== Table de Hist√≥rico ===== */
.table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin: 20px 0;
}
.table th{
    text-align:left;
    padding: 12px 16px;
    background: var(--panel-2);
    color: var(--brand);
    font-weight: 900;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border);
}
.table td{
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
}
.table tr:hover{
    background: rgba(107,102,255,.03);
}
.badge{
    display:inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: .5px;
}
.badge.correct{
    background: var(--ok-light);
    color: var(--ok);
    border: 1px solid rgba(34,197,94,.3);
}
.badge.incorrect{
    background: var(--bad-light);
    color: var(--bad);
    border: 1px solid rgba(239,68,68,.3);
}
.badge.pending{
    background: var(--warn-light);
    color: var(--warn);
    border: 1px solid rgba(245,158,11,.3);
}

/* ===== Export Panel ===== */
.export-panel{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r-lg);
    padding: 24px;
    margin: 20px 0;
    box-shadow: var(--shadow-light);
}
.export-options{
    display:flex;
    gap: 12px;
    flex-wrap:wrap;
    margin-top: 16px;
}

/* ===== Responsividade Mobile ===== */
@media (max-width: 768px) {
    .topbar-inner {
        flex-wrap: wrap;
        height: auto;
        padding: 10px 0;
    }
    .nav {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
        gap: 12px;
    }
    .hero-banner {
        padding: 20px;
        height: auto;
        min-height: 140px;
    }
    .hero-title {
        font-size: 22px;
    }
    .quiz-foot {
        flex-direction: column;
        gap: 16px;
    }
    .quiz-foot .nav-group,
    .quiz-foot .action-group,
    .quiz-foot .right-group {
        width: 100%;
        justify-content: center;
    }
    .btn {
        flex: 1;
        min-width: 0;
        justify-content: center;
    }
    .opt {
        padding: 14px;
    }
    .fields {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 480px) {
    .mode-cards {
        grid-template-columns: 1fr;
    }
    .steps {
        flex-wrap: wrap;
    }
    .step {
        flex: 1 0 100%;
    }
    .q-counter {
        font-size: 16px;
    }
    .q-text {
        font-size: 14px;
    }
    .quiz-body {
        padding: 16px;
    }
}
</style>
</head>
<body>
<header class="topbar">
    <div class="topbar-inner">
        <div class="brand">
            <div class="logo">Q</div>
            Simulador Pro
        </div>
        <nav class="nav">
            <a href="#" id="navHome" class="active">Dashboard</a>
            <a href="#" id="navQuiz">Simulado</a>
            <a href="#" id="navHistory">Hist√≥rico</a>
            <a href="#" id="navStats">Estat√≠sticas</a>
        </nav>
        <div class="top-actions">
            <div class="pill" id="pillUser">‚Äî</div>
            <button class="btn ghost small" id="btnLogout" type="button">Sair</button>
        </div>
    </div>
</header>

<main class="wrap">
    <!-- DASHBOARD / HOME -->
    <section class="view show" id="viewHome">
        <div class="hero-banner">
            <div>
                <h1 class="hero-title">Simulador de Certifica√ß√µes</h1>
                <div class="hero-sub">Prepare-se para as principais certifica√ß√µes financeiras do mercado com quest√µes atualizadas e simulados personalizados.</div>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Ser√° preenchido dinamicamente -->
        </div>
        
        <h2 class="section-title">Certifica√ß√µes Dispon√≠veis <span class="muted" id="certCount">(0)</span></h2>
        
        <div class="toolbar">
            <div class="search">
                <input id="searchCourses" type="text" placeholder="Buscar certifica√ß√£o..." />
                <div class="search-icon">üîç</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn ghost" id="btnBookmarks" type="button" disabled>‚≠ê Favoritos</button>
                <button class="btn primary" id="btnOpenWizard" type="button" disabled>‚ñ∂ Iniciar Simulado</button>
            </div>
        </div>
        
        <div class="grid" id="coursesGrid"></div>
        
        <div class="muted" style="margin-top:30px; padding:20px; background:var(--panel-2); border-radius:var(--r-lg);">
            üí° <b>Dica:</b> Este simulador salva seu progresso localmente no navegador. Para salvar entre dispositivos, futuramente integraremos com backend/SSO.
        </div>
    </section>
    
    <!-- QUIZ -->
    <section class="view" id="viewQuiz">
        <div class="quiz-shell">
            <div class="quiz-top">
                <div class="left">
                    <div class="q-counter" id="qCounter">1/0</div>
                    <div class="q-mini">
                        <span id="qTimer">00:00</span><span class="sep">‚Ä¢</span>
                        <span id="qCourseName">‚Äî</span><span class="sep">‚Ä¢</span>
                        <span id="qMeta">‚Äî</span>
                    </div>
                </div>
                <div class="muted" id="qHintTop">Selecione uma alternativa e clique em "Corrigir"</div>
                <div class="progress"><div id="progressBar"></div></div>
            </div>
            
            <div class="quiz-body">
                <div class="q-id">
                    <span id="qId">#‚Äî</span>
                    <span class="difficulty" id="qDifficulty">‚Äî</span>
                </div>
                <p class="q-text" id="qText">‚Äî</p>
                <div class="opts" id="qOptions"></div>
                <div class="toast" id="qToast"></div>
            </div>
            
            <div class="quiz-foot">
                <div class="nav-group">
                    <button class="btn" id="btnPrev" type="button">‚Üê Anterior</button>
                </div>
                
                <div class="action-group">
                    <button class="btn ghost" id="btnFlag" type="button" title="Marcar para revis√£o">‚≠ê</button>
                    <button class="btn primary" id="btnCorrect" type="button" disabled>‚úì Corrigir</button>
                </div>
                
                <div class="right-group">
                    <button class="btn" id="btnNext" type="button">Pr√≥xima ‚Üí</button>
                    <button class="btn ghost" id="btnFinish" type="button">Finalizar Simulado</button>
                </div>
            </div>
        </div>
    </section>
    
    <!-- HIST√ìRICO -->
    <section class="view" id="viewHistory">
        <div class="hero-banner">
            <div>
                <h1 class="hero-title">Hist√≥rico de Simulados</h1>
                <div class="hero-sub">Acompanhe seu progresso e revise quest√µes j√° respondidas.</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="history">Simulados Completos</div>
            <div class="tab" data-tab="bookmarks">Quest√µes Marcadas</div>
            <div class="tab" data-tab="wrong">Erros para Revisar</div>
        </div>
        
        <div id="historyContent">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </section>
    
    <!-- ESTAT√çSTICAS - ATUALIZADO COM DASHBOARD AVAN√áADO -->
    <section class="view" id="viewStats">
        <div class="hero-banner">
            <div>
                <h1 class="hero-title">Dashboard de Desempenho</h1>
                <div class="hero-sub">Analise seu progresso e identifique √°reas para melhorar com indicadores avan√ßados.</div>
            </div>
        </div>
        
        <div class="stats-grid" id="performanceStats">
            <!-- Ser√° preenchido dinamicamente -->
        </div>
        
        <div class="performance-dashboard">
            <h2 class="section-title">An√°lise Detalhada</h2>
            <div class="performance-grid" id="advancedStats">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>
        
        <div class="export-panel">
            <h3 style="margin:0 0 10px 0; font-size:16px; font-weight:950;">Exportar Dados</h3>
            <div class="muted">Exporte seu hist√≥rico para an√°lise externa ou backup.</div>
            <div class="export-options">
                <button class="btn ghost" id="btnExportCSV" type="button">üìä Exportar CSV</button>
                <button class="btn ghost" id="btnExportJSON" type="button">üìù Exportar JSON</button>
                <button class="btn ghost" id="btnExportPDF" type="button" disabled>üìÑ Exportar PDF (em breve)</button>
            </div>
        </div>
    </section>
</main>

<!-- LOGIN MODAL -->
<div class="backdrop show" id="loginBackdrop" aria-hidden="false">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <div class="modal-head">
            <h2 id="loginTitle">Login - Simulador Pro</h2>
            <div class="muted">Entre para acessar simulados personalizados</div>
        </div>
        <div class="modal-body">
            <div class="fields">
                <div class="field">
                    <label for="loginUser">Usu√°rio</label>
                    <input id="loginUser" type="text" placeholder="Seu nome de usu√°rio" autocomplete="username" />
                    <div class="hint">Pode ser qualquer nome - criamos sua conta localmente</div>
                </div>
                <div class="field">
                    <label for="loginPass">Senha</label>
                    <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
                    <div class="hint">Sua senha √© armazenada localmente no navegador</div>
                </div>
                <div class="field full">
                    <label>
                        <input type="checkbox" id="rememberMe" checked />
                        Lembrar de mim neste dispositivo
                    </label>
                </div>
            </div>
            <div class="toast show info" id="loginMsg">
                üîê <b>Seguran√ßa Local:</b> Seus dados ficam apenas neste navegador. Para sincroniza√ß√£o entre dispositivos, futuramente integraremos com nuvem.
            </div>
        </div>
        <div class="modal-foot">
            <div class="muted" id="loginInfo">Primeiro acesso? Qualquer usu√°rio/senha funciona.</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnLogin" type="button">üéØ Entrar no Simulador</button>
            </div>
        </div>
    </div>
</div>

<!-- WIZARD MODAL (Resolver Quest√µes) -->
<div class="backdrop" id="wizardBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
        <div class="modal-head">
            <div>
                <h2 id="wizTitle">Configurar Simulado</h2>
                <div class="muted" id="wizSub">Personalize seu simulado em 4 passos</div>
            </div>
            <button class="btn ghost small" id="btnCloseWizard" type="button" aria-label="Fechar">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="dot">1</div>
                    <div class="meta"><b>Curso</b><span>Sele√ß√£o da certifica√ß√£o</span></div>
                </div>
                <div class="step" id="step2">
                    <div class="dot">2</div>
                    <div class="meta"><b>Modalidade</b><span>Estrat√©gia de estudo</span></div>
                </div>
                <div class="step" id="step3">
                    <div class="dot">3</div>
                    <div class="meta"><b>Filtros</b><span>Personaliza√ß√£o avan√ßada</span></div>
                </div>
                <div class="step" id="step4">
                    <div class="dot">4</div>
                    <div class="meta"><b>Revis√£o</b><span>Confirma√ß√£o e in√≠cio</span></div>
                </div>
            </div>
            
            <!-- PAGE 1 -->
            <div class="wiz-page" id="wizPage1">
                <div class="muted" style="margin-bottom:16px;">
                    Curso selecionado: <b id="wizCourseName" style="color:var(--brand);">‚Äî</b>
                </div>
                <div class="mode-cards">
                    <div class="mode selected" data-mode="quick">
                        <div class="radio"></div>
                        <div>
                            <h3>Simulado R√°pido</h3>
                            <p>10 quest√µes aleat√≥rias para um teste r√°pido.</p>
                        </div>
                    </div>
                    <div class="mode" data-mode="custom">
                        <div class="radio"></div>
                        <div>
                            <h3>Personalizado</h3>
                            <p>Configure m√≥dulos, dificuldade e quantidade.</p>
                        </div>
                    </div>
                    <div class="mode" data-mode="exam">
                        <div class="radio"></div>
                        <div>
                            <h3>Modo Prova</h3>
                            <p>60 quest√µes em tempo real, simulando exame oficial.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PAGE 2 -->
            <div class="wiz-page" id="wizPage2" style="display:none;">
                <div class="muted" style="margin-bottom:16px;">Escolha como quer estudar:</div>
                <div class="mode-cards">
                    <div class="mode selected" data-study="module">
                        <div class="radio"></div>
                        <div>
                            <h3>Por M√≥dulo</h3>
                            <p>Estude por t√≠tulos/cap√≠tulos espec√≠ficos do curso.</p>
                        </div>
                    </div>
                    <div class="mode" data-study="weakness">
                        <div class="radio"></div>
                        <div>
                            <h3>Por Fraquezas</h3>
                            <p>Foco nos temas com menor acerto hist√≥rico.</p>
                        </div>
                    </div>
                    <div class="mode" data-study="mixed">
                        <div class="radio"></div>
                        <div>
                            <h3>Misturado</h3>
                            <p>Todos os temas misturados para revis√£o geral.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PAGE 3 -->
            <div class="wiz-page" id="wizPage3" style="display:none;">
                <div class="fields">
                    <div class="field">
                        <label for="selModule">M√≥dulo</label>
                        <select id="selModule"></select>
                    </div>
                    <div class="field">
                        <label for="selChapter">Cap√≠tulo</label>
                        <select id="selChapter"></select>
                    </div>
                    <div class="field">
                        <label for="selTheme">Tema</label>
                        <select id="selTheme"></select>
                    </div>
                    <div class="field">
                        <label for="selLevel">Dificuldade</label>
                        <select id="selLevel"></select>
                    </div>
                    <div class="field">
                        <label for="selQty">Quantidade</label>
                        <select id="selQty">
                            <option value="5">5 quest√µes (r√°pido)</option>
                            <option value="10" selected>10 quest√µes</option>
                            <option value="20">20 quest√µes</option>
                            <option value="30">30 quest√µes</option>
                            <option value="40">40 quest√µes</option>
                            <option value="50">50 quest√µes</option>
                            <option value="60">60 quest√µes (prova completa)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="selTime">Tempo por quest√£o (s)</label>
                        <select id="selTime">
                            <option value="0">Sem limite</option>
                            <option value="60">60 segundos</option>
                            <option value="90" selected>90 segundos</option>
                            <option value="120">120 segundos</option>
                            <option value="180">180 segundos</option>
                        </select>
                    </div>
                    <div class="field full">
                        <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand);">
                            <input id="chkNoRepeat" type="checkbox" checked />
                            Evitar quest√µes j√° respondidas
                        </label>
                        <div class="hint">Remove quest√µes que voc√™ j√° acertou anteriormente</div>
                    </div>
                    <div class="field full">
                        <label for="searchText">Busca por texto</label>
                        <input id="searchText" type="text" placeholder="Ex.: CCP, nova√ß√£o, margem, op√ß√µes..." />
                        <div class="hint">Busca no texto da quest√£o e alternativas</div>
                    </div>
                </div>
                <div class="toast show info" id="filterInfo" style="margin-top:16px;">‚Äî</div>
            </div>
            
            <!-- PAGE 4 -->
            <div class="wiz-page" id="wizPage4" style="display:none;">
                <div class="muted" style="margin-bottom:16px;">
                    Confira as configura√ß√µes do seu simulado:
                </div>
                <div class="result-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:20px;">
                        <div>
                            <h3 style="margin:0 0 8px 0; color:var(--brand);" id="confirmTitle">Simulado Personalizado</h3>
                            <div class="muted" id="confirmDetails">‚Äî</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:32px; font-weight:950; color:var(--brand-2);" id="confirmQty">0</div>
                            <div class="muted">quest√µes</div>
                        </div>
                    </div>
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                        <div class="muted" style="margin-bottom:8px;">Configura√ß√µes aplicadas:</div>
                        <div id="confirmFilters" style="font-size:13px; font-weight:600; line-height:1.6;"></div>
                    </div>
                </div>
                <div class="toast show info" style="margin-top:16px;">
                    ‚ö° <b>Dica:</b> Durante o simulado, voc√™ pode marcar quest√µes para revisar depois clicando no √≠cone ‚≠ê.
                </div>
            </div>
        </div>
        <div class="modal-foot">
            <div class="muted" id="wizFooter">Selecione um curso para come√ßar</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnPrevStep" type="button" disabled>‚Üê Voltar</button>
                <button class="btn primary" id="btnNextStep" type="button">Continuar ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE RESULTADOS - ATUALIZADO -->
<div class="backdrop" id="resultsBackdrop" aria-hidden="true">
    <div class="modal" style="max-width:900px;" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
        <div class="modal-head">
            <h2 id="resultsTitle">Resultado do Simulado</h2>
            <button class="btn ghost small" id="btnCloseResults" type="button" aria-label="Fechar">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="resultsContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
        <div class="modal-foot">
            <div class="muted" id="resultsFooter">Tempo total: 00:00</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn ghost" id="btnReviewWrong" type="button">üìù Revisar Erros</button>
                <button class="btn ghost" id="btnExportResult" type="button">üìä Exportar</button>
                <button class="btn primary" id="btnNewSimulado" type="button">üîÑ Novo Simulado</button>
            </div>
        </div>
    </div>
</div>

<!-- TOAST GLOBAL (para Home / Hist√≥rico / Stats) -->
<div id="globalToast" style="
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 2000;
    width: min(720px, calc(100% - 24px));
    display: none;
">
    <div id="globalToastInner" class="toast show info" style="display:block; margin:0;"></div>
</div>

<script>
;(() => {
    'use strict';
    
    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => document.querySelectorAll(sel);
    
    const LS_AUTH = "sim_auth_v2";
    const LS_HIST = "sim_hist_v2";
    const LS_SESS = "sim_sess_v2";
    const LS_BOOK = "sim_book_v2";
    const LS_STATS = "sim_stats_v2";
    const LS_EXCLUDED = "sim_excluded_v1";
    
    /* =========================================================
       Configura√ß√£o Inicial
    ========================================================= */
    const courses = [
        {
            id: "PQO",
            name: "PQO - Programa de Qualifica√ß√£o Operacional",
            desc: "Preparat√≥rio completo para a certifica√ß√£o PQO com quest√µes atualizadas do mercado financeiro.",
            jsonUrl: "./QuestoesPQO.json",
            tag: "Mais Popular",
            color: "#6B66FF",
            icon: "üìà",
            stats: { questions: 0, modules: 0, avgTime: 0 }
        },
        {
            id: "CPA20",
            name: "CPA-20",
            desc: "Certifica√ß√£o Profissional ANBIMA - S√©rie 20. Prepara√ß√£o completa para o exame.",
            jsonUrl: "./QuestoesCPA20.json",
            tag: "Em Breve",
            color: "#10B981",
            icon: "üè¶",
            stats: { questions: 0, modules: 0, avgTime: 0 }
        },
        {
            id: "CEA",
            name: "CEA - Certifica√ß√£o de Especialista",
            desc: "Certifica√ß√£o para profissionais de investimentos e assessoria financeira.",
            jsonUrl: "./QuestoesCEA.json",
            tag: "Em Breve",
            color: "#F59E0B",
            icon: "‚≠ê",
            stats: { questions: 0, modules: 0, avgTime: 0 }
        }
    ];
    
    let selectedCourse = null;
    let currentUser = null;
    
    /* =========================================================
       Sistema de Autentica√ß√£o Avan√ßado
    ========================================================= */
    class AuthManager {
        static getAuth() {
            try {
                // 1) tenta localStorage
                let auth = JSON.parse(localStorage.getItem(LS_AUTH) || "null");
                if (!auth) {
                    // 2) fallback: sessionStorage (quando remember=false)
                    auth = JSON.parse(sessionStorage.getItem(LS_AUTH) || "null");
                }
                if (auth && Date.now() - auth.at < 30 * 24 * 60 * 60 * 1000) {
                    return auth;
                }
            } catch {}
            return null;
        }
        
        static setAuth(user, remember = true) {
            const auth = {
                user,
                at: Date.now(),
                session: Date.now().toString(36) + Math.random().toString(36).substr(2)
            };
            if (remember) {
                localStorage.setItem(LS_AUTH, JSON.stringify(auth));
            } else {
                sessionStorage.setItem(LS_AUTH, JSON.stringify(auth));
            }
            return auth;
        }
        
        static clearAuth() {
            localStorage.removeItem(LS_AUTH);
            sessionStorage.removeItem(LS_AUTH);
        }
        
        static requireLogin() {
            const auth = AuthManager.getAuth();
            if (auth?.user) {
                currentUser = auth.user;
                $("loginBackdrop").classList.remove("show");
                $("loginBackdrop").setAttribute("aria-hidden", "true");
                $("pillUser").textContent = auth.user;
                return true;
            }
            $("loginBackdrop").classList.add("show");
            $("loginBackdrop").setAttribute("aria-hidden", "false");
            $("pillUser").textContent = "‚Äî";
            return false;
        }
    }
    
    /* =========================================================
       Sistema de Hist√≥rico e Estat√≠sticas
    ========================================================= */
    class StatsManager {
        static getHistory() {
            try {
                return JSON.parse(localStorage.getItem(LS_HIST) || "[]");
            } catch {
                return [];
            }
        }
        
        static addSession(session) {
            const history = StatsManager.getHistory();
            history.unshift({
                id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                ...session,
                completedAt: Date.now()
            });
            // Manter apenas os √∫ltimos 50 simulados
            if (history.length > 50) history.length = 50;
            localStorage.setItem(LS_HIST, JSON.stringify(history));
            return history;
        }
        
        static getQuestionStats() {
            try {
                return JSON.parse(localStorage.getItem(LS_STATS) || "{}");
            } catch {
                return {};
            }
        }
        
        static updateQuestionStats(questionId, correct, timeSpent = 0) {
            const stats = StatsManager.getQuestionStats();
            if (!stats[questionId]) {
                stats[questionId] = {
                    attempts: 0,
                    correct: 0,
                    totalTime: 0,
                    lastAttempt: Date.now()
                };
            }
            stats[questionId].attempts++;
            stats[questionId].totalTime += timeSpent;
            stats[questionId].lastAttempt = Date.now();
            if (correct) {
                stats[questionId].correct++;
            }
            localStorage.setItem(LS_STATS, JSON.stringify(stats));
            return stats[questionId];
        }
        
        static getWeakAreas(limit = 5) {
            const stats = StatsManager.getQuestionStats();
            const areas = {};
            
            // Agrupar por tema/modulo
            Object.entries(stats).forEach(([id, data]) => {
                // Extrair tema do ID (formato: PQO-MODULO-TEMA-001)
                const parts = id.split('-');
                const area = parts.slice(0, 3).join('-');
                if (!areas[area]) {
                    areas[area] = { attempts: 0, correct: 0 };
                }
                areas[area].attempts += data.attempts;
                areas[area].correct += data.correct;
            });
            
            // Calcular taxa de acerto e retornar as piores
            return Object.entries(areas)
                .map(([area, data]) => ({
                    area,
                    accuracy: data.attempts > 0 ? (data.correct / data.attempts) * 100 : 0,
                    attempts: data.attempts
                }))
                .sort((a, b) => a.accuracy - b.accuracy)
                .slice(0, limit);
        }
        
        static getOverallStats() {
            const history = StatsManager.getHistory();
            const questionStats = StatsManager.getQuestionStats();
            
            let totalQuestions = 0;
            let correctQuestions = 0;
            let totalTime = 0;
            let totalSessions = history.length;
            
            Object.values(questionStats).forEach(stat => {
                totalQuestions += stat.attempts;
                correctQuestions += stat.correct;
                totalTime += stat.totalTime;
            });
            
            const avgAccuracy = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0;
            const avgTimePerQuestion = totalQuestions > 0 ? totalTime / totalQuestions : 0;
            
            return {
                totalSessions,
                totalQuestions,
                correctQuestions,
                avgAccuracy: Math.round(avgAccuracy * 10) / 10,
                avgTimePerQuestion: Math.round(avgTimePerQuestion / 1000),
                weakAreas: StatsManager.getWeakAreas(),
                recentPerformance: StatsManager.getRecentPerformance(7) // √∫ltimos 7 dias
            };
        }
        
        static getRecentPerformance(days = 7) {
            const history = StatsManager.getHistory();
            const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
            const recent = history.filter(s => s.completedAt > cutoff);
            
            let recentQuestions = 0;
            let recentCorrect = 0;
            let recentTime = 0;
            
            recent.forEach(session => {
                recentQuestions += session.totalQuestions || 0;
                recentCorrect += session.correctAnswers || 0;
                recentTime += session.timeSpent || 0;
            });
            
            const recentAccuracy = recentQuestions > 0 ? (recentCorrect / recentQuestions) * 100 : 0;
            const recentAvgTime = recentQuestions > 0 ? recentTime / recentQuestions / 1000 : 0;
            
            return {
                sessions: recent.length,
                questions: recentQuestions,
                accuracy: Math.round(recentAccuracy * 10) / 10,
                avgTime: Math.round(recentAvgTime),
                trend: StatsManager.getTrend(history, days)
            };
        }
        
        static getTrend(history, days) {
            if (history.length < 2) return 'stable';
            
            const recentCutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
            const olderCutoff = Date.now() - (days * 2 * 24 * 60 * 60 * 1000);
            
            const recent = history.filter(s => s.completedAt > recentCutoff);
            const older = history.filter(s => s.completedAt > olderCutoff && s.completedAt <= recentCutoff);
            
            const recentAvg = recent.reduce((acc, s) => acc + (s.accuracy || 0), 0) / (recent.length || 1);
            const olderAvg = older.reduce((acc, s) => acc + (s.accuracy || 0), 0) / (older.length || 1);
            
            if (recentAvg > olderAvg + 5) return 'up';
            if (recentAvg < olderAvg - 5) return 'down';
            return 'stable';
        }
        
        static getModulePerformance() {
            const stats = StatsManager.getQuestionStats();
            const moduleStats = {};
            
            Object.entries(stats).forEach(([id, data]) => {
                const parts = id.split('-');
                const module = parts[1] || 'Geral';
                
                if (!moduleStats[module]) {
                    moduleStats[module] = { attempts: 0, correct: 0, time: 0 };
                }
                moduleStats[module].attempts += data.attempts;
                moduleStats[module].correct += data.correct;
                moduleStats[module].time += data.totalTime;
            });
            
            return Object.entries(moduleStats)
                .map(([module, data]) => ({
                    module,
                    accuracy: data.attempts > 0 ? (data.correct / data.attempts) * 100 : 0,
                    attempts: data.attempts,
                    avgTime: data.attempts > 0 ? Math.round(data.time / data.attempts / 1000) : 0
                }))
                .sort((a, b) => a.accuracy - b.accuracy);
        }
    }
    
    /* =========================================================
       Sistema de Bookmarks
    ========================================================= */
    class BookmarkManager {
        static getBookmarks() {
            try {
                return JSON.parse(localStorage.getItem(LS_BOOK) || "[]");
            } catch {
                return [];
            }
        }
        
        static toggleBookmark(questionId) {
            const bookmarks = BookmarkManager.getBookmarks();
            const index = bookmarks.indexOf(questionId);
            if (index === -1) {
                bookmarks.push(questionId);
            } else {
                bookmarks.splice(index, 1);
            }
            localStorage.setItem(LS_BOOK, JSON.stringify(bookmarks));
            return index === -1; // Retorna true se adicionou, false se removeu
        }
        
        static isBookmarked(questionId) {
            const bookmarks = BookmarkManager.getBookmarks();
            return bookmarks.includes(questionId);
        }
    }
    
    /* =========================================================
       Sistema de Exclus√£o de Alternativas
    ========================================================= */
    class ExclusionManager {
        static getExclusions() {
            try {
                return JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
            } catch {
                return {};
            }
        }
        
        static toggleExclusion(questionId, optionLetter) {
            const exclusions = ExclusionManager.getExclusions();
            if (!exclusions[questionId]) {
                exclusions[questionId] = [];
            }
            
            const index = exclusions[questionId].indexOf(optionLetter);
            if (index === -1) {
                exclusions[questionId].push(optionLetter);
            } else {
                exclusions[questionId].splice(index, 1);
            }
            
            localStorage.setItem(LS_EXCLUDED, JSON.stringify(exclusions));
            return index === -1;
        }
        
        static getExcludedOptions(questionId) {
            const exclusions = ExclusionManager.getExclusions();
            return exclusions[questionId] || [];
        }
        
        static clearExclusions(questionId) {
            const exclusions = ExclusionManager.getExclusions();
            if (exclusions[questionId]) {
                delete exclusions[questionId];
                localStorage.setItem(LS_EXCLUDED, JSON.stringify(exclusions));
            }
        }
    }
    
    /* =========================================================
       Sistema de Sess√£o Ativa
    ========================================================= */
    class SessionManager {
        static saveSession(session) {
            localStorage.setItem(LS_SESS, JSON.stringify(session));
        }
        
        static getSession() {
            try {
                const session = JSON.parse(localStorage.getItem(LS_SESS) || "null");
                // Verificar se a sess√£o n√£o expirou (24 horas)
                if (session && Date.now() - session.startedAt < 24 * 60 * 60 * 1000) {
                    return session;
                }
            } catch {}
            return null;
        }
        
        static clearSession() {
            localStorage.removeItem(LS_SESS);
        }
    }
    
    /* =========================================================
       Gerenciamento de Banco de Quest√µes
    ========================================================= */
    const db = { all: [], modules: [], chapters: [], themes: [], levels: [] };
    
    async function loadCourseDb(course) {
        try {
            const res = await fetch(course.jsonUrl, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            const data = await res.json();
            
            if (!Array.isArray(data)) throw new Error("Formato inv√°lido: esperado array");
            
            const questions = data.map((q, index) => {
                // Valida√ß√£o completa da quest√£o
                const id = String(q.id || `Q${index + 1}`).trim();
                const questionText = String(q.q || "").trim();
                const answer = String(q.answer || "").trim().toUpperCase();
                
                if (!questionText || !answer) {
                    console.warn(`Quest√£o ${id} ignorada: texto ou resposta vazios`);
                    return null;
                }
                
                // Garantir que as op√ß√µes existam e tenham formato correto
                const options = {};
                ['A', 'B', 'C', 'D', 'E'].forEach(letter => {
                    const optionText = q.options?.[letter] || q[`option${letter}`] || "";
                    if (optionText.toString().trim()) {
                        options[letter] = optionText.toString().trim();
                    }
                });
                
                if (Object.keys(options).length === 0) {
                    console.warn(`Quest√£o ${id} ignorada: sem op√ß√µes v√°lidas`);
                    return null;
                }
                
                if (!options[answer]) {
                    console.warn(`Quest√£o ${id}: resposta "${answer}" n√£o encontrada nas op√ß√µes`);
                    return null;
                }
                
                return {
                    id,
                    module: String(q.module || "Geral").trim(),
                    chapter: String(q.chapter || "N√£o especificado").trim(),
                    theme: String(q.theme || "Geral").trim(),
                    level: String(q.level || "M√©dia").trim(),
                    q: questionText,
                    options,
                    answer,
                    explain: String(q.explain || "").trim()
                };
            }).filter(Boolean);
            
            if (questions.length === 0) {
                throw new Error("Nenhuma quest√£o v√°lida encontrada no arquivo");
            }
            
            console.log(`Carregadas ${questions.length} quest√µes de ${course.name}`);
            return questions;
        } catch (error) {
            console.error(`Erro ao carregar ${course.name}:`, error);
            throw error;
        }
    }
    
    function normalizeStr(s) {
        return String(s || "").toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^\w\s]/g, " ");
    }
    
    function buildFilters() {
        // Coletar valores √∫nicos de forma eficiente
        const unique = (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a, b) => a.localeCompare(b, "pt-BR"));
        
        db.modules = unique(db.all.map(q => q.module));
        db.chapters = unique(db.all.map(q => q.chapter));
        db.themes = unique(db.all.map(q => q.theme));
        db.levels = unique(db.all.map(q => q.level));
        
        fillSelect($("selModule"), db.modules, "Todos os m√≥dulos");
        fillSelect($("selChapter"), db.chapters, "Todos os cap√≠tulos");
        fillSelect($("selTheme"), db.themes, "Todos os temas");
        fillSelect($("selLevel"), db.levels, "Todas as dificuldades");
    }
    
    function fillSelect(select, values, placeholder) {
        select.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = placeholder;
        select.appendChild(defaultOption);
        
        values.forEach(value => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        });
    }
    
    /* =========================================================
       Dashboard e Interface
    ========================================================= */
    function showView(name) {
        // Atualizar navega√ß√£o
        $$('.nav a').forEach(a => a.classList.remove('active'));
        $(`nav${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add('active');
        
        // Mostrar view correta
        $$('.view').forEach(v => v.classList.remove('show'));
        $(`view${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add('show');
        
        // Atualizar conte√∫do espec√≠fico da view
        if (name === 'home') {
            updateDashboardStats();
        } else if (name === 'history') {
            loadHistoryView();
        } else if (name === 'stats') {
            updatePerformanceStats();
            updateAdvancedStats();
        }
    }
    
    function updateDashboardStats() {
        const stats = StatsManager.getOverallStats();
        const recent = stats.recentPerformance;
        const grid = $("statsGrid");
        
        grid.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Simulados Completos</div>
                <div class="stat-value">${stats.totalSessions}</div>
                <div class="stat-trend ${recent.trend === 'up' ? 'up' : recent.trend === 'down' ? 'down' : ''}">
                    ${recent.sessions} nos √∫ltimos 7 dias
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Taxa de Acerto</div>
                <div class="stat-value">${stats.avgAccuracy}%</div>
                <div class="stat-trend ${recent.accuracy > stats.avgAccuracy ? 'up' : recent.accuracy < stats.avgAccuracy ? 'down' : ''}">
                    ${recent.accuracy > stats.avgAccuracy ? 'üìà Em alta' : recent.accuracy < stats.avgAccuracy ? 'üìâ Em baixa' : 'üìä Est√°vel'}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Quest√µes Respondidas</div>
                <div class="stat-value">${stats.totalQuestions}</div>
                <div class="stat-trend up">
                    +${recent.questions} recentes
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tempo M√©dio</div>
                <div class="stat-value">${stats.avgTimePerQuestion}s</div>
                <div class="stat-trend ${recent.avgTime < stats.avgTimePerQuestion ? 'up' : recent.avgTime > stats.avgTimePerQuestion ? 'down' : ''}">
                    ${recent.avgTime < stats.avgTimePerQuestion ? '‚ö° Acelerando' : recent.avgTime > stats.avgTimePerQuestion ? '‚è±Ô∏è Desacelerou' : '‚è±Ô∏è Est√°vel'}
                </div>
            </div>
        `;
    }
    
    function updatePerformanceStats() {
        const stats = StatsManager.getOverallStats();
        const grid = $("performanceStats");
        
        grid.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Desempenho Geral</div>
                <div class="stat-value ${stats.avgAccuracy >= 70 ? 'good' : stats.avgAccuracy >= 50 ? 'medium' : 'bad'}">${stats.avgAccuracy}%</div>
                <div class="muted">${stats.correctQuestions}/${stats.totalQuestions} acertos</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Velocidade</div>
                <div class="stat-value ${stats.avgTimePerQuestion < 90 ? 'good' : stats.avgTimePerQuestion < 120 ? 'medium' : 'bad'}">${stats.avgTimePerQuestion}s</div>
                <div class="muted">por quest√£o</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Consist√™ncia</div>
                <div class="stat-value">${stats.totalSessions}</div>
                <div class="muted">simulados completos</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">√Åreas Cr√≠ticas</div>
                <div class="stat-value">${stats.weakAreas.length}</div>
                <div class="muted">precisam de aten√ß√£o</div>
            </div>
        `;
    }
    
    function updateAdvancedStats() {
        const stats = StatsManager.getOverallStats();
        const moduleStats = StatsManager.getModulePerformance();
        const grid = $("advancedStats");
        
        const weakAreasHTML = stats.weakAreas.slice(0, 5).map(area => `
            <div class="weak-area-item">
                <div class="weak-area-name">${area.area.split('-').slice(1).join(' - ')}</div>
                <div class="weak-area-accuracy">${area.accuracy.toFixed(1)}%</div>
            </div>
        `).join('');
        
        const moduleStatsHTML = moduleStats.slice(0, 5).map(mod => `
            <div class="weak-area-item">
                <div class="weak-area-name">${mod.module}</div>
                <div class="weak-area-accuracy ${mod.accuracy >= 70 ? 'correct' : mod.accuracy >= 50 ? 'pending' : 'incorrect'}">
                    ${mod.accuracy.toFixed(1)}%
                </div>
            </div>
        `).join('');
        
        grid.innerHTML = `
            <div class="performance-card">
                <h3>üìâ √Åreas para Melhorar</h3>
                <div class="weak-area-list">
                    ${stats.weakAreas.length > 0 ? weakAreasHTML : '<div class="muted" style="text-align:center; padding:20px;">üéâ Nenhuma √°rea cr√≠tica!</div>'}
                </div>
                ${stats.weakAreas.length > 0 ? `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${100 - stats.weakAreas[0].accuracy}%"></div>
                </div>
                ` : ''}
            </div>
            
            <div class="performance-card">
                <h3>üìä Desempenho por M√≥dulo</h3>
                <div class="weak-area-list">
                    ${moduleStats.length > 0 ? moduleStatsHTML : '<div class="muted" style="text-align:center; padding:20px;">Sem dados suficientes</div>'}
                </div>
            </div>
            
            <div class="performance-card">
                <h3>üìà Recomenda√ß√µes</h3>
                <div style="padding: 10px;">
                    ${generateRecommendations(stats)}
                </div>
            </div>
        `;
    }
    
    function generateRecommendations(stats) {
        const recommendations = [];
        
        if (stats.avgAccuracy < 50) {
            recommendations.push('üéØ <b>Foque nas √°reas b√°sicas</b> antes de avan√ßar');
        } else if (stats.avgAccuracy < 70) {
            recommendations.push('üìö <b>Revise os erros</b> para consolidar conhecimento');
        } else {
            recommendations.push('üöÄ <b>Excelente!</b> Continue mantendo a consist√™ncia');
        }
        
        if (stats.avgTimePerQuestion > 120) {
            recommendations.push('‚è±Ô∏è <b>Pratique tempo</b> para aumentar velocidade');
        }
        
        if (stats.weakAreas.length > 0) {
            recommendations.push(`üéØ <b>Foque em:</b> ${stats.weakAreas[0].area.split('-').slice(1).join(' ')}`);
        }
        
        if (stats.recentPerformance.sessions < 3) {
            recommendations.push('üìÖ <b>Pratique mais regularmente</b> para melhor reten√ß√£o');
        }
        
        return recommendations.map(rec => `<div style="margin-bottom: 10px; font-size: 13px;">${rec}</div>`).join('');
    }
    
    function renderCourses() {
        const searchTerm = ($("searchCourses").value || "").trim().toLowerCase();
        const grid = $("coursesGrid");
        
        // Temporariamente mostrar loading
        if (!grid.dataset.loaded) {
            grid.innerHTML = '<div class="loading"></div>';
        }
        
        setTimeout(() => {
            const filtered = courses.filter(course => {
                if (!searchTerm) return true;
                const searchable = `${course.name} ${course.desc} ${course.tag}`.toLowerCase();
                return searchable.includes(searchTerm);
            });
            
            $("certCount").textContent = `(${filtered.length})`;
            
            grid.innerHTML = filtered.map(course => {
                const stats = StatsManager.getOverallStats();
                const courseStats = stats.totalQuestions > 0 ? {
                    questions: stats.totalQuestions,
                    accuracy: stats.avgAccuracy
                } : { questions: 0, accuracy: 0 };
                
                return `
                <div class="course-card ${selectedCourse?.id === course.id ? 'selected' : ''}" 
                     data-course="${course.id}" 
                     style="border-left: 4px solid ${course.color}">
                    ${courseStats.questions > 0 ? `
                    <div class="progress-ring" title="${courseStats.accuracy}% de acerto">
                        ${courseStats.accuracy}%
                    </div>
                    ` : ''}
                    <div class="thumb" style="background: linear-gradient(120deg, ${course.color}22, ${course.color}44);">
                        <div class="label">${course.tag}</div>
                    </div>
                    <div class="course-body">
                        <h3 class="course-name">${course.icon} ${course.name}</h3>
                        <p class="course-desc">${course.desc}</p>
                        <div class="course-meta">
                            <span title="Quest√µes dispon√≠veis">üìö ${course.stats.questions}+ quest√µes</span>
                            <span title="M√≥dulos">üìñ ${course.stats.modules} m√≥dulos</span>
                        </div>
                        <div class="course-foot">
                            <span class="chip" style="border-color: ${course.color}44; background: ${course.color}11; color: ${course.color};">${course.id}</span>
                            <button class="btn ghost small" type="button" data-action="select">Selecionar</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            grid.dataset.loaded = true;
            
            // Adicionar event listeners
            $$('.course-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('[data-action]')) {
                        const courseId = card.dataset.course;
                        selectCourse(courses.find(c => c.id === courseId));
                    }
                });
                
                const selectBtn = card.querySelector('[data-action="select"]');
                if (selectBtn) {
                    selectBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const courseId = card.dataset.course;
                        selectCourse(courses.find(c => c.id === courseId));
                    });
                }
            });
        }, 300); // Pequeno delay para melhor UX
    }
    
    function selectCourse(course) {
        selectedCourse = course;
        
        // Atualizar UI
        $$('.course-card').forEach(c => c.classList.remove('selected'));
        $(`[data-course="${course.id}"]`)?.classList.add('selected');
        
        $("btnOpenWizard").disabled = false;
        $("btnOpenWizard").textContent = `Iniciar ${course.name}`;
        
        // Carregar quest√µes se necess√°rio
        if (db.all.length === 0 && course.id === "PQO") {
            loadQuestionsForCourse(course);
        }
        
        // Feedback visual
        showToast(`Curso ${course.name} selecionado`, 'info');
    }
    
    async function loadQuestionsForCourse(course) {
        try {
            const loadingToast = showToast(`Carregando quest√µes de ${course.name}...`, 'info', 0);
            const questions = await loadCourseDb(course);
            db.all = questions;
            course.stats.questions = questions.length;
            course.stats.modules = new Set(questions.map(q => q.module)).size;
            buildFilters();
            updateFilterInfo();
            loadingToast.remove();
            showToast(`‚úÖ ${questions.length} quest√µes carregadas de ${course.name}`, 'ok');
        } catch (error) {
            console.error("Erro ao carregar quest√µes:", error);
            showToast(`‚ùå Erro ao carregar quest√µes: ${error.message}`, 'bad');
            $("coursesGrid").innerHTML = `
                <div class="error-card" style="grid-column: 1 / -1;">
                    <div class="error-title">Erro ao Carregar Quest√µes</div>
                    <div class="muted">${error.message}</div>
                    <button class="btn" onclick="location.reload()" style="margin-top: 15px;">Tentar Novamente</button>
                </div>
            `;
        }
    }
    
    /* =========================================================
       Wizard de Configura√ß√£o
    ========================================================= */
    let wizStep = 1;
    let wizMode = "quick";
    let wizStudyMode = "module";
    
    function openWizard() {
        if (!selectedCourse) {
            showToast("Selecione um curso primeiro", "bad");
            return;
        }
        
        // Se ainda n√£o carregou as quest√µes, carregar agora
        if (db.all.length === 0) {
            loadQuestionsForCourse(selectedCourse).then(() => {
                openWizard();
            });
            return;
        }
        
        $("wizardBackdrop").classList.add("show");
        $("wizardBackdrop").setAttribute("aria-hidden", "false");
        $("wizCourseName").textContent = selectedCourse.name;
        $("wizCourseName").style.color = selectedCourse.color;
        wizStep = 1;
        wizRender();
    }
    
    function closeWizard() {
        $("wizardBackdrop").classList.remove("show");
        $("wizardBackdrop").setAttribute("aria-hidden", "true");
    }
    
    function wizRender() {
        // Atualizar steps
        for (let i = 1; i <= 4; i++) {
            $(`step${i}`).classList.toggle("active", i === wizStep);
            $(`wizPage${i}`).style.display = i === wizStep ? "" : "none";
        }
        
        // Atualizar bot√µes - IMPORTANTE: N√£o desabilitar no passo 4
        $("btnPrevStep").disabled = wizStep === 1;
        // N√£o desabilitar o bot√£o no passo 4
        $("btnNextStep").disabled = false;
        $("btnNextStep").textContent = wizStep === 4 ? "Iniciar Simulado ‚Üí" : "Continuar ‚Üí";
        
        // Atualizar footer
        const footers = [
            "Selecione o tipo de simulado",
            "Escolha sua estrat√©gia de estudo",
            "Ajuste os filtros conforme necess√°rio",
            "Revise e inicie seu simulado"
        ];
        $("wizFooter").textContent = footers[wizStep - 1];
        
        // Atualizar t√≠tulo
        $("wizSub").textContent = `Passo ${wizStep} de 4: ${footers[wizStep - 1]}`;
        
        // A√ß√µes espec√≠ficas por passo
        if (wizStep === 3) {
            updateFilterInfo();
        } else if (wizStep === 4) {
            updateConfirmText();
        }
    }
    
    function updateFilterInfo() {
        const filtered = applyWizardFilters();
        const total = db.all.length;
        const percent = total > 0 ? Math.round((filtered.base.length / total) * 100) : 0;
        $("filterInfo").innerHTML = `
            <b>${filtered.base.length} quest√µes encontradas</b> (${percent}% do total)<br>
            <span class="muted">Base total: ${total} quest√µes</span>
        `;
    }
    
    function updateConfirmText() {
        const filtered = applyWizardFilters();
        const timePerQuestion = parseInt($("selTime").value) || 0;
        const totalTime = timePerQuestion > 0 ? Math.round((filtered.base.length * timePerQuestion) / 60) : 0;
        
        $("confirmTitle").textContent = `Simulado ${selectedCourse.name}`;
        $("confirmQty").textContent = filtered.base.length;
        $("confirmDetails").innerHTML = `
            ${filtered.base.length} quest√µes ‚Ä¢ ${timePerQuestion > 0 ? `${totalTime} minutos estimados` : 'Sem limite de tempo'} ‚Ä¢ ${filtered.noRepeat ? 'Quest√µes in√©ditas' : 'Todas as quest√µes'}
        `;
        
        const filters = [];
        if (filtered.m) filters.push(`M√≥dulo: ${filtered.m}`);
        if (filtered.c) filters.push(`Cap√≠tulo: ${filtered.c}`);
        if (filtered.t) filters.push(`Tema: ${filtered.t}`);
        if (filtered.l) filters.push(`Dificuldade: ${filtered.l}`);
        if (filtered.s) filters.push(`Busca: "${filtered.s}"`);
        
        $("confirmFilters").innerHTML = filters.length > 0 
            ? filters.map(f => `‚Ä¢ ${f}`).join('<br>')
            : '<span class="muted">Nenhum filtro aplicado (todas as quest√µes)</span>';
    }
    
    function applyWizardFilters() {
        // Adicionar verifica√ß√£o no in√≠cio
        if (!db.all || db.all.length === 0) {
            console.error("Banco de quest√µes n√£o carregado!");
            return { base: [], qty: 0, noRepeat: false };
        }
        
        const m = $("selModule").value;
        const c = $("selChapter").value;
        const t = $("selTheme").value;
        const l = $("selLevel").value;
        const qty = Math.min(100, Math.max(1, parseInt($("selQty").value || "10", 10)));
        const noRepeat = $("chkNoRepeat").checked;
        const search = normalizeStr($("searchText").value);
        
        // Obter hist√≥rico de quest√µes respondidas
        const questionStats = StatsManager.getQuestionStats();
        const answeredQuestions = noRepeat 
            ? new Set(Object.keys(questionStats).filter(id => questionStats[id].correct > 0))
            : new Set();
        
        let questions = db.all.filter(q => {
            // Filtros b√°sicos
            if (m && q.module !== m) return false;
            if (c && q.chapter !== c) return false;
            if (t && q.theme !== t) return false;
            if (l && q.level !== l) return false;
            
            // Busca por texto
            if (search) {
                const searchText = normalizeStr([
                    q.id, q.module, q.chapter, q.theme, q.level, q.q,
                    ...Object.values(q.options), q.explain
                ].join(" "));
                if (!searchText.includes(search)) return false;
            }
            
            // Evitar quest√µes j√° respondidas corretamente
            if (noRepeat && answeredQuestions.has(q.id)) return false;
            
            return true;
        });
        
        // Se modo fraquezas, focar nas √°reas com pior desempenho
        if (wizStudyMode === "weakness") {
            const weakAreas = StatsManager.getWeakAreas(3);
            questions = questions.filter(q => {
                const area = `${q.module}-${q.chapter}-${q.theme}`;
                return weakAreas.some(weak => weak.area === area);
            });
        }
        
        // Embaralhar
        for (let i = questions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [questions[i], questions[j]] = [questions[j], questions[i]];
        }
        
        // Limitar pela quantidade
        questions = questions.slice(0, qty);
        
        return {
            base: questions,
            qty,
            noRepeat,
            m, c, t, l,
            s: $("searchText").value.trim()
        };
    }
    
    /* =========================================================
       Sistema de Simulado - ATUALIZADO COM EXCLUS√ÉO DE ALTERNATIVAS
    ========================================================= */
    const sim = {
        queue: [],
        idx: 0,
        answers: {},
        startedAt: null,
        timerId: null,
        selected: null,
        corrected: false,
        timePerQuestion: 0,
        questionStartTime: null,
        excludedOptions: {} // Nova propriedade para armazenar op√ß√µes exclu√≠das por quest√£o
    };
    
    function startSimulado(config) {
        sim.queue = config.base;
        sim.idx = 0;
        sim.answers = {};
        sim.excludedOptions = {};
        sim.startedAt = Date.now();
        sim.timePerQuestion = parseInt($("selTime").value) || 0;
        
        // Carregar exclus√µes salvas
        sim.queue.forEach(question => {
            sim.excludedOptions[question.id] = ExclusionManager.getExcludedOptions(question.id);
        });
        
        // Salvar sess√£o para recupera√ß√£o
        SessionManager.saveSession({
            queue: sim.queue.map(q => q.id),
            idx: sim.idx,
            answers: sim.answers,
            excludedOptions: sim.excludedOptions,
            startedAt: sim.startedAt,
            course: selectedCourse.id,
            config: config
        });
        
        closeWizard();
        startTimer();
        renderQuiz();
        showView("quiz");
    }
    
    function startTimer() {
        if (sim.timerId) clearInterval(sim.timerId);
        
        sim.timerId = setInterval(() => {
            const elapsed = Date.now() - sim.startedAt;
            $("qTimer").textContent = formatTime(elapsed);
            
            // Timer por quest√£o
            if (sim.timePerQuestion > 0 && sim.questionStartTime && !sim.corrected) {
                const questionElapsed = Date.now() - sim.questionStartTime;
                const remaining = sim.timePerQuestion * 1000 - questionElapsed;
                
                if (remaining <= 0) {
                    autoSubmitQuestion();
                } else if (remaining <= 10000) {
                    $("qTimer").style.color = "var(--bad)";
                    $("qTimer").style.fontWeight = "900";
                }
            }
        }, 100);
    }
    
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
    }
    
    function autoSubmitQuestion() {
        if (sim.corrected) return;
        
        const currentQuestion = sim.queue[sim.idx];
        if (!sim.selected) {
            // Se n√£o selecionou, marcar como errada
            sim.selected = "X";
        }
        
        correctAnswer();
        showToast("‚è∞ Tempo esgotado para esta quest√£o!", "bad");
    }
    
    function renderQuiz() {
        const total = sim.queue.length;
        const current = sim.queue[sim.idx];
        
        if (!current) {
            finishSimulado();
            return;
        }
        
        // Atualizar informa√ß√µes da quest√£o
        $("qCounter").textContent = `${sim.idx + 1}/${total}`;
        $("qCourseName").textContent = selectedCourse.name;
        $("qMeta").textContent = `${current.module} ‚Ä¢ ${current.theme}`;
        $("qId").textContent = `#${current.id}`;
        $("qDifficulty").textContent = current.level;
        $("qText").textContent = current.q;
        
        // Atualizar progresso
        const progress = ((sim.idx) / total) * 100;
        $("progressBar").style.width = `${progress}%`;
        
        // Resetar estado
        sim.selected = sim.answers[current.id]?.selected || null;
        sim.corrected = sim.answers[current.id]?.corrected || false;
        sim.questionStartTime = Date.now();
        
        // Atualizar bot√µes - REMOVIDO O BLOQUEIO DO BOT√ÉO PR√ìXIMA
        $("btnPrev").disabled = sim.idx === 0;
        $("btnNext").disabled = false; // SEMPRE ATIVO AGORA
        $("btnCorrect").disabled = sim.corrected || !sim.selected;
        $("btnFlag").classList.toggle("active", BookmarkManager.isBookmarked(current.id));
        
        // Limpar toast
        clearToast();
        
        // Renderizar op√ß√µes
        const optionsContainer = $("qOptions");
        optionsContainer.innerHTML = "";
        
        const letters = ['A', 'B', 'C', 'D', 'E'];
        const excluded = sim.excludedOptions[current.id] || [];
        
        letters.forEach(letter => {
            const optionText = current.options[letter];
            if (!optionText) return;
            
            const isExcluded = excluded.includes(letter);
            const optionDiv = document.createElement("div");
            optionDiv.className = `opt ${isExcluded ? 'excluded' : ''}`;
            
            if (sim.selected === letter) optionDiv.classList.add("selected");
            if (sim.corrected) {
                if (letter === current.answer) optionDiv.classList.add("correct");
                else if (letter === sim.selected) optionDiv.classList.add("wrong");
            }
            
            optionDiv.innerHTML = `
                <div class="radio"></div>
                <div class="txt"><span class="letter">${letter}.</span> ${optionText}</div>
                <button class="exclude-btn" data-letter="${letter}" title="${isExcluded ? 'Restaurar alternativa' : 'Excluir alternativa'}">
                    ${isExcluded ? '‚úÇÔ∏è' : '‚úÇÔ∏è'}
                </button>
            `;
            
            if (!sim.corrected && !isExcluded) {
                optionDiv.addEventListener("click", (e) => {
                    if (!e.target.closest('.exclude-btn')) {
                        selectOption(letter);
                    }
                });
            }
            
            const excludeBtn = optionDiv.querySelector('.exclude-btn');
            if (excludeBtn) {
                excludeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleExcludeOption(letter);
                });
            }
            
            optionsContainer.appendChild(optionDiv);
        });
        
        // Mostrar explica√ß√£o se j√° corrigida
        if (sim.corrected && current.explain) {
            showToast(`üìù Explica√ß√£o: ${current.explain}`, "info");
        }
        
        // Atualizar timer visual
        $("qTimer").style.color = "";
        $("qTimer").style.fontWeight = "";
    }
    
    function selectOption(letter) {
        if (sim.corrected) return;
        
        // Verificar se a op√ß√£o est√° exclu√≠da
        const currentQuestion = sim.queue[sim.idx];
        const excluded = sim.excludedOptions[currentQuestion.id] || [];
        if (excluded.includes(letter)) {
            showToast("Esta alternativa foi exclu√≠da. Restaure-a primeiro.", "bad");
            return;
        }
        
        sim.selected = letter;
        
        // Atualizar sele√ß√£o visual
        $$(".opt").forEach(opt => opt.classList.remove("selected"));
        $$(".opt").forEach(opt => {
            if (opt.querySelector(".letter").textContent.charAt(0) === letter) {
                opt.classList.add("selected");
            }
        });
        
        $("btnCorrect").disabled = false;
    }
    
    function toggleExcludeOption(letter) {
        const currentQuestion = sim.queue[sim.idx];
        const excluded = ExclusionManager.toggleExclusion(currentQuestion.id, letter);
        
        // Atualizar estado local
        if (!sim.excludedOptions[currentQuestion.id]) {
            sim.excludedOptions[currentQuestion.id] = [];
        }
        
        const index = sim.excludedOptions[currentQuestion.id].indexOf(letter);
        if (index === -1) {
            sim.excludedOptions[currentQuestion.id].push(letter);
        } else {
            sim.excludedOptions[currentQuestion.id].splice(index, 1);
        }
        
        // Se a op√ß√£o selecionada foi exclu√≠da, deselecionar
        if (sim.selected === letter && excluded) {
            sim.selected = null;
            $("btnCorrect").disabled = true;
        }
        
        // Feedback visual
        showToast(
            excluded 
                ? `‚úÇÔ∏è Alternativa ${letter} exclu√≠da` 
                : `‚úÖ Alternativa ${letter} restaurada`,
            excluded ? "info" : "ok"
        );
        
        // Re-renderizar
        renderQuiz();
    }
    
    function correctAnswer() {
        if (sim.corrected || !sim.selected) return;
        
        const current = sim.queue[sim.idx];
        const isCorrect = sim.selected === current.answer;
        const timeSpent = Date.now() - sim.questionStartTime;
        
        // Salvar resposta
        sim.answers[current.id] = {
            selected: sim.selected,
            correct: isCorrect,
            corrected: true,
            timeSpent
        };
        sim.corrected = true;
        
        // Atualizar estat√≠sticas
        StatsManager.updateQuestionStats(current.id, isCorrect, timeSpent);
        
        // Atualizar bot√µes
        $("btnCorrect").disabled = true;
        // REMOVIDO: $("btnNext").disabled = false; // J√° est√° sempre ativo
        
        // Mostrar resultado
        if (isCorrect) {
            showToast("‚úÖ Correto!", "ok");
        } else {
            showToast(`‚ùå Resposta correta: ${current.answer}`, "bad");
            if (current.explain) {
                setTimeout(() => {
                    showToast(`üìù ${current.explain}`, "info");
                }, 500);
            }
        }
        
        // Atualizar visual das op√ß√µes
        renderQuiz(); // Re-render para mostrar cores corretas
        
        // Salvar sess√£o atualizada
        SessionManager.saveSession({
            queue: sim.queue.map(q => q.id),
            idx: sim.idx,
            answers: sim.answers,
            excludedOptions: sim.excludedOptions,
            startedAt: sim.startedAt,
            course: selectedCourse.id
        });
    }
    
    function nextQuestion() {
        // SEMPRE PERMITIR AVAN√áAR, MESMO SEM CORRIGIR
        // Se n√£o corrigiu, marcar como n√£o respondida
        if (!sim.corrected && sim.idx < sim.queue.length - 1) {
            const current = sim.queue[sim.idx];
            if (!sim.answers[current.id]) {
                sim.answers[current.id] = {
                    selected: null,
                    correct: false,
                    corrected: false,
                    timeSpent: Date.now() - sim.questionStartTime
                };
            }
            // N√£o atualiza estat√≠sticas se n√£o foi corrigido
        }
        
        sim.idx++;
        if (sim.idx >= sim.queue.length) {
            finishSimulado();
        } else {
            renderQuiz();
        }
    }
    
    function prevQuestion() {
        if (sim.idx === 0) return;
        sim.idx--;
        renderQuiz();
    }
    
    function toggleBookmark() {
        const current = sim.queue[sim.idx];
        const added = BookmarkManager.toggleBookmark(current.id);
        $("btnFlag").classList.toggle("active", added);
        showToast(
            added ? "‚≠ê Quest√£o marcada para revis√£o" : "üìù Marca√ß√£o removida",
            "info"
        );
    }
    
    function finishSimulado() {
        stopTimer();
        
        // Corrigir automaticamente quest√µes n√£o corrigidas
        const uncorrected = sim.queue.filter(q => !sim.answers[q.id]?.corrected);
        uncorrected.forEach(question => {
            if (!sim.answers[question.id]) {
                sim.answers[question.id] = {
                    selected: null,
                    correct: false,
                    corrected: true,
                    timeSpent: 0
                };
            } else {
                sim.answers[question.id].corrected = true;
            }
        });
        
        // Calcular estat√≠sticas
        const total = sim.queue.length;
        const correct = Object.values(sim.answers).filter(a => a.correct).length;
        const accuracy = total > 0 ? (correct / total) * 100 : 0;
        const totalTime = Date.now() - sim.startedAt;
        
        // Salvar sess√£o no hist√≥rico
        StatsManager.addSession({
            course: selectedCourse.id,
            totalQuestions: total,
            correctAnswers: correct,
            accuracy: Math.round(accuracy * 10) / 10,
            timeSpent: totalTime,
            date: new Date().toISOString(),
            answers: sim.answers,
            autoCorrected: uncorrected.length
        });
        
        // Limpar sess√£o atual
        SessionManager.clearSession();
        
        // Mostrar resultados
        showResults({
            total,
            correct,
            accuracy,
            totalTime,
            answers: sim.answers,
            questions: sim.queue,
            autoCorrected: uncorrected.length
        });
    }
    
    function showResults(results) {
        const content = $("resultsContent");
        const timePerQuestion = Math.round(results.totalTime / results.total / 1000);
        const stats = StatsManager.getOverallStats();
        
        // Calcular tend√™ncia
        const lastSession = StatsManager.getHistory()[1]; // Pen√∫ltima sess√£o
        const lastAccuracy = lastSession?.accuracy || 0;
        const trend = results.accuracy > lastAccuracy ? 'up' : results.accuracy < lastAccuracy ? 'down' : 'stable';
        
        content.innerHTML = `
            <div class="result-card">
                <h2 class="result-title" style="color: ${selectedCourse.color};">Simulado Conclu√≠do!</h2>
                <div class="muted">${selectedCourse.name} ‚Ä¢ ${new Date().toLocaleDateString('pt-BR')}</div>
                
                <div class="result-stats">
                    <div class="result-stat">
                        <div class="result-label">Desempenho</div>
                        <div class="result-value ${results.accuracy >= 70 ? 'good' : results.accuracy >= 50 ? 'medium' : 'bad'}">
                            ${Math.round(results.accuracy)}%
                        </div>
                        <div class="result-trend ${trend}">
                            ${trend === 'up' ? 'üìà Melhorou' : trend === 'down' ? 'üìâ Piorou' : 'üìä Est√°vel'} vs. anterior
                        </div>
                    </div>
                    
                    <div class="result-stat">
                        <div class="result-label">Acertos</div>
                        <div class="result-value">${results.correct}/${results.total}</div>
                        <div class="muted">${results.autoCorrected > 0 ? `(${results.autoCorrected} n√£o respondidas)` : 'Todas respondidas'}</div>
                    </div>
                    
                    <div class="result-stat">
                        <div class="result-label">Tempo Total</div>
                        <div class="result-value">${formatTime(results.totalTime)}</div>
                        <div class="muted">${timePerQuestion}s por quest√£o</div>
                    </div>
                    
                    <div class="result-stat">
                        <div class="result-label">Velocidade</div>
                        <div class="result-value ${timePerQuestion < 90 ? 'good' : timePerQuestion < 120 ? 'medium' : 'bad'}">
                            ${timePerQuestion < 90 ? 'R√°pido' : timePerQuestion < 120 ? 'Normal' : 'Devagar'}
                        </div>
                        <div class="muted">M√©dia geral: ${stats.avgTimePerQuestion}s</div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="margin: 0 0 12px 0; color: var(--brand);">An√°lise de Desempenho</h4>
                    <div class="muted" style="font-size: 13px;">
                        ${generatePerformanceAnalysis(results)}
                    </div>
                </div>
                
                ${results.total - results.correct > 0 ? `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="margin: 0 0 12px 0; color: var(--brand);">Quest√µes Erradas (${results.total - results.correct})</h4>
                    <div class="muted" style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                        ${Object.entries(results.answers)
                            .filter(([_, a]) => !a.correct)
                            .map(([id, answer]) => {
                                const question = results.questions.find(q => q.id === id);
                                return question ? `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--bad-light); border-radius: 8px; border-left: 3px solid var(--bad);">
                                    <div style="font-weight: 900; color: var(--bad);">${question.id} - ${question.theme}</div>
                                    <div style="margin: 4px 0; font-weight: 700;">${question.q.substring(0, 100)}...</div>
                                    <div style="font-size: 11px;">
                                        <span style="color: var(--bad);">${answer.selected ? `Sua resposta: ${answer.selected}` : 'N√£o respondida'}</span> | 
                                        <span style="color: var(--ok);">Correta: ${question.answer}</span>
                                    </div>
                                </div>
                                ` : '';
                            })
                            .join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        $("resultsFooter").textContent = `Tempo total: ${formatTime(results.totalTime)} ‚Ä¢ ${results.autoCorrected > 0 ? `${results.autoCorrected} n√£o respondidas` : 'Todas respondidas'}`;
        $("resultsBackdrop").classList.add("show");
        $("resultsBackdrop").setAttribute("aria-hidden", "false");
    }
    
    function generatePerformanceAnalysis(results) {
        const analysis = [];
        const stats = StatsManager.getOverallStats();
        
        if (results.accuracy >= 80) {
            analysis.push('üéâ <b>Excelente desempenho!</b> Continue assim.');
        } else if (results.accuracy >= 60) {
            analysis.push('üëç <b>Bom desempenho.</b> Foque nos erros para melhorar.');
        } else {
            analysis.push('üìö <b>Precisa melhorar.</b> Revise os conte√∫dos b√°sicos.');
        }
        
        const timePerQuestion = Math.round(results.totalTime / results.total / 1000);
        if (timePerQuestion < 60) {
            analysis.push('‚ö° <b>Muito r√°pido!</b> Mantenha a velocidade com acur√°cia.');
        } else if (timePerQuestion > 120) {
            analysis.push('‚è±Ô∏è <b>Muito lento.</b> Pratique para ganhar agilidade.');
        }
        
        if (results.accuracy > stats.avgAccuracy) {
            analysis.push(`üìà <b>Acima da m√©dia</b> (${stats.avgAccuracy}%). Continue evoluindo!`);
        } else if (results.accuracy < stats.avgAccuracy) {
            analysis.push(`üìâ <b>Abaixo da m√©dia</b> (${stats.avgAccuracy}%). Revise mais.`);
        }
        
        if (results.autoCorrected > 0) {
            analysis.push(`‚ö†Ô∏è <b>${results.autoCorrected} quest√µes n√£o respondidas.</b> Tente responder todas na pr√≥xima.`);
        }
        
        return analysis.map(item => `<div style="margin-bottom: 8px;">${item}</div>`).join('');
    }
    
    function stopTimer() {
        if (sim.timerId) {
            clearInterval(sim.timerId);
            sim.timerId = null;
        }
    }
    
    /* =========================================================
       Sistema de Hist√≥rico
    ========================================================= */
    function loadHistoryView() {
        const container = $("historyContent");
        const history = StatsManager.getHistory();
        const bookmarks = BookmarkManager.getBookmarks();
        const questionStats = StatsManager.getQuestionStats();
        const wrongQuestions = Object.entries(questionStats)
            .filter(([_, stats]) => stats.attempts > 0 && (stats.correct / stats.attempts) < 0.5)
            .map(([id]) => id);
        
        const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'history';
        
        if (activeTab === 'history') {
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="result-card" style="text-align: center;">
                        <h3 style="color: var(--brand); margin: 0 0 10px 0;">Nenhum simulado encontrado</h3>
                        <div class="muted">Comece fazendo seu primeiro simulado!</div>
                        <button class="btn primary" onclick="showView('home')" style="margin-top: 15px;">Iniciar Simulado</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Curso</th>
                            <th>Quest√µes</th>
                            <th>Acertos</th>
                            <th>Tempo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(session => `
                            <tr>
                                <td>${new Date(session.completedAt).toLocaleDateString('pt-BR')}</td>
                                <td><strong>${session.course}</strong></td>
                                <td>${session.totalQuestions}</td>
                                <td>
                                    <span class="badge ${session.accuracy >= 70 ? 'correct' : session.accuracy >= 50 ? 'pending' : 'incorrect'}">
                                        ${session.accuracy}%
                                    </span>
                                </td>
                                <td>${formatTime(session.timeSpent)}</td>
                                <td>
                                    <button class="btn ghost small" onclick="reviewSession('${session.id}')">Revisar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else if (activeTab === 'bookmarks') {
            if (bookmarks.length === 0) {
                container.innerHTML = `
                    <div class="result-card" style="text-align: center;">
                        <h3 style="color: var(--brand); margin: 0 0 10px 0;">Nenhuma quest√£o marcada</h3>
                        <div class="muted">Marque quest√µes durante os simulados clicando no √≠cone ‚≠ê</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="result-card">
                    <h3 style="color: var(--brand); margin: 0 0 15px 0;">${bookmarks.length} Quest√µes Marcadas</h3>
                    <div class="muted">Estas s√£o as quest√µes que voc√™ marcou para revis√£o.</div>
                    <button class="btn primary" onclick="createBookmarkSession()" style="margin-top: 15px;">
                        Criar Simulado com Quest√µes Marcadas
                    </button>
                </div>
            `;
        } else if (activeTab === 'wrong') {
            if (wrongQuestions.length === 0) {
                container.innerHTML = `
                    <div class="result-card" style="text-align: center;">
                        <h3 style="color: var(--brand); margin: 0 0 10px 0;">Nenhuma quest√£o para revisar</h3>
                        <div class="muted">Excelente! Voc√™ n√£o tem quest√µes com baixo desempenho.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="result-card">
                    <h3 style="color: var(--brand); margin: 0 0 15px 0;">${wrongQuestions.length} Quest√µes para Revisar</h3>
                    <div class="muted">Foque nestas quest√µes para melhorar seu desempenho.</div>
                    <button class="btn primary" onclick="createReviewSession()" style="margin-top: 15px;">
                        Criar Simulado de Revis√£o
                    </button>
                </div>
            `;
        }
    }
    
    /* =========================================================
       Utilit√°rios
    ========================================================= */
    function showToast(message, type = "info", duration = 3000) {
        // 1) se estiver no quiz e existir qToast, usa ele
        const quizToast = $("qToast");
        if (quizToast) {
            quizToast.className = `toast show ${type}`;
            quizToast.textContent = message;
            if (duration > 0) {
                setTimeout(() => quizToast.classList.remove("show"), duration);
            }
            return quizToast;
        }
        
        // 2) fallback: toast global (Home / Hist√≥rico / Stats)
        const wrap = $("globalToast");
        const inner = $("globalToastInner");
        if (!wrap || !inner) return null;
        
        inner.className = `toast show ${type}`;
        inner.textContent = message;
        wrap.style.display = "block";
        
        if (duration > 0) {
            setTimeout(() => {
                wrap.style.display = "none";
                inner.textContent = "";
            }, duration);
        }
        return inner;
    }
    
    function clearToast() {
        const quizToast = $("qToast");
        if (quizToast) {
            quizToast.classList.remove("show");
            quizToast.textContent = "";
        }
        
        const wrap = $("globalToast");
        const inner = $("globalToastInner");
        if (wrap && inner) {
            wrap.style.display = "none";
            inner.textContent = "";
        }
    }
    
    function exportData(format) {
        const history = StatsManager.getHistory();
        const stats = StatsManager.getQuestionStats();
        let data, filename, mimeType;
        
        if (format === 'csv') {
            // Cabe√ßalho CSV
            let csv = "ID,M√≥dulo,Cap√≠tulo,Tema,Dificuldade,Tentativas,Acertos,Taxa de Acerto,Tempo M√©dio,√öltima Tentativa\n";
            
            Object.entries(stats).forEach(([id, stat]) => {
                const question = db.all.find(q => q.id === id);
                const accuracy = stat.attempts > 0 ? (stat.correct / stat.attempts * 100).toFixed(1) : "0";
                const avgTime = stat.attempts > 0 ? Math.round(stat.totalTime / stat.attempts / 1000) : "0";
                
                csv += `"${id}","${question?.module || 'N/A'}","${question?.chapter || 'N/A'}","${question?.theme || 'N/A'}","${question?.level || 'N/A'}",${stat.attempts},${stat.correct},${accuracy}%,${avgTime}s,"${new Date(stat.lastAttempt).toLocaleDateString('pt-BR')}"\n`;
            });
            
            data = csv;
            filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.csv`;
            mimeType = 'text/csv;charset=utf-8;';
        } else {
            data = JSON.stringify({
                history,
                stats,
                exportedAt: new Date().toISOString(),
                user: currentUser
            }, null, 2);
            filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
        }
        
        // Criar blob e fazer download
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast(`‚úÖ Dados exportados como ${filename}`, 'ok');
    }
    
    /* =========================================================
       Event Listeners
    ========================================================= */
    
    // Login
    $("btnLogin").addEventListener("click", () => {
        const user = ($("loginUser").value || "").trim();
        const pass = ($("loginPass").value || "").trim();
        const remember = $("rememberMe").checked;
        
        if (!user || !pass) {
            showToast("Preencha usu√°rio e senha", "bad");
            return;
        }
        
        AuthManager.setAuth(user, remember);
        AuthManager.requireLogin();
        updateDashboardStats();
        renderCourses();
        showToast(`‚úÖ Bem-vindo, ${user}!`, "ok");
    });
    
    $("btnLogout").addEventListener("click", () => {
        AuthManager.clearAuth();
        selectedCourse = null;
        $("btnOpenWizard").disabled = true;
        showView("home");
        AuthManager.requireLogin();
        showToast("‚úÖ Logout realizado", "ok");
    });
    
    // Navega√ß√£o
    $$('.nav a').forEach(a => {
        a.addEventListener('click', (e) => {
            e.preventDefault();
            const view = a.id.replace('nav', '').toLowerCase();
            showView(view);
        });
    });
    
    // Tabs do hist√≥rico
    $$('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            $$('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadHistoryView();
        });
    });
    
    // Busca de cursos
    let searchTimeout;
    $("searchCourses").addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            renderCourses();
        }, 300);
    });
    
    // Wizard
    $("btnOpenWizard").addEventListener("click", openWizard);
    $("btnCloseWizard").addEventListener("click", closeWizard);
    $("wizardBackdrop").addEventListener("click", (e) => {
        if (e.target === $("wizardBackdrop")) closeWizard();
    });
    
    $("btnPrevStep").addEventListener("click", () => {
        wizStep = Math.max(1, wizStep - 1);
        wizRender();
    });
    
    $("btnNextStep").addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (wizStep === 4) {
            const config = applyWizardFilters();
            if (!config.base || config.base.length === 0) {
                showToast("Nenhuma quest√£o encontrada com esses filtros", "bad");
                wizStep = 3;
                wizRender();
                return;
            }
            startSimulado(config);
        } else {
            wizStep = Math.min(4, wizStep + 1);
            wizRender();
        }
    });
    
    // Modos do wizard
    $$('.mode[data-mode]').forEach(mode => {
        mode.addEventListener('click', () => {
            $$('.mode[data-mode]').forEach(m => m.classList.remove('selected'));
            mode.classList.add('selected');
            wizMode = mode.dataset.mode;
            
            // Se for modo r√°pido, configurar automaticamente
            if (wizMode === 'quick') {
                $("selQty").value = "10";
                $("selTime").value = "90";
                updateFilterInfo();
                updateConfirmText();
            }
            
            // Se for modo prova, configurar 60 quest√µes
            if (wizMode === 'exam') {
                $("selQty").value = "60";
                $("selTime").value = "120";
                updateFilterInfo();
                updateConfirmText();
            }
        });
    });
    
    $$('.mode[data-study]').forEach(mode => {
        mode.addEventListener('click', () => {
            $$('.mode[data-study]').forEach(m => m.classList.remove('selected'));
            mode.classList.add('selected');
            wizStudyMode = mode.dataset.study;
        });
    });
    
    // Atualizar filtros em tempo real
    ['selModule', 'selChapter', 'selTheme', 'selLevel', 'selQty', 'selTime', 'chkNoRepeat'].forEach(id => {
        $(id).addEventListener('change', () => {
            updateFilterInfo();
            updateConfirmText();
        });
    });
    
    // Debounce para busca de texto
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    $("searchText").addEventListener('input', debounce(() => {
        updateFilterInfo();
        updateConfirmText();
    }, 300));
    
    // Quiz
    $("btnCorrect").addEventListener("click", correctAnswer);
    $("btnNext").addEventListener("click", nextQuestion);
    $("btnPrev").addEventListener("click", prevQuestion);
    $("btnFlag").addEventListener("click", toggleBookmark);
    $("btnFinish").addEventListener("click", finishSimulado);
    
    // Resultados
    $("btnCloseResults").addEventListener("click", () => {
        $("resultsBackdrop").classList.remove("show");
        $("resultsBackdrop").setAttribute("aria-hidden", "true");
        showView("home");
    });
    
    $("btnNewSimulado").addEventListener("click", () => {
        $("resultsBackdrop").classList.remove("show");
        $("resultsBackdrop").setAttribute("aria-hidden", "true");
        openWizard();
    });
    
    // Exporta√ß√£o
    $("btnExportCSV").addEventListener("click", () => exportData('csv'));
    $("btnExportJSON").addEventListener("click", () => exportData('json'));
    
    /* =========================================================
       Inicializa√ß√£o
    ========================================================= */
    async function init() {
        // Verificar login
        AuthManager.requireLogin();
        
        // Carregar curso PQO por padr√£o
        selectedCourse = courses[0];
        try {
            await loadQuestionsForCourse(selectedCourse);
        } catch (error) {
            console.error("Erro na inicializa√ß√£o:", error);
        }
        
        // Verificar se h√° sess√£o para recuperar
        const savedSession = SessionManager.getSession();
        if (savedSession && confirm("H√° um simulado em andamento. Deseja continuar?")) {
            // Aqui voc√™ implementaria a recupera√ß√£o da sess√£o
            showToast("Sess√£o recuperada", "info");
        }
        
        // Renderizar interface inicial
        renderCourses();
        updateDashboardStats();
        
        // Mostrar dica inicial
        setTimeout(() => {
            if (db.all.length > 0) {
                showToast(`‚úÖ ${db.all.length} quest√µes carregadas. Selecione um curso e inicie seu simulado!`, "ok", 5000);
            }
        }, 1000);
    }
    
    // Iniciar aplica√ß√£o
    init();
    
    // Exportar fun√ß√µes para escopo global (para uso nos onclick)
    window.showView = showView;
    window.reviewSession = function(id) {
        showToast(`Revisando sess√£o ${id}...`, "info");
        // Implementar revis√£o de sess√£o
    };
    
    window.createReviewSession = function() {
        showToast("Criando simulado de revis√£o...", "info");
        // Implementar cria√ß√£o de simulado de revis√£o
    };
    
    window.createBookmarkSession = function() {
        showToast("Criando simulado com quest√µes marcadas...", "info");
        // Implementar cria√ß√£o de simulado com bookmarks
    };
    
})();
</script>
</body>
</html>
